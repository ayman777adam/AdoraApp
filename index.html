<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªÙ‚Ø±ÙŠØ± Ø¥Ø´ØºØ§Ù„ ÙÙ†Ø¯Ù‚ Ø£Ø¨ÙŠÙ„Ø§</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- 1. Tanafos Theme Variables --- */
        :root {
            --bg-body: #f4f6f8;
            --bg-card: #ffffff;
            --text-main: #37474f;
            --text-sec: #78909c;
            --border-color: #cfd8dc;
            
            --primary: #0097a7;       /* Teal */
            --primary-light: #e0f7fa;
            
            --success: #00b894;
            --danger: #d63031;
            --warning: #f1c40f;
            --upgrade: #7e57c2;       /* Purple for Upgrade */
            
            /* Room Colors (Theme Adapted) */
            --color-single: #26c6da;  /* Cyan */
            --color-suite: #ffca28;   /* Amber */
            
            --shadow: 0 4px 20px rgba(0, 151, 167, 0.08);
        }

        body.dark-mode {
            --bg-body: #1e1e1e;
            --bg-card: #2d2d2d;
            --text-main: #dfe6e9;
            --text-sec: #b2bec3;
            --border-color: #444;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-body);
            background-image: radial-gradient(#b0bec5 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text-main);
            margin: 0;
            padding: 15px 15px 220px 15px;
            -webkit-tap-highlight-color: transparent;
            transition: 0.3s;
            overflow-x: hidden;
        }

        body.dark-mode { background-image: none; }
        
        body.zen-active .dashboard, 
        body.zen-active .header-glass, 
        body.zen-active .price-bar, 
        body.zen-active .sticky-footer {
            opacity: 0.1; filter: blur(2px); transition: 0.3s;
        }

        .container { max-width: 500px; margin: 0 auto; }

        /* --- Header Glass --- */
        .header-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid #fff;
            border-radius: 20px; 
            padding: 15px; 
            margin-bottom: 20px;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: var(--shadow);
            
            /* ğŸ”¥ Ø¥Ø¶Ø§ÙØ© flex-wrap Ù„Ù…Ù†Ø¹ ØªÙƒØ³Ø± Ø§Ù„ØªØµÙ…ÙŠÙ… ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ */
            flex-wrap: nowrap; 
        }
        body.dark-mode .header-glass { background: rgba(45,45,45,0.7); border-color:rgba(255,255,255,0.1); }
        .header-title h1 { margin: 0; font-size: 1.1rem; color: var(--primary); font-weight: 800; }
        
        /* ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ: Ø¥Ø²Ø§Ø­Ø© Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ù„Ù„ÙŠØ³Ø§Ø± Ù„ØªØ±Ùƒ Ù…ÙƒØ§Ù† Ù„Ù„Ø²Ø± Ø§Ù„Ø£Ø®Ø¶Ø± */
        .tools-area { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            /* Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§ÙØ© ØªØ¶Ù…Ù† Ø¹Ø¯Ù… ØªØºØ·ÙŠØ© Ø§Ù„Ø²Ø± Ø§Ù„Ø£Ø®Ø¶Ø± Ù„Ù„Ø£Ø¯ÙˆØ§Øª */
            margin-left: 130px; 
        }
        
        /* ØªØ­Ø³ÙŠÙ† Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹ */
        @media (max-width: 380px) {
            .header-title h1 { font-size: 0.9rem; }
            .tools-area { margin-left: 110px; }
        }

        .tools-btn { background: var(--bg-body); border: 1px solid var(--border-color); padding: 8px; border-radius: 10px; cursor: pointer; font-size: 1.1rem; color: var(--text-main); }

        .season-toggle {
            display: flex; align-items: center; gap: 5px;
            background: var(--bg-body); border: 1px solid var(--border-color);
            padding: 5px 10px; border-radius: 20px; cursor: pointer;
            font-size: 0.8rem; font-weight: bold; transition: 0.3s; color: var(--text-sec);
        }
        .season-toggle.active { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }
        .season-dot { width: 10px; height: 10px; border-radius: 50%; background: #cfd8dc; transition:0.3s;}
        .season-toggle.active .season-dot { background: var(--primary); box-shadow: 0 0 5px var(--primary); }

        /* --- Dashboard --- */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .card { 
            background: var(--bg-card); border-radius: 18px; padding: 15px; 
            position: relative; box-shadow: var(--shadow); border: 1px solid var(--border-color);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-bottom: 3px solid transparent; transition: transform 0.2s;
        }
        .chart-container { position: relative; width: 70px; height: 70px; margin-bottom: 5px; }
        .circular-chart { display: block; margin: 0 auto; max-width: 80%; max-height: 250px; }
        .circle-bg { fill: none; stroke: var(--primary-light); stroke-width: 3.8; }
        .circle { fill: none; stroke-width: 2.8; stroke-linecap: round; transition: stroke-dasharray 0.6s ease; }
        .percentage { fill: var(--text-main); font-family: 'Tajawal'; font-weight: bold; font-size: 0.5em; text-anchor: middle; }
        
        .card-label { font-size: 0.85rem; font-weight: 700; }
        .card-sub { font-size: 0.7rem; opacity: 0.7; }
        
        .c-single .circle { stroke: var(--color-single); } .c-single .card-label { color: var(--color-single); }
        .c-suite .circle { stroke: var(--color-suite); } .c-suite .card-label { color: var(--color-suite); }

        /* --- Price Bar --- */
        .price-bar {
            background: var(--bg-card); border-radius: 15px; padding: 10px 15px;
            margin-bottom: 25px; box-shadow: var(--shadow); border: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            border-left: 5px solid #ccc; transition: 0.3s;
        }
        .price-label { font-size: 0.8rem; color: var(--text-sec); font-weight: 600; }
        .price-values { display: flex; gap: 15px; font-weight: 800; font-size: 1rem; }
        .p-val span { font-size: 0.7rem; font-weight: normal; opacity: 0.7; margin-left: 3px; }
        
        .price-mode-std { border-left-color: var(--success); background: #e8f5e9; }
        .price-mode-med { border-left-color: var(--warning); background: #fffde7; }
        .price-mode-high { border-left-color: var(--danger); background: #ffebee; }

        /* --- Steppers --- */
        .section { background: var(--bg-card); border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .sec-title { font-weight: 700; font-size: 1rem; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px dashed var(--border-color); color: var(--primary); }
        .control-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .control-label { flex: 1; font-size: 0.9rem; font-weight: 600; color: var(--text-main); }
        
        .stepper { display: flex; align-items: center; gap: 10px; background: var(--bg-body); padding: 5px; border-radius: 12px; border: 1px solid var(--border-color); }
        .step-btn {
            width: 45px; height: 45px; border: none; border-radius: 12px;
            background: #fff; cursor: pointer; font-weight: bold; font-size: 1.4rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); color: var(--text-main);
        }
        .step-btn:active { transform: scale(0.9); }
        .btn-minus { color: var(--danger); } .btn-plus { color: var(--success); }
        body.dark-mode .step-btn { background: #444; }
        
        .val-display { font-size: 1.4rem; font-weight: 800; width: 35px; text-align: center; color: var(--primary); }
        .pop-anim { animation: pop 0.2s ease; color: var(--upgrade); }
        @keyframes pop { 50% { transform: scale(1.4); } }

        .cap-bar-bg { height: 4px; background: var(--border-color); border-radius: 2px; margin-top: 5px; width: 100%; position: relative; overflow: hidden; }
        .cap-bar-fill { height: 100%; width: 0%; background: var(--success); transition: width 0.3s, background 0.3s; }
        .lbl-single { color: var(--color-single); } .lbl-suite { color: var(--color-suite); }

        /* --- Footer & Sticky --- */
        .sticky-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid var(--border-color);
            padding: 15px 15px 5px 15px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            z-index: 999;
            display: flex; flex-direction: column; gap: 8px;
            box-sizing: border-box; border-radius: 20px 20px 0 0;
        }
        body.dark-mode .sticky-footer { background: rgba(35,35,35,0.98); border-color: #555; }

        .advice-container { display: flex; gap: 10px; }
        .advice-pill {
            flex: 1; padding: 10px; border-radius: 12px; text-align: center;
            font-weight: 800; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .pill-green { background: #e0f2f1; color: #00695c; border: 1px solid #80cbc4; }
        .pill-red { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }

        .actions-row { display: flex; gap: 10px; }
        #submit-btn {
            flex: 1; padding: 14px; border: none; border-radius: 12px;
            background: var(--primary);
            color: white; font-weight: 800; font-size: 1.1rem;
            cursor: pointer; box-shadow: 0 4px 15px rgba(0, 151, 167, 0.3);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        #copy-btn { width: 50px; border: none; border-radius: 12px; background: var(--bg-body); color: var(--text-sec); font-size: 1.2rem; cursor: pointer; border: 1px solid var(--border-color); }

        .footer-credits {
            text-align: center; font-size: 0.75rem; color: #90a4ae;
            padding-top: 5px; padding-bottom: 5px;
            border-top: 1px dashed rgba(0,0,0,0.05); margin-top: 5px;
        }
        .footer-credits b { color: var(--text-sec); }

        #game-toast {
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
            background: #37474f; color: #fff; padding: 8px 15px; border-radius: 20px;
            font-size: 0.8rem; font-weight: bold; opacity: 0; pointer-events: none;
            transition: 0.3s; z-index: 2000; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex; align-items: center; gap: 5px;
        }
        #game-toast.show { opacity: 1; top: 90px; }

        .alert-upgrade { background: #ede7f6; color: #5e35b1; padding: 10px; border-radius: 10px; border: 1px solid #d1c4e9; text-align: center; font-size: 0.9rem; margin-bottom: 15px; display: none; }
        
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: var(--bg-card); padding: 25px; border-radius: 20px; width: 85%; max-width: 350px; text-align: center; }
        .math-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        
        /* ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„Ø­ÙØ¸ */
        #sync-indicator { display: none !important; }
        
        #password-modal input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; text-align: center; }

        /* ğŸ”¥ CSS Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙ‚Ø· */
        @media print {
            .tools-area, .sticky-footer, .season-toggle, #game-toast, #upgrade-alert, #sync-indicator { 
                display: none !important; 
            }
            body { 
                padding: 0; 
                background: white; 
                color: black;
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
            }
            .container { max-width: 100%; margin: 0; }
            .card, .section, .price-bar { 
                box-shadow: none; 
                border: 1px solid #ccc; 
                break-inside: avoid; /* Ù…Ù†Ø¹ Ù‚Øµ Ø§Ù„Ø¹Ù†Ø§ØµØ± */
            }
            .header-glass { box-shadow: none; border-bottom: 1px solid #000; border-radius: 0; }
            /* Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø®Ù„ÙÙŠØ§Øª Ø§Ù„ÙØ§ØªØ­Ø© ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
            .price-mode-std, .price-mode-med, .price-mode-high { -webkit-print-color-adjust: exact; }
        }

    </style>
</head>
<body>

    <div class="container">
        <div class="header-glass">
            <div class="header-title">
                <h1>ØªÙ‚Ø±ÙŠØ± Ø¥Ø´ØºØ§Ù„ ÙÙ†Ø¯Ù‚ Ø£Ø¨ÙŠÙ„Ø§</h1>
            </div>
            <div class="tools-area">
                <div class="season-toggle" id="season-btn" onclick="toggleSeason()">
                    <div class="season-dot"></div> Ù…ÙˆØ³Ù…
                </div>
                <button class="tools-btn" onclick="toggleDarkMode()">ğŸŒ™</button>
                <button class="tools-btn" onclick="showResetModal()">ğŸ”„</button>
            </div>
        </div>
        
        <div id="game-toast">ğŸš€ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙˆØ±Ø¯ÙŠØ©: <span id="sales-count">0</span></div>
        <div id="sync-indicator">ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...</div>

        <div class="dashboard">
            <div class="card c-single" id="card-single" onclick="showExplain('single')">
                <div class="chart-container">
                    <svg viewBox="0 0 36 36" class="circular-chart">
                        <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        <path class="circle" id="circle-s" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        <text x="18" y="20.35" class="percentage" id="txt-s">0</text>
                    </svg>
                </div>
                <div class="card-label">Ù…ÙØ±Ø¯ Ù…ØªØ§Ø­</div>
                <div class="card-sub">Ø³Ø¹Ø©: 4</div>
            </div>

            <div class="card c-suite" id="card-suite" onclick="showExplain('suite')">
                <div class="chart-container">
                    <svg viewBox="0 0 36 36" class="circular-chart">
                        <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        <path class="circle" id="circle-r" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        <text x="18" y="20.35" class="percentage" id="txt-r">0</text>
                    </svg>
                </div>
                <div class="card-label">ÙˆØµØ§Ù„Ø© Ù…ØªØ§Ø­</div>
                <div class="card-sub">Ø³Ø¹Ø©: 20</div>
            </div>
        </div>

        <div id="upgrade-alert" class="alert-upgrade">
            ğŸš€ Ø§Ù†ØªØ¨Ù‡: ØªÙ… Ø®ØµÙ… <b id="alert-upg-cnt">0</b> Ù…Ù† Ø§Ù„ÙˆØµØ§Ù„Ø© Ù„ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…ÙØ±Ø¯
        </div>

        <div class="price-bar" id="price-bar">
            <div class="price-label">ğŸ’° Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­ <span id="price-status">(Ø¹Ø§Ø¯ÙŠ)</span></div>
            <div class="price-values">
                <div class="p-val" style="color:var(--color-single)"><span id="p-s">200</span><span>Ù…ÙØ±Ø¯</span></div>
                <div class="p-val" style="color:var(--color-suite)"><span id="p-r">230</span><span>ÙˆØµØ§Ù„Ø©</span></div>
            </div>
        </div>

        <div class="section">
            <div class="sec-title">ğŸ¨ Ø§Ù„Ø¥Ø´ØºØ§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
            <div class="control-row">
                <div class="control-label lbl-single"><span>ğŸ›ï¸</span> Ù…Ø¬Ø¯Ø¯ (Ù…ÙØ±Ø¯)</div>
                <div class="stepper" onmousedown="zenStart()" onmouseup="zenEnd()" ontouchstart="zenStart()" ontouchend="zenEnd()">
                    <button class="step-btn btn-minus" onclick="changeVal('stayS', -1, 4)">âˆ’</button>
                    <span class="val-display" id="disp-stayS">0</span>
                    <button class="step-btn btn-plus" onclick="changeVal('stayS', 1, 4)">+</button>
                </div>
            </div>
            <div class="cap-bar-bg"><div class="cap-bar-fill" id="bar-stayS"></div></div>
            
            <hr style="border:0; border-top:1px dashed #eee; margin:15px 0;">

            <div class="control-row">
                <div class="control-label lbl-suite"><span>ğŸ›‹ï¸</span> Ù…Ø¬Ø¯Ø¯ (ÙˆØµØ§Ù„Ø©)</div>
                <div class="stepper" onmousedown="zenStart()" onmouseup="zenEnd()" ontouchstart="zenStart()" ontouchend="zenEnd()">
                    <button class="step-btn btn-minus" onclick="changeVal('stayR', -1, 20)">âˆ’</button>
                    <span class="val-display" id="disp-stayR">0</span>
                    <button class="step-btn btn-plus" onclick="changeVal('stayR', 1, 20)">+</button>
                </div>
            </div>
            <div class="cap-bar-bg"><div class="cap-bar-fill" id="bar-stayR"></div></div>
        </div>

        <div class="section">
            <div class="sec-title">ğŸšª Ù…Ø­ØªÙ…Ù„ Ø®Ø±ÙˆØ¬ (50%)</div>
            <div class="control-row">
                <div class="control-label lbl-single"><span>ğŸšª</span> Ø®Ø±ÙˆØ¬ (Ù…ÙØ±Ø¯)</div>
                <div class="stepper" onmousedown="zenStart()" onmouseup="zenEnd()" ontouchstart="zenStart()" ontouchend="zenEnd()">
                    <button class="step-btn btn-minus" onclick="changeVal('potS', -1, 4)">âˆ’</button>
                    <span class="val-display" id="disp-potS">0</span>
                    <button class="step-btn btn-plus" onclick="changeVal('potS', 1, 4)">+</button>
                </div>
            </div>
            <div class="control-row" style="margin-top:10px;">
                <div class="control-label lbl-suite"><span>ğŸšª</span> Ø®Ø±ÙˆØ¬ (ÙˆØµØ§Ù„Ø©)</div>
                <div class="stepper" onmousedown="zenStart()" onmouseup="zenEnd()" ontouchstart="zenStart()" ontouchend="zenEnd()">
                    <button class="step-btn btn-minus" onclick="changeVal('potR', -1, 20)">âˆ’</button>
                    <span class="val-display" id="disp-potR">0</span>
                    <button class="step-btn btn-plus" onclick="changeVal('potR', 1, 20)">+</button>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="sec-title">ğŸ“… Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© (Ù…Ø¤ÙƒØ¯)</div>
            <div class="control-row">
                <div class="control-label">Ø¨ÙˆÙƒÙŠÙ†Ø¬ (Ù…ÙØ±Ø¯)</div>
                <div class="stepper" onmousedown="zenStart()" onmouseup="zenEnd()" ontouchstart="zenStart()" ontouchend="zenEnd()">
                    <button class="step-btn btn-minus" onclick="changeVal('bkS', -1, 100)">âˆ’</button>
                    <span class="val-display" id="disp-bkS">0</span>
                    <button class="step-btn btn-plus" onclick="changeVal('bkS', 1, 100, true)">+</button>
                </div>
            </div>
            <div class="control-row">
                <div class="control-label">Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ (Ù…ÙØ±Ø¯)</div>
                <div class="stepper" onmousedown="zenStart()" onmouseup="zenEnd()" ontouchstart="zenStart()" ontouchend="zenEnd()">
                    <button class="step-btn btn-minus" onclick="changeVal('recS', -1, 100)">âˆ’</button>
                    <span class="val-display" id="disp-recS">0</span>
                    <button class="step-btn btn-plus" onclick="changeVal('recS', 1, 100, true)">+</button>
                </div>
            </div>
            <hr style="border:0; border-top:1px dashed #eee; margin:15px 0;">
            <div class="control-row">
                <div class="control-label">Ø¨ÙˆÙƒÙŠÙ†Ø¬ (ÙˆØµØ§Ù„Ø©)</div>
                <div class="stepper" onmousedown="zenStart()" onmouseup="zenEnd()" ontouchstart="zenStart()" ontouchend="zenEnd()">
                    <button class="step-btn btn-minus" onclick="changeVal('bkR', -1, 100)">âˆ’</button>
                    <span class="val-display" id="disp-bkR">0</span>
                    <button class="step-btn btn-plus" onclick="changeVal('bkR', 1, 100, true)">+</button>
                </div>
            </div>
            <div class="control-row">
                <div class="control-label">Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ (ÙˆØµØ§Ù„Ø©)</div>
                <div class="stepper" onmousedown="zenStart()" onmouseup="zenEnd()" ontouchstart="zenStart()" ontouchend="zenEnd()">
                    <button class="step-btn btn-minus" onclick="changeVal('recR', -1, 100)">âˆ’</button>
                    <span class="val-display" id="disp-recR">0</span>
                    <button class="step-btn btn-plus" onclick="changeVal('recR', 1, 100, true)">+</button>
                </div>
            </div>
        </div>

    </div>

    <div class="sticky-footer">
        <div class="advice-container">
            <div id="adv-single" class="advice-pill pill-green">Ù…ÙØ±Ø¯: 0</div>
            <div id="adv-suite" class="advice-pill pill-green">ÙˆØµØ§Ù„Ø©: 0</div>
        </div>
        
        <div class="actions-row">
            <button id="submit-btn" onclick="sendWhatsApp()">Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ ğŸš€</button>
            <button id="copy-btn" onclick="copyText()" title="Ù†Ø³Ø® Ø§Ù„Ù†Øµ">ğŸ“‹</button>
        </div>

        <div class="footer-credits">
            ØªØ·ÙˆÙŠØ±: <b>Ø§ÙŠÙ…Ù† Ø§Ø¨Ùˆ ÙˆØ±Ø¯Ù‡</b> | 77aayy@gmail.com
        </div>
    </div>

    <div id="explain-modal" class="modal-overlay" onclick="closeExplain()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="color:var(--primary); margin-top:0;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
            <div id="math-content"></div>
            <button onclick="closeExplain()" style="margin-top:15px; width:100%; padding:10px; border:none; background:#eee; border-radius:10px;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
    
    <div id="password-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color:var(--danger); margin-top:0;">ğŸ”’ ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
            <p>Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
            <input type="password" id="admin-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
            <button onclick="checkPasswordAndReset()" style="width:100%; padding:12px; border:none; border-radius:10px; background:var(--danger); color:white; font-weight:bold; margin-bottom:10px;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØµÙÙŠØ±</button>
            <button onclick="document.getElementById('password-modal').style.display='none'" style="width:100%; padding:10px; border:none; background:#eee; border-radius:10px;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <script>
        // --- 1. Security & Config ---
        // ğŸ”’ HASHED PASSWORD "fahd5"
        function simpleHash(s) {
            let h = 0xdeadbeef;
            for(let i=0;i<s.length;i++) h = Math.imul(h ^ s.charCodeAt(i), 2654435761);
            return ((h ^ h >>> 16) >>> 0);
        }
        const ADMIN_HASH = 97325605; // Hash for "fahd5"

        // ğŸ”¥ Firebase Configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBApR7pOlOPcP93ZYUBeT5D7hgAuV0dg0M",
          authDomain: "abella-all.firebaseapp.com",
          databaseURL: "https://abella-all-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "abella-all",
          storageBucket: "abella-all.firebasestorage.app",
          messagingSenderId: "608492409476",
          appId: "1:608492409476:web:6d6ac8e85dd2fba1b328d1"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const collectionName = 'occupancyState_v1'; // Distinct collection for manager

        // --- Constants & Config ---
        const CAP_S = 4, CAP_R = 20; const RISK = 0.5;
        // Pricing Matrix [Std, Med, High]
        const P_REG_S = [200, 230, 250]; const P_REG_R = [230, 250, 280];
        const P_SEA_S = [280, 330, 380]; const P_SEA_R = [330, 380, 420];

        // State
        let s = { stayS:0, stayR:0, potS:0, potR:0, bkS:0, bkR:0, recS:0, recR:0, history: [] };
        let calc = {};
        let isSeason = false;
        let sessionSales = 0; // Local counter

        window.onload = () => { loadData(); checkTheme(); };

        // --- Interactive Functions ---
        function changeVal(key, amount, maxCap, isSale = false) {
            let val = s[key] + amount;
            if (val < 0) val = 0;
            if (['stayS','potS'].includes(key) && (s.stayS + s.potS + amount > CAP_S)) { vibrate(50); return; }
            if (['stayR','potR'].includes(key) && (s.stayR + s.potR + amount > CAP_R)) { vibrate(50); return; }
            
            s[key] = val;
            vibrate(10);
            
            // Anim
            const el = document.getElementById('disp-'+key);
            el.classList.remove('pop-anim'); void el.offsetWidth; el.classList.add('pop-anim');
            
            // Log Action (For Memory Protection Logic)
            if (!s.history) s.history = [];
            s.history.push({ action: key, val: amount, time: Date.now() });
            
            // Gamification (Local)
            if(isSale && amount > 0) {
                sessionSales++;
                showToast(`ğŸš€ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙˆØ±Ø¯ÙŠØ©: ${sessionSales}`);
            }

            saveData(); updateUI();
        }

        function toggleSeason() {
            isSeason = !isSeason;
            const btn = document.getElementById('season-btn');
            if(isSeason) btn.classList.add('active'); else btn.classList.remove('active');
            updateUI(); // Local Toggle
        }

        function zenStart() { document.body.classList.add('zen-active'); }
        function zenEnd() { document.body.classList.remove('zen-active'); }

        // --- Core Logic ---
        function updateUI() {
            // Update Displays
            for (let k in s) {
                if(document.getElementById('disp-'+k)) document.getElementById('disp-'+k).innerText = s[k];
            }
            
            // Update Progress Bars
            updateBar('bar-stayS', s.stayS, CAP_S);
            updateBar('bar-stayR', s.stayR, CAP_R);

            // Calculation
            const gainS = Math.floor(s.potS * RISK); const gainR = Math.floor(s.potR * RISK);
            let netS = (CAP_S - (s.stayS + s.potS) + gainS) - (s.bkS + s.recS);
            let netR = (CAP_R - (s.stayR + s.potR) + gainR) - (s.bkR + s.recR);
            let upg = 0;
            if (netS < 0 && netR > 0) { upg = Math.min(Math.abs(netS), netR); netS += upg; netR -= upg; }
            calc = { netS, netR, upg, gainS, gainR };

            // Update Charts
            updateChart('circle-s', 'txt-s', netS, CAP_S, '#card-single', 'c-single');
            updateChart('circle-r', 'txt-r', netR, CAP_R, '#card-suite', 'c-suite');

            // Upgrade Alert
            const alert = document.getElementById('upgrade-alert');
            if (upg > 0) { alert.style.display = 'block'; document.getElementById('alert-upg-cnt').innerText = upg; } 
            else alert.style.display = 'none';

            // Advice Pills
            updateAdvicePill('adv-single', 'Ù…ÙØ±Ø¯', netS); updateAdvicePill('adv-suite', 'ÙˆØµØ§Ù„Ø©', netR);

            // Pricing Logic
            updatePricing(netS, netR);
        }

        function updatePricing(netS, netR) {
            let lvlS = 0; if(netS < 1) lvlS = 2; else if(netS < 2) lvlS = 1;
            let lvlR = 0; if(netR < 5) lvlR = 2; else if(netR < 10) lvlR = 1;
            let globalLvl = Math.max(lvlS, lvlR); 
            
            const pricesS = isSeason ? P_SEA_S : P_REG_S;
            const pricesR = isSeason ? P_SEA_R : P_REG_R;

            document.getElementById('p-s').innerText = pricesS[globalLvl];
            document.getElementById('p-r').innerText = pricesR[globalLvl];

            const bar = document.getElementById('price-bar');
            const statusTxt = document.getElementById('price-status');
            
            bar.className = 'price-bar'; // reset
            if(globalLvl === 0) { bar.classList.add('price-mode-std'); statusTxt.innerText = '(Ù‚ÙŠØ§Ø³ÙŠ)'; }
            else if(globalLvl === 1) { bar.classList.add('price-mode-med'); statusTxt.innerText = '(Ù…ØªÙˆØ³Ø·)'; }
            else { bar.classList.add('price-mode-high'); statusTxt.innerText = '(Ù…Ø±ØªÙØ¹)'; }
        }

        function updateBar(id, val, cap) {
            const el = document.getElementById(id);
            if(!el) return;
            let pct = (val / cap) * 100;
            el.style.width = pct + '%';
            if(pct > 90) el.style.background = 'var(--danger)';
            else if(pct > 50) el.style.background = 'var(--warning)';
            else el.style.background = 'var(--success)';
        }

        function updateChart(cId, tId, val, cap, cardId, cls) {
            const circle = document.getElementById(cId); const txt = document.getElementById(tId); const card = document.querySelector(cardId);
            let pct = val > 0 ? (val/cap)*100 : 0; if(pct>100) pct=100; if(pct<0) pct=0;
            circle.setAttribute('stroke-dasharray', `${pct}, 100`); txt.innerText = val;
            card.className = `card ${cls}`;
            if(val>0) circle.style.stroke = (cls==='c-single')?'var(--color-single)':'var(--color-suite)';
            else if(val===0) { circle.style.stroke='var(--warning)'; card.classList.add('stat-warn'); }
            else { circle.style.stroke='var(--danger)'; card.classList.add('stat-danger'); }
        }

        function updateAdvicePill(id, name, val) {
            const el = document.getElementById(id);
            if (val > 0) { el.className = 'advice-pill pill-green'; el.innerText = `âœ… Ø§ÙØªØ­ ${name} (${val})`; }
            else { el.className = 'advice-pill pill-red'; el.innerText = `â›” Ø£ØºÙ„Ù‚ ${name}`; }
        }

        function showToast(msg) {
            const t = document.getElementById('game-toast');
            document.getElementById('sales-count').innerText = sessionSales;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        // --- Utils ---
        function vibrate(ms) { if (navigator.vibrate) navigator.vibrate(ms); }
        function toggleDarkMode() { document.body.classList.toggle('dark-mode'); localStorage.setItem('abella_theme', document.body.classList.contains('dark-mode')?'dark':'light'); }
        function checkTheme() { if(localStorage.getItem('abella_theme')==='dark') document.body.classList.add('dark-mode'); }
        
        // --- Report Generation ---
        function getReportText() {
            const t = new Date().toLocaleTimeString('ar-EG',{hour:'numeric',minute:'numeric',hour12:true});
            const upgMsg = calc.upg > 0 ? `\n(âš ï¸ ØªÙ… Ø®ØµÙ… ${calc.upg} Ù„ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…ÙØ±Ø¯)` : "";
            const ps = document.getElementById('p-s').innerText;
            const pr = document.getElementById('p-r').innerText;
            
            return `*ØªÙ‚Ø±ÙŠØ± ÙÙ†Ø¯Ù‚ Ø£Ø¨ÙŠÙ„Ø§ ğŸ¨*\nğŸ•’ ${t}\n------------------\nğŸ“Š *Ù…ØªØ§Ø­ Ù„Ù„Ø¨ÙŠØ¹*\nâ€¢ Ù…ÙØ±Ø¯: *${calc.netS}*\nâ€¢ ØºØ±ÙØ© ÙˆØµØ§Ù„Ø©: *${calc.netR}* ${upgMsg}\n------------------\nğŸ’° *Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©*\nâ€¢ Ù…ÙØ±Ø¯: ${ps} | ÙˆØµØ§Ù„Ø©: ${pr}\n------------------\nğŸ“ *Ø§Ù„ØªÙØ§ØµÙŠÙ„*\nâ€¢ Ø¥Ù‚Ø§Ù…Ø©: ${s.stayS} Ù…ÙØ±Ø¯ | ${s.stayR} ÙˆØµØ§Ù„Ø©\nâ€¢ Ø®Ø±ÙˆØ¬: ${s.potS} Ù…ÙØ±Ø¯ | ${s.potR} ÙˆØµØ§Ù„Ø©\nâ€¢ Ø­Ø¬ÙˆØ²Ø§Øª: ${s.bkS+s.recS} Ù…ÙØ±Ø¯ | ${s.bkR+s.recR} ÙˆØµØ§Ù„Ø©\n------------------\nğŸ’¡ *Ø§Ù„Ù†ØµÙŠØ­Ø©*\n1ï¸âƒ£ ${calc.netS>0?'âœ… Ø§ÙØªØ­ Ù…ÙØ±Ø¯':'â›” Ø£ØºÙ„Ù‚ Ù…ÙØ±Ø¯'}\n2ï¸âƒ£ ${calc.netR>0?'âœ… Ø§ÙØªØ­ ÙˆØµØ§Ù„Ø©':'â›” Ø£ØºÙ„Ù‚ ÙˆØµØ§Ù„Ø©'}`;
        }
        function sendWhatsApp() { window.open(`https://wa.me/?text=${encodeURIComponent(getReportText())}`, '_blank'); }
        function copyText() { navigator.clipboard.writeText(getReportText()).then(() => { alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± ğŸ“‹"); }); }

        // Explain Modal
        function showExplain(t) {
            const m = document.getElementById('explain-modal'); const c = document.getElementById('math-content'); let h = '';
            if (t==='single') h = genMathHtml(CAP_S, s.stayS, s.potS, calc.gainS, s.bkS+s.recS, calc.netS, calc.upg, 'add');
            else h = genMathHtml(CAP_R, s.stayR, s.potR, calc.gainR, s.bkR+s.recR, calc.netR, calc.upg, 'sub');
            c.innerHTML = h; m.style.display = 'flex';
        }
        function closeExplain() { document.getElementById('explain-modal').style.display = 'none'; }
        function genMathHtml(cap, stay, pot, gain, inc, net, upg, mode) {
            let html = `<div class="math-row"><span>Ø§Ù„Ø³Ø¹Ø© Ø§Ù„ÙƒÙ„ÙŠØ©</span><b>${cap}</b></div><div class="math-row"><span>(-) Ù…Ø´ØºÙˆÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹</span><span>${stay}</span></div><div class="math-row"><span>(-) Ø®Ø±ÙˆØ¬ (Ù…Ø§Ø¯ÙŠ)</span><span>${pot}</span></div><div class="math-row"><span>(+) Ù…ÙƒØ³Ø¨ Ù…Ø®Ø§Ø·Ø±Ø©</span><span>${gain}</span></div><div class="math-row"><span>(-) Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©</span><span>${inc}</span></div><div style="border-top:1px solid #ccc; margin:5px 0"></div><div class="math-row"><span>= Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„Ø£ÙˆÙ„ÙŠ</span><b>${(cap-(stay+pot)+gain)-inc}</b></div>`;
            if(upg > 0) { if(mode==='add') html += `<div class="math-row" style="color:var(--upgrade)"><span>(+) ØªØºØ·ÙŠØ© ØªØ±Ù‚ÙŠØ©</span><b>${upg}</b></div>`; else html += `<div class="math-row" style="color:var(--upgrade)"><span>(-) Ø®ØµÙ… ØªØ±Ù‚ÙŠØ©</span><b>${upg}</b></div>`; html += `<div class="math-row" style="font-weight:800; color:var(--primary)"><span>= Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span><b>${net}</b></div>`; }
            return html;
        }

        // --- ğŸ”¥ Firebase Logic (Replaces localStorage) ---
        
        // 1. Save Data with Sync Indicator & Memory Protection
        function saveData() {
            const indicator = document.getElementById('sync-indicator');
            if (indicator) indicator.style.display = 'block';

            // ğŸ›¡ï¸ Memory Protection: Trim history
            if (s.history && s.history.length > 150) {
                s.history = s.history.slice(s.history.length - 150);
            }

            const mainDocRef = db.collection(collectionName).doc('main');
            
            // Add timestamp for data integrity
            const dataToSave = { ...s, timestamp: firebase.firestore.FieldValue.serverTimestamp() };

            mainDocRef.set(dataToSave)
                .then(() => {
                    if (indicator) setTimeout(() => indicator.style.display = 'none', 1000);
                })
                .catch((error) => {
                    console.error("Error saving:", error);
                    if (indicator) indicator.innerText = 'âŒ Ø®Ø·Ø£';
                });
        }

        // 2. Load Data with Self-Healing
        function loadData() {
            const mainDocRef = db.collection(collectionName).doc('main');
            
            mainDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    // Self-healing: Ensure all keys exist
                    s = { 
                        stayS: data.stayS || 0, stayR: data.stayR || 0,
                        potS: data.potS || 0, potR: data.potR || 0,
                        bkS: data.bkS || 0, bkR: data.bkR || 0,
                        recS: data.recS || 0, recR: data.recR || 0,
                        history: data.history || []
                    };
                    updateUI();
                } else {
                    // Initialize if empty
                    s = { stayS:0, stayR:0, potS:0, potR:0, bkS:0, bkR:0, recS:0, recR:0, history: [] };
                    saveData();
                }
            });
        }

        // 3. Secure Reset
        function showResetModal() {
            document.getElementById('password-modal').style.display = 'flex';
        }

        function checkPasswordAndReset() {
            const pwd = document.getElementById('admin-password').value.trim();
            if (simpleHash(pwd) === ADMIN_HASH) {
                s = { stayS:0, stayR:0, potS:0, potR:0, bkS:0, bkR:0, recS:0, recR:0, history: [] }; 
                sessionSales = 0; 
                saveData(); 
                updateUI();
                document.getElementById('password-modal').style.display = 'none';
                document.getElementById('admin-password').value = '';
                showToast('âœ… ØªÙ… Ø§Ù„ØªØµÙÙŠØ± Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                alert('âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            }
        }

    </script>
</body>
</html>
