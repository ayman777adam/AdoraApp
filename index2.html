<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†Ø¸ÙˆÙ…Ø© Ù…ØªØ§Ø¨Ø¹Ø© ÙÙ†Ø¯Ù‚ÙŠØ© - V8.10 (Final)</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <style>
        /* ============================================================
           CSS (V8.10: Swipe Clock, Haptics & Pulse Active Row)
           ============================================================ */
        :root {
            --bg-body: #f4f6f8; --bg-card: #ffffff; --text-main: #2c3e50; --text-sec: #7f8c8d;
            --border-color: #e0e0e0; --primary: #0097a7; --primary-light: #e0f7fa; 
            --success: #00b894; --danger: #d63031; --warning: #f1c40f; --upgrade: #7e57c2;
            --gold-btn: #FFD700; --shadow: 0 4px 15px rgba(0,0,0,0.05);
            --circle-width: 7px; 
        }
        
        /* ğŸ”¥ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Deep Slate Theme) */
        body.dark-mode { 
            --bg-body: #0f172a; 
            --bg-card: #1e293b; 
            --text-main: #f1f5f9; 
            --text-sec: #94a3b8; 
            --border-color: #334155; 
            --primary: #38bdf8; 
            --primary-light: rgba(56, 189, 248, 0.1);
            --shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 15px 15px 50px 15px; -webkit-tap-highlight-color: transparent; overflow-x: hidden; transition: background 0.3s, color 0.3s; }
        .container { max-width: 500px; margin: 0 auto; }
        
        /* ğŸ”¥ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„Ù…ÙˆØ²ÙˆÙ†Ø© */
        .header-glass { 
            background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; 
            padding: 12px 15px; margin-bottom: 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: var(--shadow); 
        }
        .header-right { display: flex; flex-direction: column; align-items: flex-start; gap: 2px; }
        .header-right h1 { font-size: 1.1rem; margin: 0; color: var(--primary); font-weight: 800; }
        .header-subtitle { font-size: 0.75rem; color: var(--text-sec); font-weight: 700; }
        .dev-name { color: var(--text-main); font-weight: 300; font-size: 0.8rem; letter-spacing: 0.5px; }
        body.dark-mode .dev-name { color: #cbd5e1; } 

        .header-left { display: flex; gap: 8px; align-items: center; background: var(--bg-body); padding: 4px; border-radius: 12px; border: 1px solid var(--border-color); }
        .tools-btn { background: transparent; border: none; padding: 6px 10px; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        
        /* ğŸ”¥ Ù…Ø¤Ø´Ø± Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        #offline-indicator-badge { background: var(--danger); color: white; padding: 4px 8px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; display: none; }


        .card, .section { background: var(--bg-card); border-radius: 18px; padding: 15px; box-shadow: var(--shadow); border: 1px solid var(--border-color); margin-bottom: 15px; transition: 0.3s; }
        
        /* V8.2: ØªØµÙ…ÙŠÙ… Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© + (Clean CSS Class) */
        .btn-add-room {
            background: var(--success); color: white; padding: 4px 12px; 
            font-weight: bold; font-size: 1.2rem; border-radius: 50px; 
            border: none; cursor: pointer;
            transition: transform 0.1s;
        }
        .btn-add-room:active { transform: scale(0.95); }

        .sec-title { font-weight: 700; color: var(--primary); margin-bottom: 15px; border-bottom: 1px dashed var(--border-color); padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        
        .search-box { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--bg-body); color: var(--text-main); font-family: 'Tajawal', sans-serif; font-weight: bold; margin-bottom: 15px; box-sizing: border-box; transition: 0.3s; }
        .search-box:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px var(--primary-light); }
        
        .room-row { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 10px; margin-bottom: 10px; display: grid; grid-template-columns: 50px 0.8fr 1fr auto; gap: 8px; align-items: center; border-right: 4px solid transparent; transition: 0.3s; }
        .room-row.status-cleaning { border-right-color: var(--primary); background: rgba(0, 151, 167, 0.05); }
        .room-row.status-checking { border-right-color: var(--warning); background: rgba(241, 196, 15, 0.05); }
        .room-row.status-over { border-right-color: var(--danger); background: rgba(214, 48, 49, 0.05); animation: pulseRed 2s infinite; }
        .room-row.status-acknowledging { border-right-color: var(--upgrade); background: rgba(126, 87, 194, 0.05); }
        
        body.dark-mode .room-row.status-cleaning { background: rgba(56, 189, 248, 0.1); }
        body.dark-mode .room-row.status-checking { background: rgba(253, 224, 71, 0.1); }
        body.dark-mode .room-row.status-over { background: rgba(248, 113, 113, 0.1); }
        
        /* ğŸ”¥ V8.10: ØªÙ…ÙŠÙŠØ² Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ù†Ø´Ø£Ø© Ø­Ø¯ÙŠØ«Ø§Ù‹ */
        .room-row.status-newly-added {
            background-color: rgba(0, 184, 148, 0.1); /* Ø£Ø®Ø¶Ø± ÙØ§ØªØ­ Ø¬Ø¯Ø§Ù‹ */
            border-color: var(--success);
            animation: pulseGreen 1.5s infinite alternate;
        }

        @keyframes pulseRed { 0% {box-shadow: 0 0 0 0 rgba(214, 48, 49, 0.4);} 70% {box-shadow: 0 0 0 6px rgba(214, 48, 49, 0);} 100% {box-shadow: 0 0 0 0 rgba(214, 48, 49, 0);} }
        /* ğŸ”¥ V8.10: Ù†Ø¨Ø¶ Ø£Ø®Ø¶Ø± Ø®ÙÙŠÙ */
        @keyframes pulseGreen { 0% {box-shadow: 0 0 0 0 rgba(0, 184, 148, 0.3);} 100% {box-shadow: 0 0 0 4px rgba(0, 184, 148, 0);} }
        
        .timer-display { font-weight: 800; font-size: 1rem; text-align: center; color: var(--text-sec); }
        .timer-active { color: var(--primary); }
        .timer-danger { color: var(--danger); }
        
        /* ğŸ”¥ V8.6: ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© */
        .circle-viz { 
            width: 75px; height: 75px; border-radius: 50%; margin: 0 auto 5px auto; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            background: var(--bg-body); box-shadow: 4px 4px 8px rgba(0,0,0,0.1), -4px -4px 8px rgba(255,255,255,0.8); 
            border: var(--circle-width) solid var(--bg-body); transition: 0.3s; 
            /* V8.6: ØªÙˆØ³ÙŠØ· ÙˆØªØµØºÙŠØ± Ø§Ù„Ø®Ø·ÙˆØ· */
            line-height: 1.1; 
        }
        .circle-viz h3 { margin: 0; font-size: 1.1rem; color: var(--text-main); } /* ØªØµØºÙŠØ± Ø§Ù„Ø±Ù‚Ù… */
        .circle-viz span { font-size: 0.6rem; color: var(--text-sec); line-height: 1; margin-top: 2px; } /* ØªØµØºÙŠØ± Ø§Ù„Ù†Øµ */


        /* ğŸ”¥ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£ÙƒØ´Ù† Ø¨Ø­ÙˆØ§Ù Ø¨ÙŠØ¶Ø§ÙˆÙŠØ© (Capsule) ÙˆØªØ£Ø«ÙŠØ± Ø²Ø¬Ø§Ø¬ÙŠ */
        .btn-action { 
            padding: 8px 10px; border: none; border-radius: 50px; 
            font-weight: bold; cursor: pointer; color: #fff; font-size: 0.8rem; 
            backdrop-filter: blur(1px); 
            transition: transform 0.1s;
        }
        .btn-action:active { transform: scale(0.98); }

        .full-btn { 
            width: 100%; 
            padding: 10px; 
            border: none; 
            border-radius: 50px; 
            font-weight: bold; cursor: pointer; font-size: 1rem; color: white; 
            backdrop-filter: blur(1px); 
            transition: transform 0.1s;
        }
        .full-btn:active { transform: scale(0.98); }

        .btn-start { background: var(--primary); }
        .btn-clean-done { background: var(--warning); color: #333; }
        .btn-finish { background: var(--success); }
        
        /* ğŸ”¥ Ø²Ø± Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø­Ø³Ù† (Ù†Ø¨Ø¶ + Ø¹Ø¯Ø§Ø¯) */
        .btn-undo { 
            background: transparent; color: var(--text-sec); 
            border: 1px solid var(--border-color); 
            margin-top: 5px; font-size: 0.7rem; width: 100%; padding: 4px; 
            border-radius: 20px; cursor: pointer; font-weight: bold; 
            transition: 0.3s; position: relative; overflow: hidden;
        }
        .btn-undo.active-anim {
            border-color: var(--primary); color: var(--primary);
            animation: pulseBlue 1.5s infinite;
        }
        .btn-undo.urgent-anim {
            border-color: var(--danger); color: var(--danger);
            animation: pulseRedBorder 0.8s infinite;
        }
        @keyframes pulseBlue { 0% {box-shadow: 0 0 0 0 rgba(0, 151, 167, 0.4);} 100% {box-shadow: 0 0 0 4px rgba(0, 151, 167, 0);} }
        @keyframes pulseRedBorder { 0% {box-shadow: 0 0 0 0 rgba(214, 48, 49, 0.4);} 100% {box-shadow: 0 0 0 4px rgba(214, 48, 49, 0);} }

        .badge { font-size: 0.6rem; padding: 2px 4px; border-radius: 4px; background: rgba(0,0,0,0.05); color: var(--text-sec); display: block; margin-top: 2px; }
        body.dark-mode .badge { background: rgba(255,255,255,0.1); color: #cbd5e1; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px 5px; text-align: center; margin-bottom: 15px; }
        .stat-circle-box { text-align: center; }

        /* V8.2: Ø³ØªØ§ÙŠÙ„ Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© */
        .stat-detail-box {
            padding: 10px; border-radius: 12px; border: 1px solid var(--border-color); 
            text-align: center; 
            background: var(--bg-body); 
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            transition: 0.3s; 
        }

        /* V8.2: ÙØ§ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠØ© ÙˆØ§Ù„ÙØ±Ø¹ÙŠØ© */
        #stat-details-container {
            padding-top: 15px; 
            margin-top: 15px; 
            border-top: 1px dashed var(--border-color);
        }
        
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(3px); }
        .modal-content { 
            background: var(--bg-card); 
            padding: 15px; 
            border-radius: 20px; width: 90%; 
            max-width: 250px; 
            border: 1px solid var(--border-color); box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            text-align: center; 
        }

        /* âœ… V8.4: ØªØµØºÙŠØ± Ø­Ø¬Ù… Ø®Ø·ÙˆØ· ÙˆØ¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        .modal-label { font-size: 0.8rem; font-weight: 700; margin-bottom: 5px; display: block; color: var(--text-main); }
        .modal-content input, .modal-content textarea { 
            width: 100%; padding: 10px; 
            margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; background: var(--bg-body); color: var(--text-main); 
            font-size: 0.9rem; 
        }
        
        /* ğŸ”¥ V8.9: ØªÙ†Ø³ÙŠÙ‚ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (3-Parts Digital Clock) */
        .time-input-container {
            display: flex; gap: 8px; justify-content: space-between;
        }
        .time-part-box {
            flex: 1; padding: 12px 5px; border-radius: 12px; 
            background: var(--bg-body); color: var(--text-main); 
            font-weight: 800; font-size: 1.2rem; text-align: center;
            border: 2px solid var(--border-color); cursor: pointer;
            transition: 0.2s; position: relative;
        }
        body.dark-mode .time-part-box { color: var(--primary); }
        .time-part-box:active { transform: scale(0.98); }
        .time-part-box.active { 
            border-color: var(--primary); background: var(--primary-light); 
            color: var(--primary); box-shadow: 0 0 0 2px var(--primary-light); 
        }

        .time-arrow { 
            position: absolute; top: -5px; right: 50%; 
            transform: translateX(50%); font-size: 0.7rem; color: var(--text-sec);
        }
        .time-arrow.down { top: auto; bottom: -5px; }
        
        /* ğŸ”¥ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù€ time-input-digital */
        .time-input-digital { display: none; }
        .time-period-select {
            flex: 1; 
            padding: 10px; border-radius: 8px;
            background: var(--bg-body); color: var(--text-main);
            border: 1px solid var(--border-color); font-weight: 700;
            font-size: 0.9rem;
        }
        
        /* ğŸ”¥ Custom UI Styles - ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù€ Capsule/Glass */
        .toggle-container { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; background: rgba(0,0,0,0.02); padding: 10px; border-radius: 12px; border: 1px solid var(--border-color); }
        .toggle-label { font-weight: bold; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; color: var(--text-main); }
        .switch { position: relative; display: inline-block; width: 52px; height: 28px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(24px); }

        .custom-options-container { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        .option-btn { 
            padding: 11px 12px; 
            border: 2px solid var(--border-color); 
            border-radius: 50px; 
            background: var(--bg-body); color: var(--text-main); font-weight: bold; cursor: pointer; text-align: center; display: flex; justify-content: space-between; align-items: center; 
            font-size: 0.8rem; 
            transition: 0.2s;
        }
        .option-btn.selected { background: var(--success); color: white; border-color: var(--success); }
        .option-btn.selected::after { content: 'âœ”'; font-size: 1.2rem; }
        
        .radio-options-grid { display: flex; gap: 10px; margin-bottom: 15px; }
        .radio-btn-box { 
            flex: 1; 
            padding: 10px 5px; 
            border: 2px solid var(--border-color); 
            border-radius: 50px; 
            text-align: center; cursor: pointer; font-weight: bold; color: var(--text-sec); background: var(--bg-body); 
            font-size: 0.8rem; 
            transition: 0.2s;
        }
        .radio-btn-box.selected { border-color: var(--primary); background: var(--primary-light); color: var(--primary); }
        .radio-btn-box.selected-maint { border-color: var(--danger); background: rgba(214, 48, 49, 0.1); color: var(--danger); }
        
        #dev-footer-fixed { position: fixed; bottom: 0; left: 0; width: 100%; text-align: center; font-size: 0.7rem; color: var(--text-sec); background: var(--bg-card); padding: 5px 0; border-top: 1px solid var(--border-color); z-index: 1000; }
        .worker-action-row { display: flex; gap: 10px; width: 100%; margin-bottom: 10px; flex-wrap: wrap; }
        .worker-action-row .full-btn { flex: 1 1 48%; }
    </style>
</head>
<body class="worker-mode"> 
    <div class="container">
        <div class="header-glass">
            <div class="header-right">
                <h1>Ù…Ù†Ø¸ÙˆÙ…Ø© Ù…ØªØ§Ø¨Ø¹Ø© ÙÙ†Ø¯Ù‚ÙŠØ©</h1>
                <span class="header-subtitle">ØªÙ†ÙÙŠØ° - <span class="dev-name">Ø§ÙŠÙ…Ù† Ø§Ø¨Ùˆ ÙˆØ±Ø¯Ù‡</span></span>
            </div>
            <div class="header-left">
                <div id="offline-indicator-badge">ğŸ“¡ ØºÙŠØ± Ù…ØªØµÙ„</div>
                <button class="tools-btn" onclick="document.body.classList.toggle('dark-mode')" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">ğŸŒ™</button>
                <div style="width:1px; background:var(--border-color); margin:2px 0;"></div>
                <button id="langBtn" class="tools-btn" style="font-size:0.8rem; font-weight:700;" title="Ø§Ù„Ù„ØºØ©">ğŸŒ</button>
            </div>
        </div>

        <div class="worker-view">
            <div id="worker-toast" class="worker-toast"></div>
            <div id="rain-mode-indicator" class="quiet-notif" style="background:var(--upgrade); color:white;">âš¡ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙŠØ±Ø¨Ùˆ Ù…ÙØ¹Ù‘Ù„</div>
            <div id="sync-indicator" style="display: none;">ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...</div>

            <div class="section" style="margin-bottom:15px;">
                <div class="worker-action-row" style="margin-bottom: 0;">
                    <button id="turbo-mode-btn" class="full-btn" style="background:var(--success); font-size:0.9rem; flex: 1;" onclick="toggleTurboMode()">
                        ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙŠØ±Ø¨Ùˆ
                    </button>
                    <button id="report-btn-action" class="full-btn" style="background:var(--gold-btn); color: #37474f; font-size:0.9rem; flex: 1;" onclick="generateDailyReport()">
                        Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¯ÙŠØ± ğŸ“
                    </button>
                </div>
            </div>

            <div class="section" style="padding:15px;">
                <div class="sec-title">
                    <span>ğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡</span>
                    <button class="tools-btn" style="padding: 2px 6px;" onclick="showResetModal()">ğŸ—‘ï¸</button>
                </div>
                <div class="stats-grid">
                    <div class="stat-circle-box">
                        <div class="circle-viz" style="border-color: var(--danger);">
                            <h3 id="stat-late">0</h3><span>Ù…ØªØ£Ø®Ø±</span>
                        </div>
                    </div>
                    <div class="stat-circle-box">
                        <div class="circle-viz" style="border-color: var(--primary);">
                            <h3 id="stat-active">0</h3><span>Ù†Ø´Ø·</span>
                        </div>
                    </div>
                    <div class="stat-circle-box">
                        <div class="circle-viz" style="border-color: var(--success);">
                            <h3 id="stat-completed">0</h3><span>Ù…Ù†Ø¬Ø²</span>
                        </div>
                    </div>
                </div>
                
                <div id="stat-details-container">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:5px;">
                        <div class="stat-detail-box" style="border-color:var(--primary);">
                            <span style="display:block; font-size:0.75rem; color:var(--primary); font-weight:bold;">Ø®Ø±ÙˆØ¬ Ù…Ù†Ø¬Ø²</span>
                            <strong style="font-size:1.2rem; color:var(--primary);" id="stat-out-done">0</strong>
                        </div>
                        <div class="stat-detail-box" style="border-color:var(--upgrade);">
                            <span style="display:block; font-size:0.75rem; color:var(--upgrade); font-weight:bold;">Ø³Ø§ÙƒÙ† Ù…Ù†Ø¬Ø²</span>
                            <strong style="font-size:1.2rem; color:var(--upgrade);" id="stat-stay-done">0</strong>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="sec-title">
                    <span>ğŸšª ØªØªØ¨Ø¹ Ø§Ù„ØºØ±Ù</span>
                    <button class="btn-add-room" onclick="openAddModal()">+</button>
                </div>
                
                <div id="progressSection" style="margin-bottom:10px; display:none;"></div>
                
                <input type="text" id="search-bar" class="search-box" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©..." oninput="updateSearch(this.value)">
                <div id="rooms-container"></div>
            </div>

            <div class="section">
                <div class="sec-title">
                    <span>ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„Ø£Ø±Ø´ÙŠÙ</span>
                    <button class="tools-btn" style="padding: 4px 8px;" onclick="showLogClearModal()">ğŸ—‘ï¸</button>
                </div>
                <div id="worker-log-list" style="font-size:0.8rem; max-height:200px; overflow-y:auto;">
                    <p id="log-none-p" style="text-align:center; color:var(--text-sec);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø¹Ø¯</p>
                </div>
            </div>
        </div>
    </div>

    <div id="dev-footer-fixed">ØªØ·ÙˆÙŠØ± .. Ø§ÙŠÙ…Ù† Ø§Ø¨Ùˆ ÙˆØ±Ø¯Ù‡ 77aayy@gmail.com</div>

    <div id="addRoomModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color:var(--primary); margin-top:0;">Ø¥Ø¶Ø§ÙØ© ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <div style="margin-bottom:15px; text-align:right;">
                <label class="modal-label">Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©</label>
                <input type="number" id="inpRoomNum" placeholder="Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©" oninput="app.checkDuplicate(this.value)">
                <div id="room-dup-alert" style="font-size:0.8rem; font-weight:bold; margin-top:8px; padding:5px; border-radius:5px; text-align:center; display:none;"></div>
            </div>

            <div style="margin-bottom:15px;">
                <label class="modal-label">Ø­Ø§Ù„Ø© Ø§Ù„ØºØ±ÙØ©</label>
                <input type="hidden" id="inpRoomType">
                <div class="custom-options-container">
                    <div class="option-btn" id="opt_out" onclick="setRoomType('out')">Ø®Ø±ÙˆØ¬ (ØªÙ†Ø¸ÙŠÙ ÙÙˆØ±ÙŠ)</div>
                    <div class="option-btn" id="opt_stay" onclick="setRoomType('stay')">Ø³Ø§ÙƒÙ†</div>
                </div>
            </div>

            <div id="stayOptions" style="display:none; background:rgba(0,0,0,0.02); padding:10px; border-radius:10px; margin-bottom:15px; text-align:right;">
                <label class="modal-label">ÙˆØ¶Ø¹ Ø§Ù„Ù†Ø²ÙŠÙ„</label>
                <input type="hidden" id="inpGuestStatus" value="in">
                <div class="radio-options-grid">
                    <div class="radio-btn-box selected" id="gst_in" onclick="setGuestStatus('in')">Ø¨Ø§Ù„Ø¯Ø§Ø®Ù„</div>
                    <div class="radio-btn-box" id="gst_out" onclick="setGuestStatus('out')">Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬</div>
                </div>
                
                <label class="modal-label" id="lblTime" style="margin-top:10px;">ÙˆÙ‚Øª Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</label>
                <div class="time-input-container">
                    <div id="hourBox" class="time-part-box" 
                         onclick="app.changeTimeValue('hour', 1)" 
                         ontouchstart="app.handleTouchStart(event, 'hour')"
                         ontouchend="app.handleTouchEnd(event, 'hour')">
                        <span class="time-arrow">â–²</span>
                        <span id="inpHour">12</span>
                        <span class="time-arrow down">â–¼</span>
                    </div>
                    <div id="minuteBox" class="time-part-box" 
                         onclick="app.changeTimeValue('minute', 5)"
                         ontouchstart="app.handleTouchStart(event, 'minute')"
                         ontouchend="app.handleTouchEnd(event, 'minute')">
                        <span class="time-arrow">â–²</span>
                        <span id="inpMinute">00</span>
                        <span class="time-arrow down">â–¼</span>
                    </div>
                    <div id="periodBox" class="time-part-box" onclick="app.togglePeriod()">
                        <span class="time-arrow">â–²</span>
                        <span id="inpPeriodText">Ù…Ø³Ø§Ø¡Ù‹</span>
                        <span class="time-arrow down">â–¼</span>
                    </div>
                </div>
                <input type="hidden" id="inpHourValue" value="12">
                <input type="hidden" id="inpMinuteValue" value="0">
                <input type="hidden" id="inpPeriodValue" value="PM">
            </div>
            
            <div class="toggle-container" style="background: rgba(255, 152, 0, 0.1); border-color: rgba(255, 152, 0, 0.3);">
                <div class="toggle-label" style="color: #ef6c00;">ğŸš€ Ø³ÙˆØ¨Ø± ØªÙŠØ±Ø¨Ùˆ (Ø®ØµÙ… 5Ø¯ Ø¥Ø¶Ø§ÙÙŠØ©)</div>
                <label class="switch"><input type="checkbox" id="inpSuperTurbo"><span class="slider"></span></label>
            </div>

            <button class="full-btn" style="background:var(--success); margin-bottom:10px;" onclick="addNewRoom()">Ø¥Ø¶Ø§ÙØ© (ÙˆØ¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨)</button>
            <button class="full-btn" style="background:#ddd; color:#333;" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div id="rain-prompt-modal" class="modal-overlay">
        <div class="modal-content" style="text-align:center;">
            <h3 style="color:var(--primary); margin-top:0;">Ø§Ø®ØªØ± ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø¯Ø¡</h3>
            <p>Ù…Ø§ Ù‡Ùˆ ÙˆØ¶Ø¹ Ø§Ù„Ø¶ØºØ· Ù„Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©ØŸ</p>
            <button class="full-btn" style="background:var(--danger); margin-bottom:10px;" onclick="commitStartRoom(window.tempRoomId, true)">ğŸš€ Ø³ÙˆØ¨Ø± ØªÙŠØ±Ø¨Ùˆ (-5Ø¯)</button>
            <button class="full-btn" style="background:var(--success);" onclick="commitStartRoom(window.tempRoomId, false)">ÙˆØ¶Ø¹ Ø¹Ø§Ø¯ÙŠ</button>
        </div>
    </div>

    <div id="final-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0; color:var(--primary);" id="modal-title-text">ğŸ“ ØªÙ‚Ø±ÙŠØ± ÙØ­Øµ Ø§Ù„ØºØ±ÙØ©</h3>
            
            <div id="delay-reason-section" style="display:none; margin-bottom:15px; border-bottom:1px dashed var(--border-color); padding-bottom:10px;"> 
                <label class="modal-label" style="color:var(--danger); font-size:1rem;">âš ï¸ Ø³Ø¨Ø¨ Ø§Ù„ØªØ£Ø®ÙŠØ± (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ):</label>
                <input type="hidden" id="modal-delay">
                <div class="custom-options-container">
                    <div class="option-btn" id="dly_work" onclick="setDelayReason('Ø¶ØºØ· Ø¹Ù…Ù„')">Ø¶ØºØ· Ø¹Ù…Ù„</div>
                    <div class="option-btn" id="dly_room" onclick="setDelayReason('Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„ØºØ±ÙØ©')">Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„ØºØ±ÙØ©</div>
                    <div class="option-btn" id="dly_other" onclick="setDelayReason('Ø³Ø¨Ø¨ Ø¢Ø®Ø±')">Ø³Ø¨Ø¨ Ø¢Ø®Ø±</div>
                </div>
            </div>

            <label class="modal-label">Ø­Ø§Ù„Ø© Ø§Ù„ØºØ±ÙØ©:</label>
            <input type="hidden" id="modal-notes" value="Ø¬Ø§Ù‡Ø²Ø©">
            <div class="radio-options-grid">
                <div class="radio-btn-box selected" id="st_ready" onclick="setRoomStatus('Ø¬Ø§Ù‡Ø²Ø©')">Ø¬Ø§Ù‡Ø²Ø© ØªÙ…Ø§Ù…Ø§Ù‹ âœ…</div>
                <div class="radio-btn-box" id="st_maint" onclick="setRoomStatus('ØªØ­ØªØ§Ø¬ ØµÙŠØ§Ù†Ø©')">ØªØ­ØªØ§Ø¬ ØµÙŠØ§Ù†Ø© ğŸ› ï¸</div>
            </div>

            <div id="maintenance-fields" style="border: 1px dashed var(--warning); padding: 10px; border-radius: 8px; margin-bottom: 10px; display: none;">
                <label class="modal-label" style="color:var(--danger);">ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ):</label>
                <textarea id="repair-details-input" placeholder="Ø§ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©..."></textarea>
                <label class="modal-label">ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©):</label>
                <div style="display:flex; flex-direction:column; gap:10px;">
                    <label id="camera-label" for="modal-img-camera-input">ğŸ“¸ Ø§ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</label>
                    <input type="file" accept="image/*" capture="environment" id="modal-img-camera-input">
                </div>
            </div>

            <div class="toggle-container" style="background: rgba(76, 175, 80, 0.1); border-color: rgba(76, 175, 80, 0.3); margin-top: 15px;">
                <div class="toggle-label" style="color: #2e7d32;"><span style="font-size:1.4rem">ğŸ“²</span> Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨</div>
                <label class="switch"><input type="checkbox" id="inpSendWhatsapp" checked><span class="slider"></span></label>
            </div>

            <button class="full-btn" id="btn_confirm_finish" style="background:var(--success); margin-top:10px;" onclick="confirmFinishRoom()">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„ ğŸš€</button>
            <button class="full-btn" style="background:#ddd; color:#333;" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
    
    <div id="password-modal" class="modal-overlay">
        <div class="modal-content" style="text-align:center;">
            <h3 style="color:var(--danger); margin-top:0;">ØªØ­Ù‚Ù‚ Ø£Ù…Ù†ÙŠ</h3>
            <p>Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
            <input type="password" id="admin-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="width:100%; margin-bottom:15px;" />
            <button id="confirm-reset-btn" class="full-btn" style="background:var(--success); margin-bottom:10px;" onclick="checkPasswordAndAction()">ØªØ£ÙƒÙŠØ¯</button>
            <button class="full-btn" style="background:#ddd; color:#333;" onclick="document.getElementById('password-modal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
    
    <div id="action-confirm-modal" class="modal-overlay">
        <div class="modal-content" style="text-align:center;">
            <h3 id="confirm-title" style="color:var(--danger); margin-top:0;">ØªØ£ÙƒÙŠØ¯</h3>
            <p id="confirm-message" style="font-size:0.9rem;">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</p>
            <button id="confirm-yes-btn" class="full-btn" style="background:var(--success); margin-bottom:10px;">Ù†Ø¹Ù…ØŒ Ø£Ø¤ÙƒØ¯</button>
            <button class="full-btn" style="background:#ddd; color:#333;" onclick="document.getElementById('action-confirm-modal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <script>
        const CONFIG = {
            firebase: { apiKey: "AIzaSyDJ8EWvicHqjvX-g1-19oS5h-VUQjRjtG8", authDomain: "abella-all.firebaseapp.com", databaseURL: "https://abella-all-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "abella-all", storageBucket: "abella-all.firebasestorage.app", messagingSenderId: "608492409476", appId: "1:608492409476:web:6d6ac8e85dd2fba1b328d1" },
            imgbbKey: "a7ec1c5e56839fcc6e0b6bda38257f05", adminPass: "fahd5",
            times: { OUT_NORM: 35 * 60000, OUT_TURBO: 30 * 60000, STAY_NORM: 25 * 60000, STAY_TURBO: 20 * 60000, TRAVEL: 15 * 60000, PREP_ALERT: 15 * 60000, CHECKING: 15 * 60000 }
        };

        if (!firebase.apps.length) firebase.initializeApp(CONFIG.firebase);
        const db = firebase.firestore();
        const dbRef = db.collection('abella_final_v6_hybrid').doc('master'); 

        // ==========================================================
        // ğŸ”¥ V8.5/V8.7: UI HELPER FUNCTIONS
        // ==========================================================
        
        // âœ… V8.5: Ø¯Ø§Ù„Ø© Ù„Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙÙ‚Ø·
        function closeAlert() {
            document.getElementById('action-confirm-modal').style.display = 'none';
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡
            const cancelBtn = document.getElementById('action-confirm-modal').querySelector('.full-btn[style*="#ddd"]');
            if (cancelBtn) cancelBtn.style.display = 'block'; 
        }

        function closeModal() { 
            document.querySelectorAll('.modal-overlay').forEach(el=>el.style.display='none'); 
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø¥Ø°Ø§ ØªÙ… Ø¥Ø®ÙØ§Ø¤Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© showAlert
            const cancelBtn = document.getElementById('action-confirm-modal').querySelector('.full-btn[style*="#ddd"]');
            if (cancelBtn) cancelBtn.style.display = 'block'; 
        }
        function openModal(id) { document.getElementById(id).style.display='flex'; }

        function setRoomType(type) {
            document.getElementById('inpRoomType').value = type;
            document.getElementById('opt_out').classList.remove('selected'); document.getElementById('opt_stay').classList.remove('selected');
            document.getElementById(`opt_${type}`).classList.add('selected'); app.updateAddModalUI();
        }
        function setGuestStatus(status) {
            document.getElementById('inpGuestStatus').value = status;
            document.getElementById('gst_in').classList.remove('selected'); document.getElementById('gst_out').classList.remove('selected');
            document.getElementById(`gst_${status}`).classList.add('selected'); app.updateTimeLabel();
        }
        function setDelayReason(reason) {
            document.getElementById('modal-delay').value = reason;
            ['dly_work', 'dly_room', 'dly_other'].forEach(id => document.getElementById(id).classList.remove('selected'));
            if(reason === 'Ø¶ØºØ· Ø¹Ù…Ù„') document.getElementById('dly_work').classList.add('selected');
            if(reason === 'Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„ØºØ±ÙØ©') document.getElementById('dly_room').classList.add('selected');
            if(reason === 'Ø³Ø¨Ø¨ Ø¢Ø®Ø±') document.getElementById('dly_other').classList.add('selected');
        }
        function setRoomStatus(status) {
            document.getElementById('modal-notes').value = status;
            document.getElementById('st_ready').classList.remove('selected'); document.getElementById('st_maint').classList.remove('selected', 'selected-maint');
            if(status === 'Ø¬Ø§Ù‡Ø²Ø©') document.getElementById('st_ready').classList.add('selected'); else document.getElementById('st_maint').classList.add('selected-maint');
            app.updateMaintenanceUI();
        }
        
        // âœ… V8.2/V8.3: Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© (Ù…Ù„ÙˆÙ†Ø©)
        function showAlert(message, type = 'warning') {
            const modal = document.getElementById('action-confirm-modal');
            let titleColor, icon, buttonColor;

            if (type === 'error') {
                titleColor = 'var(--danger)'; icon = 'âŒ Ø®Ø·Ø£'; buttonColor = 'var(--danger)';
            } else if (type === 'success') {
                titleColor = 'var(--success)'; icon = 'âœ… Ù†Ø¬Ø§Ø­'; buttonColor = 'var(--success)';
            } else { // warning (Ø§ÙØªØ±Ø§Ø¶ÙŠ)
                titleColor = 'var(--warning)'; icon = 'âš ï¸ Ø§Ù†ØªØ¨Ù‡'; buttonColor = 'var(--primary)';
            }

            document.getElementById('confirm-title').innerText = icon;
            document.getElementById('confirm-title').style.color = titleColor;
            document.getElementById('confirm-message').innerText = message;
            document.getElementById('confirm-yes-btn').innerText = 'Ø­Ø³Ù†Ø§Ù‹';
            document.getElementById('confirm-yes-btn').style.background = buttonColor;
            document.getElementById('confirm-yes-btn').onclick = () => closeAlert(); // ğŸ”¥ V8.5: Ø§Ø³ØªØ®Ø¯Ø§Ù… closeAlert Ù‡Ù†Ø§
            
            // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡
            const cancelBtn = modal.querySelector('.full-btn[style*="#ddd"]');
            if (cancelBtn) cancelBtn.style.display = 'none';

            openModal('action-confirm-modal');
        }

        // ==========================================================
        // CORE APP SYSTEM
        // ==========================================================

        class AppSystem {
            constructor() {
                const saved = localStorage.getItem('abella_hybrid_v6');
                this.state = saved ? JSON.parse(saved) : { rooms: [], log: [], history: {}, lastArchive: "", turbo: false };
                this.tempRoomId = null; this.pendingAction = null; this.audioCtx = null; this.searchText = "";
                this.touchStartY = 0; // V8.10: Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ù†Ù‚Ø·Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ù…Ø³
                this.init();
            }
            init() {
                this.render();
                // ğŸ”¥ V8.0: ØªØ­Ø³ÙŠÙ† ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                dbRef.onSnapshot(doc => { if (doc.exists) { this.state = doc.data(); this.saveLocally(); this.render(); } document.getElementById('sync-indicator').style.display = 'none'; });
                
                this.updateOnlineStatus(navigator.onLine);
                window.addEventListener('online', () => this.updateOnlineStatus(true));
                window.addEventListener('offline', () => this.updateOnlineStatus(false));

                setInterval(() => this.tick(), 1000); setInterval(() => this.checkAutoArchive(), 60000);
                window.addEventListener('click', () => { if (!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (this.audioCtx.state === 'suspended') this.audioCtx.resume(); }, { once: true });
            }
            save() { 
                this.saveLocally(); 
                document.getElementById('sync-indicator').style.display='block'; 
                dbRef.set(this.state)
                    .then(() => setTimeout(() => document.getElementById('sync-indicator').style.display = 'none', 500))
                    .catch(() => this.updateOnlineStatus(false)); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸
            }
            saveLocally() { localStorage.setItem('abella_hybrid_v6', JSON.stringify(this.state)); }

            updateOnlineStatus(isOnline) {
                 const badge = document.getElementById('offline-indicator-badge');
                 if(badge) badge.style.display = isOnline ? 'none' : 'block';
            }

            tick() {
                const now = Date.now(); let needSave = false, playPrep=false, playWarn=false, playLate=false;
                this.state.rooms.forEach(r => {
                    if (r.status === 'scheduled') { if (now >= r.startTime) { r.status = 'acknowledging'; needSave = true; playPrep = true; } }
                    else if (['cleaning', 'checking', 'acknowledging'].includes(r.status)) {
                        if (now > r.deadline && r.status !== 'overdue') { r.status = 'overdue'; needSave = true; playLate = true; }
                        const left = r.deadline - now; if (left > 0 && left < 120000 && Math.floor(left/1000) % 30 === 0) playWarn = true;
                    }
                    if (r.undoExpiry && now > r.undoExpiry) { delete r.undoExpiry; needSave = true; }
                });
                if (needSave) this.save();
                this.updateTimersDOM(); this.renderProgress(); this.renderUndoCountdowns();
                if (playPrep) this.playSound('prep'); else if (playLate) this.playSound('late'); else if (playWarn) this.playSound('warn');
            }

            renderUndoCountdowns() {
                this.state.rooms.forEach(r => {
                    const btn = document.getElementById(`undo-btn-${r.id}`);
                    if(btn && r.undoExpiry) {
                        const left = Math.ceil((r.undoExpiry - Date.now())/1000);
                        if(left <= 0) { btn.style.display='none'; return; }
                        btn.innerText = `ØªØ±Ø§Ø¬Ø¹ (${left}) â†©`;
                        if(left <= 5) { btn.classList.remove('active-anim'); btn.classList.add('urgent-anim'); }
                        else { btn.classList.add('active-anim'); btn.classList.remove('urgent-anim'); }
                    }
                });
            }

            checkDuplicate(val) {
                const el = document.getElementById('room-dup-alert'); if(!el) return; el.style.display = 'none'; if (!val) return;
                const active = this.state.rooms.find(r => r.num == val);
                if (active) { el.innerText = `â›” Ø§Ù„ØºØ±ÙØ© Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ (${active.status})`; el.style.background = '#ffebee'; el.style.color = '#c62828'; el.style.display = 'block'; return; }
                const done = this.state.log.find(l => r.num == val);
                if (done) { const ft = done.history && done.history.length > 0 ? done.history[done.history.length - 1].time : done.time; el.innerText = `âš ï¸ ØªÙ… Ø¥Ù†Ø¬Ø§Ø²Ù‡Ø§ Ø§Ù„ÙŠÙˆÙ… ${ft}`; el.style.background = '#fff3e0'; el.style.color = '#ef6c00'; el.style.display = 'block'; }
            }

            addNewRoom() {
                const num = document.getElementById('inpRoomNum').value; const type = document.getElementById('inpRoomType').value; const isSuper = document.getElementById('inpSuperTurbo').checked;
                if(!num || !type) return showAlert('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ© ÙˆØ­Ø§Ù„ØªÙ‡Ø§.', 'warning');
                const r = { id: Date.now(), num, type, status: 'acknowledging', startTime: Date.now(), deadline: Date.now() + CONFIG.times.TRAVEL, guestStatus: 'out', undoExpiry: Date.now() + 15000, historyLogs: [], isSuperTurbo: isSuper, isNew: true }; // V8.10: Ø¥Ø¶Ø§ÙØ© isNew
                // V8.9: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ 24 Ø³Ø§Ø¹Ø© Ù„Ù„Ø³Ø¬Ù„
                r.historyLogs.push({ action: 'Ø¯Ø®ÙˆÙ„', time: new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }) });
                let waMsg = "";
                
                if(type === 'out') waMsg = `*Ø¥Ø¶Ø§ÙØ© ØºØ±ÙØ© Ø®Ø±ÙˆØ¬*\nØ±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©: ${num}\nÙ†Ø¸Ø§ÙØ© Ø¹Ø§Ø¬Ù„Ø©!`;
                else { 
                    const gStat = document.getElementById('inpGuestStatus').value; 
                    // ğŸ”¥ V8.9: Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                    const hVal = document.getElementById('inpHourValue').value;
                    const mVal = document.getElementById('inpMinuteValue').value;
                    const period = document.getElementById('inpPeriodValue').value;

                    const displayTime = `${hVal.padStart(2,'0')}:${mVal.padStart(2,'0')} ${period === 'AM' ? 'ØµØ¨Ø§Ø­Ø§Ù‹' : 'Ù…Ø³Ø§Ø¡Ù‹'}`;
                    
                    if(gStat === 'in') waMsg = `*Ø¥Ø¶Ø§ÙØ© Ø³Ø§ÙƒÙ† (Ø¨Ø§Ù„Ø¯Ø§Ø®Ù„)*\nØ±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©: ${num}\nÙŠØ·Ù„Ø¨ Ù†Ø¸Ø§ÙØ© Ø§Ù„Ø³Ø§Ø¹Ø©: ${displayTime}`; 
                    else waMsg = `*Ø¥Ø¶Ø§ÙØ© Ø³Ø§ÙƒÙ† (Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬)*\nØ±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©: ${num}\nÙŠØ¹ÙˆØ¯ Ø§Ù„Ø³Ø§Ø¹Ø©: ${displayTime}`; 

                    // V8.7: ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø§Ù„Ø³Ø¬Ù„ Ù„ÙŠØ¹ÙƒØ³ AM/PM
                    r.schedTime = displayTime; 
                }

                window.open(`https://wa.me/?text=${encodeURIComponent(waMsg)}`, '_blank');
                
                if(type === 'stay') {
                    const gStat = document.getElementById('inpGuestStatus').value; 
                    // ğŸ”¥ V8.9: Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                    let h = parseInt(document.getElementById('inpHourValue').value);
                    const m = parseInt(document.getElementById('inpMinuteValue').value);
                    const period = document.getElementById('inpPeriodValue').value;

                    // ğŸ”¥ V8.7/V8.9: ØªØ­ÙˆÙŠÙ„ ÙˆÙ‚Øª 12 Ø³Ø§Ø¹Ø© Ù…Ø¹ AM/PM Ø¥Ù„Ù‰ 24 Ø³Ø§Ø¹Ø© Ù„Ù€ Timestamp
                    if (period === 'PM' && h !== 12) h += 12;
                    if (period === 'AM' && h === 12) h = 0; // 12:xx AM Ù‡Ùˆ 00:xx

                    const d = new Date(); 
                    d.setHours(h, m, 0, 0); 
                    
                    let targetTs = d.getTime(); 
                    if (targetTs < Date.now() - 3600000) targetTs += 86400000; // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„Ù…Ø§Ø¶ÙŠØŒ ÙØ§ÙØªØ±Ø¶ Ø£Ù†Ù‡ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ØªØ§Ù„ÙŠ

                    r.guestStatus = gStat; 
                    // r.schedTime ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¨Ø§Ù„ÙØ¹Ù„ Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰
                    
                    if (gStat === 'out') { 
                        r.startTime = targetTs - CONFIG.times.PREP_ALERT; 
                        r.status = (r.startTime > Date.now()) ? 'scheduled' : 'acknowledging'; 
                    }
                    else { 
                        r.startTime = targetTs; 
                        r.status = (r.startTime > Date.now()) ? 'scheduled' : 'acknowledging'; 
                    }
                }
                this.state.rooms.push(r); 
                this.save(); 
                closeModal();
                
                // V8.10: Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„Ø§Ø³ isNew Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
                setTimeout(() => {
                    const room = this.state.rooms.find(x => x.id === r.id);
                    if (room) {
                        delete room.isNew;
                        this.save();
                    }
                }, 5000);
                
                document.getElementById('inpRoomNum').value = ''; document.getElementById('room-dup-alert').style.display = 'none';
                document.getElementById('inpRoomType').value = ''; document.getElementById('opt_out').classList.remove('selected'); document.getElementById('opt_stay').classList.remove('selected'); document.getElementById('inpSuperTurbo').checked = false;
            }

            promptAction(id, type) {
                this.tempRoomId = id; const msgs = { 'ack': 'Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ†Ø¸ÙŠÙØŸ', 'clean': 'Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­ØµØŸ' };
                document.getElementById('confirm-message').innerText = msgs[type];
                document.getElementById('confirm-yes-btn').innerText = 'Ù†Ø¹Ù…ØŒ Ø£Ø¤ÙƒØ¯'; // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø²Ø± Ù„Ø£ØµÙ„Ù‡ Ù‚Ø¨Ù„ Ø§Ù„ÙØªØ­
                document.getElementById('confirm-yes-btn').style.background = 'var(--success)';
                document.getElementById('confirm-yes-btn').onclick = () => this.executePhase(id, type);
                document.getElementById('confirm-title').innerText = 'ØªØ£ÙƒÙŠØ¯';
                document.getElementById('confirm-title').style.color = 'var(--danger)';
                
                openModal('action-confirm-modal');
            }

            executePhase(id, type) {
                document.getElementById('action-confirm-modal').style.display = 'none'; const r = this.state.rooms.find(x => x.id === id); if (!r) return; const now = Date.now();
                if (type === 'ack') { r.status = 'cleaning'; r.startTime = now; let dur = this.state.turbo ? CONFIG.times.OUT_TURBO : CONFIG.times.OUT_NORM; if(r.type === 'stay') dur = this.state.turbo ? CONFIG.times.STAY_TURBO : CONFIG.times.STAY_NORM; if(r.isSuperTurbo) dur -= (5 * 60000); r.deadline = now + dur; if(!r.historyLogs) r.historyLogs=[]; r.historyLogs.push({ action: 'Ø¨Ø¯Ø¡ ØªÙ†Ø¸ÙŠÙ', time: new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }) }); } 
                else if (type === 'clean') { r.status = 'checking'; r.startTime = now; r.deadline = now + CONFIG.times.CHECKING; r.historyLogs.push({ action: 'ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ', time: new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }) }); }
                else if (type === 'finish') { this.openFinishModal(id); return; }
                r.undoExpiry = now + 15000; this.save();
            }

            promptStart(id) { window.tempRoomId = id; if (this.state.turbo) this.commitStart(true); else document.getElementById('rain-prompt-modal').style.display = 'flex'; }
            commitStart(isTurbo) { document.getElementById('rain-prompt-modal').style.display = 'none'; const r = this.state.rooms.find(x => x.id === window.tempRoomId); if(r) { r.status = 'acknowledging'; r.startTime = Date.now(); r.deadline = Date.now() + CONFIG.times.TRAVEL; r.undoExpiry = Date.now() + 15000; this.save(); } }

            openFinishModal(id) {
                window.activeRoomId = id; const r = this.state.rooms.find(x => x.id === id);
                document.getElementById('modal-title-text').innerText = `ğŸ“ ØªÙ‚Ø±ÙŠØ± ÙØ­Øµ Ø§Ù„ØºØ±ÙØ©`;
                const isLate = r.status === 'overdue';
                document.getElementById('delay-reason-section').style.display = isLate ? 'block' : 'none';
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ£Ø®ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
                document.getElementById('modal-delay').value = '';
                ['dly_work', 'dly_room', 'dly_other'].forEach(el => document.getElementById(el).classList.remove('selected'));
                
                // ØªÙØ±ÙŠØº Ø­Ù‚ÙˆÙ„ Ø§Ù„ØµÙŠØ§Ù†Ø© (ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù…Ø³Ø¨Ù‚Ø§Ù‹)
                document.getElementById('repair-details-input').value = '';
                document.getElementById('modal-img-camera-input').value = '';
                
                // âœ… V8.1/V8.2: Ø¥ØµÙ„Ø§Ø­ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¨ØµØ±ÙŠØ§Ù‹
                setRoomStatus('Ø¬Ø§Ù‡Ø²Ø©'); 
                
                document.getElementById('inpSendWhatsapp').checked = true;
                document.getElementById('final-modal').style.display = 'flex';
            }

            async submitFinish() {
                const r = this.state.rooms.find(x => x.id === window.activeRoomId); const status = document.getElementById('modal-notes').value; const isLate = document.getElementById('delay-reason-section').style.display === 'block'; const delayReason = document.getElementById('modal-delay').value; const shouldSendWhatsapp = document.getElementById('inpSendWhatsapp').checked;
                if (isLate && !delayReason) return showAlert('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø³Ø¨Ø¨ Ø§Ù„ØªØ£Ø®ÙŠØ± Ù„Ø£Ù†Ù‡ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ.', 'error');
                let maintData = { desc: '', img: '' };
                if (status === 'ØªØ­ØªØ§Ø¬ ØµÙŠØ§Ù†Ø©') {
                    const desc = document.getElementById('repair-details-input').value; const file = document.getElementById('modal-img-camera-input').files[0];
                    if (!desc || !file) return showAlert('Ù…Ø·Ù„ÙˆØ¨ ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„ ÙˆØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„ Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„ØµÙŠØ§Ù†Ø©.', 'error');
                    const btn = document.getElementById('btn_confirm_finish'); btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...'; btn.disabled = true;
                    const imgUrl = await this.uploadToImgBB(file);
                    if (!imgUrl) { btn.disabled = false; return showAlert('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù€ ImgBB. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error'); }
                    maintData = { desc, img: imgUrl };
                }
                r.historyLogs.push({ action: 'ØªÙˆØ«ÙŠÙ‚', time: new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }) });
                const logEntry = { num: r.num, type: r.type, status: status, history: r.historyLogs, isLate, delayReason: isLate ? delayReason : '', maintDesc: maintData.desc, maintImg: maintData.img };
                this.state.log.unshift(logEntry); this.state.rooms = this.state.rooms.filter(x => x.id !== r.id); this.save(); closeModal();
                document.getElementById('btn_confirm_finish').innerText = 'ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„'; document.getElementById('btn_confirm_finish').disabled = false;
                if (shouldSendWhatsapp) {
                    let hist = logEntry.history.map(h => `${h.action}: ${h.time}`).join('\n'); let waMsg = `*ØªÙ‚Ø±ÙŠØ± ØºØ±ÙØ© ${logEntry.num}*\n----------------\n${hist}\n----------------\nØ§Ù„Ø­Ø§Ù„Ø©: ${status}`;
                    if(isLate) waMsg += `\nâš ï¸ ØªØ£Ø®ÙŠØ±: ${delayReason}`; if(maintData.desc) waMsg += `\nğŸ› ï¸ Ø¹Ø·Ù„: ${maintData.desc}\nğŸ“ ${maintData.img}`;
                    window.open(`https://wa.me/?text=${encodeURIComponent(waMsg)}`, '_blank');
                }
            }

            render() {
                const container = document.getElementById('rooms-container');
                let active = this.state.rooms.filter(r => r.num.includes(this.searchText));
                active.sort((a, b) => { const score = r => r.status === 'overdue' ? 0 : (r.status === 'scheduled' ? 2 : 1); if (score(a) !== score(b)) return score(a) - score(b); return (a.deadline - Date.now()) - (b.deadline - Date.now()); });
                container.innerHTML = active.map(r => {
                    const isSch = r.status === 'scheduled'; const badge = r.type==='out'?'Ø®Ø±ÙˆØ¬':(r.guestStatus==='in'?'Ù†Ø²ÙŠÙ„ Ø¯Ø§Ø®Ù„':'Ù†Ø²ÙŠÙ„ Ø®Ø§Ø±Ø¬');
                    const undoLeft = r.undoExpiry ? Math.ceil((r.undoExpiry - Date.now())/1000) : 0;
                    const isUrgent = undoLeft > 0 && undoLeft <= 5;
                    const undoBtn = r.undoExpiry ? `<button id="undo-btn-${r.id}" class="btn-undo ${undoLeft > 0 ? (isUrgent ? 'urgent-anim' : 'active-anim') : ''}" onclick="undo(${r.id})">ØªØ±Ø§Ø¬Ø¹ (${undoLeft}) â†©</button>` : '';
                    let actionBtn = '';
                    if(isSch) actionBtn = `<button class="btn-action btn-start" onclick="promptStart(${r.id})">Ø¨Ø¯Ø¡ Ø§Ù„Ø¢Ù†</button>`;
                    else if (r.status === 'acknowledging') actionBtn = `<button class="btn-action btn-start" onclick="promptAction(${r.id}, 'ack')">ÙˆØµÙ„Øª Ù„Ù„ØºØ±ÙØ© ğŸƒ</button>`;
                    else if (r.status === 'cleaning') actionBtn = `<button class="btn-action btn-clean-done" onclick="promptAction(${r.id}, 'clean')">ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ ğŸ§¹</button>`;
                    else if (r.status === 'checking') actionBtn = `<button class="btn-action btn-finish" onclick="openFinishModal(${r.id})">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØªÙˆØ«ÙŠÙ‚ âœ…</button>`;
                    else if (r.status === 'overdue') actionBtn = `<button class="btn-action btn-finish" style="background:var(--danger)" onclick="openFinishModal(${r.id})">Ø¥Ù†Ù‡Ø§Ø¡ (ØªØ£Ø®ÙŠØ±)</button>`;
                    
                    // V8.10: Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ø§Ù„ØªÙ…ÙŠÙŠØ² Ù„Ù„ØºØ±Ù Ø§Ù„Ù…Ù†Ø´Ø£Ø© Ø­Ø¯ÙŠØ«Ø§Ù‹
                    const newClass = r.isNew ? ' status-newly-added' : '';

                    return `<div class="room-row status-${r.status}${newClass}"><div class="timer-display" id="timer-${r.id}">--:--</div><div style="text-align:center"><div style="font-weight:800; font-size:1.2rem;">${r.num}</div></div><div style="text-align:center"><span class="badge">${badge}</span>${isSch ? `<div class="timer-sched">ÙˆÙ‚Øª: ${r.schedTime}</div>` : ''}${r.isSuperTurbo ? '<span style="color:#ef6c00; font-size:0.6rem;">ğŸš€ Ø³ÙˆØ¨Ø± ØªÙŠØ±Ø¨Ùˆ</span>' : ''}</div><div style="display:flex; flex-direction:column; gap:2px;">${actionBtn}${undoBtn}</div></div>`;
                }).join('');
                this.renderLog(); this.updateStats(); this.updateTimersDOM(); this.renderProgress(); this.renderUndoCountdowns();
                document.getElementById('turbo-mode-btn').style.background = this.state.turbo ? "var(--danger)" : "var(--success)";
                document.getElementById('rain-mode-indicator').style.display = this.state.turbo ? 'block' : 'none';
            }

            renderProgress() {
                const active = this.state.rooms.filter(r => ['acknowledging','cleaning','checking','overdue'].includes(r.status));
                const container = document.getElementById('progressSection'); if (active.length === 0) { container.style.display = 'none'; return; } container.style.display = 'block';
                active.sort((a, b) => (a.deadline - Date.now()) - (b.deadline - Date.now()));
                container.innerHTML = active.map(r => {
                    let total = CONFIG.times.TRAVEL;
                    if (r.status === 'cleaning') { total = this.state.turbo ? CONFIG.times.OUT_TURBO : CONFIG.times.OUT_NORM; if(r.isSuperTurbo) total -= (5 * 60000); }
                    if (r.status === 'checking') total = CONFIG.times.CHECKING;
                    const elapsed = Date.now() - r.startTime; const pct = Math.min(100, (elapsed/total)*100);
                    let color = 'var(--primary)'; 
                    let label = 'ØªÙ†Ø¸ÙŠÙ';
                    // ğŸ”¥ V8.8: Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
                    let icon = 'ğŸ§¹';

                    if (r.status === 'acknowledging') { color = 'var(--upgrade)'; label = 'Ø§Ù†ØªÙ‚Ø§Ù„'; icon = 'ğŸƒ'; } 
                    else if (r.status === 'checking') { color = 'var(--warning)'; label = 'ÙØ­Øµ'; icon = 'ğŸ”'; } 
                    else if (r.status === 'overdue') { color = 'var(--danger)'; label = 'ØªØ£Ø®ÙŠØ±'; icon = 'ğŸš¨'; }
                    
                    return `<div style="display:flex; align-items:center; margin-bottom:5px; background:var(--bg-card); padding:5px; border-radius:8px; border:1px solid var(--border-color);"><div style="font-weight:bold; font-size:0.8rem; width:40px;">${r.num}</div><div style="flex:1; height:8px; background:var(--bg-body); border-radius:4px; margin:0 10px; overflow:hidden;"><div style="height:100%; width:${pct}%; background:${color}; transition:width 1s linear;"></div></div><div style="font-size:0.7rem; color:${color}; font-weight:bold;">${icon} ${label}</div></div>`;
                }).join('');
            }

            updateTimersDOM() { this.state.rooms.forEach(r => { const el = document.getElementById(`timer-${r.id}`); if (!el) return; if (r.status === 'scheduled') { el.innerText = 'Ù…Ø¬Ø¯ÙˆÙ„'; el.style.color='#999'; return; } const diff = r.deadline - Date.now(); const m = Math.floor(Math.abs(diff)/60000); const s = Math.floor((Math.abs(diff)%60000)/1000); el.innerText = `${diff<0?'+':''}${m}:${s.toString().padStart(2,'0')}`; el.className = `timer-display ${diff<0?'timer-danger':'timer-active'}`; }); }
            renderLog() {
                const list = document.getElementById('worker-log-list'); if(!this.state.log.length) { list.innerHTML='<p style="text-align:center;color:var(--text-sec)">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„</p>'; return; }
                list.innerHTML = this.state.log.map(l => {
                    let historyText = l.history ? l.history.map(h => `${h.action}: ${h.time}`).join(' | ') : `ÙˆÙ‚Øª: ${l.time}`;
                    return `<div style="border-bottom:1px solid var(--border-color); padding:8px; display:flex; flex-direction:column;"><div style="display:flex; justify-content:space-between; align-items:center;"><div><strong>${l.num}</strong>${l.isLate ? '<span style="color:var(--danger); font-size:0.7rem"> (ØªØ£Ø®ÙŠØ±)</span>' : ''}</div><div style="text-align:left"><span class="badge">${l.status}</span></div></div><div style="font-size:0.65rem; color:var(--text-sec); margin-top:4px;">${historyText}</div>${l.maintImg ? `<a href="${l.maintImg}" target="_blank" style="font-size:0.7rem; display:block; color:var(--primary); margin-top:2px;">ğŸ“· ØµÙˆØ±Ø©</a>` : ''}</div>`;
                }).join('');
            }
            updateStats() {
                document.getElementById('stat-active').innerText = this.state.rooms.filter(r => r.status!=='scheduled').length; document.getElementById('stat-late').innerText = this.state.rooms.filter(r => r.status==='overdue').length; document.getElementById('stat-completed').innerText = this.state.log.length; document.getElementById('stat-out-done').innerText = this.state.log.filter(l => l.type === 'out').length; document.getElementById('stat-stay-done').innerText = this.state.log.filter(l => l.type === 'stay').length;
            }
            undo(id) { const r = this.state.rooms.find(x => x.id === id); if(r && r.undoExpiry) { this.state.rooms = this.state.rooms.filter(x => x.id !== id); this.save(); } }
            toggleTurboMode() { this.state.turbo = !this.state.turbo; this.save(); this.render(); }
            updateAddModalUI() { const t = document.getElementById('inpRoomType').value; document.getElementById('stayOptions').style.display = t === 'stay' ? 'block' : 'none'; }
            updateTimeLabel() { const s = document.getElementById('inpGuestStatus').value; document.getElementById('lblTime').innerText = s === 'out' ? 'ÙˆÙ‚Øª Ø¹ÙˆØ¯Ø© Ø§Ù„Ù†Ø²ÙŠÙ„' : 'ÙˆÙ‚Øª Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨'; }
            updateMaintenanceUI() { const val = document.getElementById('modal-notes').value; document.getElementById('maintenance-fields').style.display = val === 'ØªØ­ØªØ§Ø¬ ØµÙŠØ§Ù†Ø©' ? 'block' : 'none'; }
            updateSearch(val) { this.searchText = val; this.render(); }
            async uploadToImgBB(file) { return new Promise(resolve => { const reader = new FileReader(); reader.onload = e => { const img = new Image(); img.onload = () => { const c = document.createElement('canvas'); const ctx = c.getContext('2d'); const sc = 800/Math.max(img.width,800); c.width = img.width*sc; c.height = img.height*sc; ctx.drawImage(img,0,0,c.width,c.height); c.toBlob(blob => { const fd = new FormData(); fd.append('image', blob); fetch(`https://api.imgbb.com/1/upload?key=${CONFIG.imgbbKey}`, {method:'POST', body:fd}).then(r=>r.json()).then(d=>resolve(d.data.url)).catch(()=>resolve(null)); }, 'image/jpeg', 0.8); }; img.src = e.target.result; }; reader.readAsDataURL(file); }); }

            // ğŸ”¥ V8.10: Ø¯ÙˆØ§Ù„ ØªÙØ§Ø¹Ù„ Ø§Ù„Ù„Ù…Ø³ (Swipe)
            handleTouchStart(e, part) {
                // Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„ØµÙØ­Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ù…Ø³ Ø¹Ù„Ù‰ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¹Ø©
                e.preventDefault(); 
                this.touchStartY = e.touches[0].clientY; 
                this.touchTargetPart = part; // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (hour/minute)
            }
            
            handleTouchEnd(e, part) {
                // ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø­Ø¯Ø« Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù‡Ø¯Ù Ø£Ùˆ Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ù†Ù‚Ø·Ø© Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù„Ù…Ø³
                if (!this.touchStartY || this.touchTargetPart !== part) return;
                
                const touchEndY = e.changedTouches[0].clientY;
                const deltaY = touchEndY - this.touchStartY;
                const sensitivity = 15; // Ø¹Ø¯Ø¯ Ø§Ù„Ø¨ÙƒØ³Ù„Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨
                
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®Ø·ÙˆØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø²Ø¡
                const step = (part === 'hour') ? 1 : 5; 
                
                if (Math.abs(deltaY) > sensitivity) {
                    if (deltaY < 0) { // Ø³Ø­Ø¨ Ù„Ù„Ø£Ø¹Ù„Ù‰ (Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø©)
                        this.changeTimeValue(part, step);
                    } else { // Ø³Ø­Ø¨ Ù„Ù„Ø£Ø³ÙÙ„ (Ø¥Ù†Ù‚Ø§Øµ Ø§Ù„Ù‚ÙŠÙ…Ø©)
                        this.changeTimeValue(part, -step);
                    }
                } else {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙØ±Ù‚ ØµØºÙŠØ±Ø§Ù‹ Ø¬Ø¯Ø§Ù‹ØŒ ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡ ÙƒÙ†Ù‚Ø±Ø© Ø¹Ø§Ø¯ÙŠØ©
                    if(part === 'hour') this.changeTimeValue('hour', 1);
                    else if (part === 'minute') this.changeTimeValue('minute', 5);
                }
                
                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
                this.touchStartY = 0;
                this.touchTargetPart = null;
            }

            // ğŸ”¥ V8.9/V8.10: Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            initTimeFields() {
                const now = new Date();
                let hours = now.getHours();
                const minutes = Math.floor(now.getMinutes() / 5) * 5; // ØªÙ‚Ø±ÙŠØ¨ Ù„Ø£Ù‚Ø±Ø¨ 5 Ø¯Ù‚Ø§Ø¦Ù‚
                let period = 'AM';

                if (hours >= 12) { period = 'PM'; hours = hours - 12; }
                if (hours === 0) hours = 12; // 00:xx ØªØµØ¨Ø­ 12:xx AM
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø®ÙÙŠØ©
                document.getElementById('inpHourValue').value = hours;
                document.getElementById('inpMinuteValue').value = minutes;
                document.getElementById('inpPeriodValue').value = period;

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©
                document.getElementById('inpHour').innerText = hours.toString().padStart(2, '0');
                document.getElementById('inpMinute').innerText = minutes.toString().padStart(2, '0');
                document.getElementById('inpPeriodText').innerText = period === 'AM' ? 'ØµØ¨Ø§Ø­Ø§Ù‹' : 'Ù…Ø³Ø§Ø¡Ù‹';
                
                // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¨Ø´ÙƒÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ
                document.getElementById('hourBox').classList.add('active');
                document.getElementById('minuteBox').classList.remove('active');
                document.getElementById('periodBox').classList.remove('active');
            }

            changeTimeValue(part, step) {
                const hVal = parseInt(document.getElementById('inpHourValue').value);
                const mVal = parseInt(document.getElementById('inpMinuteValue').value);
                
                let newValue, isHour = part === 'hour';

                if(isHour) {
                    newValue = hVal + step;
                    if(newValue > 12) newValue = 1;
                    if(newValue < 1) newValue = 12;
                    document.getElementById('inpHourValue').value = newValue;
                    document.getElementById('inpHour').innerText = newValue.toString().padStart(2, '0');

                    // ØªÙØ¹ÙŠÙ„ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø³Ø§Ø¹Ø©
                    document.getElementById('hourBox').classList.add('active');
                    document.getElementById('minuteBox').classList.remove('active');
                    document.getElementById('periodBox').classList.remove('active');

                } else if (part === 'minute') {
                    newValue = mVal + step;
                    if(newValue >= 60) newValue = newValue % 60; // ÙŠØ¨Ø¯Ø£ Ù…Ù† 0
                    if(newValue < 0) newValue = 55;
                    document.getElementById('inpMinuteValue').value = newValue;
                    document.getElementById('inpMinute').innerText = newValue.toString().padStart(2, '0');
                    
                    // ØªÙØ¹ÙŠÙ„ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©
                    document.getElementById('minuteBox').classList.add('active');
                    document.getElementById('hourBox').classList.remove('active');
                    document.getElementById('periodBox').classList.remove('active');
                }
                
                // ğŸ”¥ V8.10: Ø¥Ø¶Ø§ÙØ© Ø§Ù‡ØªØ²Ø§Ø² ÙˆØµÙˆØª
                if (navigator.vibrate) navigator.vibrate(50); 
                this.playSound('prep'); 
            }
            
            togglePeriod() {
                const pVal = document.getElementById('inpPeriodValue');
                const pTxt = document.getElementById('inpPeriodText');
                
                const newPeriod = pVal.value === 'AM' ? 'PM' : 'AM';
                pVal.value = newPeriod;
                pTxt.innerText = newPeriod === 'AM' ? 'ØµØ¨Ø§Ø­Ø§Ù‹' : 'Ù…Ø³Ø§Ø¡Ù‹';

                // ØªÙØ¹ÙŠÙ„ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙØªØ±Ø©
                document.getElementById('periodBox').classList.add('active');
                document.getElementById('minuteBox').classList.remove('active');
                document.getElementById('hourBox').classList.remove('active');
                
                // ğŸ”¥ V8.10: Ø§Ù‡ØªØ²Ø§Ø² ÙˆØµÙˆØª Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙØªØ±Ø©
                if (navigator.vibrate) navigator.vibrate(50);
                this.playSound('prep');
            }

            openAddModal() { 
                document.getElementById('inpRoomNum').value = '';
                // V8.9: ØªÙ‡ÙŠØ¦Ø© Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ
                this.initTimeFields();
                document.getElementById('stayOptions').style.display = 'none'; 
                document.getElementById('room-dup-alert').style.display = 'none'; 
                document.getElementById('inpSuperTurbo').checked = false; 
                document.getElementById('inpRoomType').value = ''; 
                document.getElementById('opt_out').classList.remove('selected'); 
                document.getElementById('opt_stay').classList.remove('selected'); 
                openModal('addRoomModal'); 
            }
            showResetModal() { this.pendingAction='archive'; document.getElementById('admin-password').value=''; document.getElementById('password-modal').style.display='flex'; }
            showLogClearModal() { this.pendingAction='clearLog'; document.getElementById('admin-password').value=''; document.getElementById('password-modal').style.display='flex'; }
            checkPasswordAndAction() { if(document.getElementById('admin-password').value === CONFIG.adminPass) { if(this.pendingAction==='clearLog') this.state.log = []; else if(this.pendingAction==='archive') this.doArchive(new Date().toLocaleDateString('en-GB')); this.save(); closeModal(); } else showAlert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.', 'error'); }
            checkAutoArchive() { const now = new Date(); const today = now.toLocaleDateString('en-GB'); if(now.getHours() === 5 && this.state.lastArchive !== today) this.doArchive(today); }
            doArchive(d) { if(!this.state.log.length) { this.state.lastArchive=d; this.save(); return; } const yest = new Date(Date.now()-86400000).toLocaleDateString('ar-EG'); if(!this.state.history) this.state.history={}; this.state.history[`Ø³Ø¬Ù„ ${yest}`] = [...this.state.log]; this.state.log=[]; this.state.lastArchive=d; this.save(); }
            playSound(type) { if(!this.audioCtx) return; const o = this.audioCtx.createOscillator(); const g = this.audioCtx.createGain(); o.connect(g); g.connect(this.audioCtx.destination); if(type==='prep') { o.freq=600; g.gain=0.5; o.start(); o.stop(this.audioCtx.currentTime+0.1); } else if(type==='late') { o.type='sawtooth'; o.freq=150; o.start(); o.stop(this.audioCtx.currentTime+0.5); } }
        }

        const app = new AppSystem();

        // ==========================================================
        // ğŸ”¥ V8.3: GLOBAL WRAPPERS (Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø§Ù„Ù€ onclick)
        // ==========================================================
        
        function toggleTurboMode() { app.toggleTurboMode(); }
        function showResetModal() { app.showResetModal(); }
        function showLogClearModal() { app.showLogClearModal(); }
        function openAddModal() { app.openAddModal(); }
        function addNewRoom() { app.addNewRoom(); }
        function commitStartRoom(id, turbo) { app.commitStart(turbo); }
        function updateMaintenanceUI() { app.updateMaintenanceUI(); }
        function updateSearch(val) { app.updateSearch(val); }
        function confirmFinishRoom() { app.submitFinish(); }
        function checkPasswordAndAction() { app.checkPasswordAndAction(); }
        function promptAction(id, type) { app.promptAction(id, type); }
        function promptStart(id) { app.promptStart(id); }
        function undo(id) { app.undo(id); }
        function checkDuplicate(val) { app.checkDuplicate(val); }
        function openFinishModal(id) { app.openFinishModal(id); } 

        function generateDailyReport() {
            let msg = `*ØªÙ‚Ø±ÙŠØ± Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© - ${new Date().toLocaleDateString('ar-EG')}*%0A`;
            msg += `--------------------------------%0A`;
            
            app.state.log.forEach(l => {
                const findTime = (actionPart) => {
                    const h = l.history ? l.history.find(x => x.action.includes(actionPart)) : null;
                    return h ? h.time : '--';
                };
                
                // V8.9: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ 24 Ø³Ø§Ø¹Ø© Ø§Ù„Ù…ÙˆØ­Ø¯
                const tEntry = findTime('Ø¯Ø®ÙˆÙ„');
                const tClean = findTime('Ø¨Ø¯Ø¡ ØªÙ†Ø¸ÙŠÙ');
                const tCheck = findTime('ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ'); 
                
                msg += `ğŸ”¹ *ØºØ±ÙØ© ${l.num}* (${l.type === 'out' ? 'Ø®Ø±ÙˆØ¬' : 'Ø³Ø§ÙƒÙ†'})%0A`;
                msg += `   - Ø¯Ø®ÙˆÙ„: ${tEntry} | ØªÙ†Ø¸ÙŠÙ: ${tClean} | ÙØ­Øµ: ${tCheck}%0A`;
                
                if(l.status === 'ØªØ­ØªØ§Ø¬ ØµÙŠØ§Ù†Ø©') msg += `\nğŸ› ï¸ Ø§Ù„Ø­Ø§Ù„Ø©: ØªØ­ØªØ§Ø¬ ØµÙŠØ§Ù†Ø©`;
                else msg += `\nâœ… Ø§Ù„Ø­Ø§Ù„Ø©: Ø¬Ø§Ù‡Ø²Ø©`;

                if(l.isLate) msg += `\nâš ï¸ ØªØ£Ø®ÙŠØ±: ${l.delayReason}`;
                if(l.maintDesc) msg += `\nğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©: ${l.maintDesc}`;
                
                msg += `--------------------------------%0A`;
            });
            
            const totalOut = app.state.log.filter(x => x.type === 'out').length;
            const totalStay = app.state.log.filter(x => x.type === 'stay').length;
            msg += `ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø®Ø±ÙˆØ¬: ${totalOut} | Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§ÙƒÙ†: ${totalStay}`;

            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }
    </script>
</body>
</html>
