<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Adora | Ù…ØªØ§Ø¨Ø¹Ø© ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <script>
        // --- 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ÙˆØ§Ù„Ù‡Ø§Ø´ Ø§Ù„Ø£Ù…Ù†ÙŠ ---
        const firebaseConfig = {
            apiKey: "AIzaSyD1rY9BUciB0ir1b8begsPozpJzgwnR-Z0",
            authDomain: "adora-staff5255.firebaseapp.com",
            projectId: "adora-staff5255",
            storageBucket: "adora-staff5255.firebasestorage.app",
            messagingSenderId: "96309381730",
            appId: "1:96309381730:web:d24e0d275255347e43df3b"
        };
        
        // Ø¯Ø§Ù„Ø© Ø§Ù„Ù‡Ø§Ø´ Ø§Ù„Ø¨Ø³ÙŠØ·Ø© (Ù„Ø¹Ø¯Ù… ÙƒØ´Ù Ø§Ù„Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯ ÙƒÙ†Øµ ØµØ±ÙŠØ­)
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = (hash << 5) - hash + char;
                hash = hash & hash; 
            }
            return hash;
        }

        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase Connected (Adora-5255).");
        } catch(e) {
            console.error("Firebase Init Error:", e);
            alert("Ø®Ø·Ø£: ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
        }
    </script>

    <style>
        /* ======================== CSS Styles ======================== */
        :root { 
            --bg-body: #f0f2f5; --bg-card: #ffffff; --text-main: #1f2937; --text-sec: #6b7280; 
            --border-color: #e5e7eb; 
            --primary: #0097a7; --primary-glass: rgba(0, 151, 167, 0.15);
            --success: #10b981; --success-glass: rgba(16, 185, 129, 0.2);
            --danger: #ef4444; --danger-glass: rgba(239, 68, 68, 0.15);
            --warning: #f59e0b; --warning-glass: rgba(245, 158, 11, 0.15);
            --upgrade: #8b5cf6; 
            --request-color: #6366f1; --request-glass: rgba(99, 102, 241, 0.15);
            --sched-color: #3b82f6; --sched-glass: rgba(59, 130, 246, 0.1);
            --maint-color: #be123c; --maint-glass: rgba(190, 18, 60, 0.1);
            --shadow: 0 4px 20px rgba(0,0,0,0.06); 
        }
        body.dark-mode { 
            --bg-body: #111827; --bg-card: #1f2937; --text-main: #f9fafb; --text-sec: #9ca3af; 
            --border-color: #374151; --maint-color: #f43f5e; --shadow: 0 10px 30px rgba(0,0,0,0.5); 
        }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 15px 15px 80px 15px; -webkit-tap-highlight-color: transparent; transition: background 0.3s; }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* Header & Tools */
        .header-glass { position: relative; z-index: 50; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 24px; padding: 12px 18px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); }
        .header-right h1 { font-size: 1.3rem; margin: 0; color: var(--primary); font-weight: 800; display:flex; align-items:center; gap:8px; }
        .header-left { display: flex; gap: 8px; align-items: center; background: var(--bg-body); padding: 5px; border-radius: 18px; border: 1px solid var(--border-color); }
        .tools-btn { background: transparent; border: none; padding: 8px; border-radius: 12px; cursor: pointer; font-size: 1.1rem; transition: 0.2s; position: relative; z-index: 51; }
        .tools-btn:active { transform: scale(0.9); }
        .tools-btn.turbo-active { color: var(--success); background: var(--primary-glass); animation: pulseGreen 1.5s infinite; border-radius: 50% !important; width: 38px; height: 38px; padding: 0; display: flex; justify-content: center; align-items: center; }

        /* Sections */
        .section { border-radius: 28px; box-shadow: var(--shadow); border: 1px solid var(--border-color); background: var(--bg-card); padding: 20px; margin-bottom: 20px; transition: 0.3s; }
        .sec-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 5px; position: relative; z-index: 20; }
        .sec-title span { font-weight: 800; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; letter-spacing: -0.5px; }
        .section-rooms { background: linear-gradient(to bottom right, var(--bg-card), var(--success-glass) 5%); border-left: 5px solid var(--success); }
        .section-requests { background: linear-gradient(to bottom right, var(--bg-card), var(--request-glass) 5%); border-left: 5px solid var(--request-color); }
        .section-maintenance { background: linear-gradient(to bottom right, var(--bg-card), var(--warning-glass) 5%); border-left: 5px solid var(--warning); }

        /* Add Button */
        .btn-add-room-wrapper { position: relative; display: inline-block; width: 55px; height: 55px; z-index: 100; }
        .btn-add-room { background: var(--primary); color: white; width: 100%; height: 100%; font-weight: 800; font-size: 2rem; border-radius: 50%; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; padding-bottom: 4px; box-shadow: 0 8px 20px rgba(0, 151, 167, 0.3); position: relative; z-index: 101; transition: transform 0.2s; }
        .btn-add-room:active { transform: scale(0.9); }
        .btn-add-room::before { content: ''; position: absolute; top: -4px; left: -4px; right: -4px; bottom: -4px; border-radius: 50%; border: 3px solid transparent; border-top-color: var(--success); border-right-color: var(--success); animation: spinRing 4s linear infinite; z-index: 100; pointer-events: none; }
        @keyframes spinRing { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; text-align: center; margin-bottom: 15px; }
        .circle-viz { width: 75px; height: 75px; border-radius: 50%; margin: 0 auto 8px auto; display: flex; flex-direction: column; justify-content: center; align-items: center; background: var(--bg-body); box-shadow: 6px 6px 12px rgba(0,0,0,0.05), -6px -6px 12px rgba(255,255,255,0.8); border: 4px solid var(--bg-card); }
        .circle-viz h3 { margin: 0; font-size: 1.3rem; color: var(--text-main); line-height: 1; }
        .circle-viz span { font-size: 0.65rem; color: var(--text-sec); font-weight: bold; margin-top: 2px; }
        .stat-detail-box { padding: 12px; border-radius: 20px; border: 1px solid var(--border-color); text-align: center; background: var(--bg-body); display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 80px; }
        .pulse-urgent-box { animation: pulseRedBackground 1.5s infinite; background-color: rgba(239, 68, 68, 0.08) !important; border-color: var(--danger) !important; }
        @keyframes pulseRedBackground { 0% {background-color: rgba(239, 68, 68, 0.05);} 50% {background-color: rgba(239, 68, 68, 0.15);} 100% {background-color: rgba(239, 68, 68, 0.05);} }

        /* Cards */
        .room-row { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 26px; padding: 16px; margin-bottom: 15px; display: grid; grid-template-columns: 65px 1fr 1.3fr auto; gap: 15px; align-items: center; box-shadow: var(--shadow); position: relative; overflow: hidden; }
        .room-row.status-cleaning { background: linear-gradient(to left, var(--primary-glass), var(--bg-card)); }
        .room-row.status-over { background: linear-gradient(to left, var(--danger-glass), var(--bg-card)); }
        .room-row.status-request { background: linear-gradient(to left, var(--request-glass), var(--bg-card)); }
        .room-row.status-maintenance { background: linear-gradient(to left, var(--maint-glass), var(--bg-card)); border: 1px solid var(--maint-color); }
        .room-num { font-weight: 800; font-size: 1.6rem; color: var(--text-main); line-height: 1; letter-spacing: -1px; }
        .timer-display { font-weight: 800; font-size: 1.3rem; text-align: center; color: var(--text-sec); letter-spacing: -0.5px; font-variant-numeric: tabular-nums; }
        .timer-active { color: var(--primary); } .timer-danger { color: var(--danger); } .timer-maint { color: var(--maint-color); }

        /* Buttons & Inputs */
        .glass-btn { border: 1px solid rgba(0,0,0,0.05); border-radius: 50px; padding: 8px 16px; font-weight: 700; font-size: 0.85rem; cursor: pointer; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); transition: transform 0.1s, box-shadow 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.05); color: #fff; display: inline-flex; align-items: center; justify-content: center; gap: 5px; min-height: 44px; }
        .glass-btn:active { transform: scale(0.96); }
        .glass-btn.finish { background: rgba(16, 185, 129, 0.85); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
        .glass-btn.start { background: rgba(0, 151, 167, 0.85); box-shadow: 0 4px 15px rgba(0, 151, 167, 0.3); }
        .glass-btn.img-link { background: rgba(255, 255, 255, 0.5); color: var(--maint-color); border: 2px solid var(--maint-color); padding: 6px 12px; font-size: 0.75rem; width: 100%; box-sizing: border-box; margin-top: 5px; }
        .rotating-border-badge { position: relative; padding: 8px 16px; border-radius: 50px; background: var(--bg-card); color: var(--maint-color); font-weight: 800; font-size: 0.8rem; display: inline-flex; align-items: center; justify-content: center; overflow: hidden; z-index: 1; border: 2px solid transparent; }
        .rotating-border-badge::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: conic-gradient(transparent, transparent, transparent, var(--maint-color)); animation: rotateBorder 3s linear infinite; z-index: -2; }
        .rotating-border-badge::after { content: ''; position: absolute; inset: 2px; background: var(--bg-card); border-radius: 50px; z-index: -1; }
        .rotating-border-badge.req-active { color: var(--request-color); }
        .rotating-border-badge.req-active::before { background: conic-gradient(transparent, transparent, transparent, var(--request-color)); }
        @keyframes rotateBorder { 100% { transform: rotate(360deg); } }
        .badge { font-size: 0.7rem; padding: 5px 12px; border-radius: 12px; background: rgba(0,0,0,0.06); color: var(--text-sec); font-weight: 700; display: inline-flex; align-items: center; }
        
        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
        .modal-content { padding: 30px; width: 85%; max-width: 350px; text-align: center; border-radius: 30px; background: var(--bg-card); box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .modal-tabs { display: flex; gap: 8px; margin-bottom: 20px; background: var(--bg-body); padding: 6px; border-radius: 50px; }
        .modal-tab-btn { flex: 1; padding: 10px; border-radius: 40px; border: none; background: transparent; color: var(--text-sec); font-weight: 700; cursor: pointer; transition: 0.3s; font-size: 0.9rem; }
        .modal-tab-btn.active { background: var(--bg-card); color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .modal-content input, .modal-content textarea { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 18px; box-sizing: border-box; background: var(--bg-body); color: var(--text-main); font-size: 1rem; font-family: inherit; }
        .full-btn { width: 100%; padding: 15px; font-size: 1.1rem; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; color: #fff; box-shadow: 0 8px 20px rgba(0,0,0,0.1); margin-bottom: 10px; min-height: 50px; }
        .camera-icon-btn { width: 70px; height: 70px; border-radius: 50%; background: var(--bg-body); display: flex; justify-content: center; align-items: center; cursor: pointer; margin: 10px auto; border: 2px solid var(--border-color); font-size: 2rem; color: var(--text-sec); }
        .system-time-input { width: 100%; padding: 15px; border: 2px solid var(--border-color); border-radius: 16px; font-size: 18px; text-align: center; background: var(--bg-body); font-family: inherit; color: var(--text-main); -webkit-appearance: none; margin-bottom: 15px; }
        .alert-modal-content { background: var(--bg-card); padding: 30px; border-radius: 30px; width: 80%; max-width: 300px; text-align: center; box-shadow: 0 25px 60px rgba(0,0,0,0.3); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        #dev-footer-fixed { position: fixed; bottom: 0; left: 0; width: 100%; text-align: center; font-size: 0.7rem; color: var(--text-sec); background: var(--bg-card); padding: 5px 0; border-top: 1px solid var(--border-color); z-index: 1000; }
        @media (min-width: 768px) { .container { max-width: 700px; } .room-row { padding: 20px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-glass">
            <div class="header-right"><div class="header-logo" style="display:flex;align-items:center;gap:10px;"><h1>Adora | Ù…ØªØ§Ø¨Ø¹Ø© ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„</h1></div></div>
            <div class="header-left">
                <button onclick="generateDailyReport()" class="tools-btn" title="ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¯ÙŠØ±">ğŸ“</button>
                <button onclick="toggleTurboMode()" id="turbo-mode-btn" class="tools-btn" title="ÙˆØ¶Ø¹ Ø§Ù„ØªÙŠØ±Ø¨Ùˆ">âš¡</button>
                <button onclick="toggleDarkMode()" class="tools-btn" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">ğŸŒ™</button>
            </div>
        </div>

        <div class="worker-view">
            <div id="sync-indicator" style="display: none;">ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...</div>
            <div class="section">
                <div class="sec-title"><span>ğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡</span>
                    <button onclick="showNewShiftModal()" class="tools-btn" style="padding: 2px 6px; font-size:1.2rem;" title="Ø¨Ø¯Ø¡ Ø´ÙØª Ø¬Ø¯ÙŠØ¯">ğŸŒ…</button>
                </div>
                <div class="stats-grid">
                    <div class="stat-circle-box"><div class="circle-viz" style="border-color: var(--danger);"><h3 id="stat-late">0</h3><span>Ù…ØªØ£Ø®Ø±</span></div></div>
                    <div class="stat-circle-box"><div class="circle-viz" style="border-color: var(--primary);"><h3 id="stat-active">0</h3><span>Ù†Ø´Ø·</span></div></div>
                    <div class="stat-circle-box"><div class="circle-viz" style="border-color: var(--upgrade);"><h3 id="stat-maint-done">0</h3><span>ØµÙŠØ§Ù†Ø©</span></div></div>
                </div>
                <div id="stat-details-container">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                        <div class="stat-detail-box" style="border-color:var(--primary);"><span style="display:block; font-size:0.75rem; color:var(--primary); font-weight:bold;">Ø®Ø±ÙˆØ¬ Ù…Ù†Ø¬Ø²</span><strong style="font-size:1.4rem; color:var(--primary);" id="stat-out-done">0</strong></div>
                        <div class="stat-detail-box" style="border-color:var(--upgrade);"><span style="display:block; font-size:0.75rem; color:var(--upgrade); font-weight:bold;">Ø³Ø§ÙƒÙ† Ù…Ù†Ø¬Ø²</span><strong style="font-size:1.4rem; color:var(--upgrade);" id="stat-stay-done">0</strong></div>
                        <div class="stat-detail-box" id="stat-req-box" style="border-color:var(--request-color); transition: background 0.5s;">
                            <span style="display:block; font-size:0.75rem; color:var(--request-color); font-weight:bold;">ğŸ›ï¸ Ø¢Ø®Ø± Ø·Ù„Ø¨</span>
                            <div id="stat-req-text" style="font-size:0.8rem; font-weight:800; color:var(--text-main); margin-top:4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px;">--</div>
                        </div>
                        <div class="stat-detail-box" style="border-color:var(--maint-color);">
                            <span style="display:block; font-size:0.75rem; color:var(--maint-color); font-weight:bold;">ØµÙŠØ§Ù†Ø© Ù…Ù†Ø¬Ø²Ø©</span>
                            <strong style="font-size:1.4rem; color:var(--maint-color);" id="stat-maint-total">0</strong>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section section-rooms">
                <div class="sec-title"><span>ğŸšª ØªØªØ¨Ø¹ Ø§Ù„ØºØ±Ù</span><div class="btn-add-room-wrapper"><button onclick="openAddModal()" class="btn-add-room" id="add-room-btn">+</button></div></div>
                <input type="text" id="search-bar" class="search-box" style="width:100%; box-sizing:border-box; padding:14px; border-radius:20px; border:1px solid var(--border-color); background:var(--bg-body); color:var(--text-main); margin-bottom:15px; font-size:1rem;" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©..." oninput="updateSearch()">
                <div id="rooms-container"></div>
                <div id="scheduled-rooms-container" style="margin-top: 20px; border-top: 2px dashed var(--border-color); padding-top: 15px; display: none;"></div>
            </div>

            <div class="section section-requests" id="guest-requests-section">
                <div class="sec-title" style="color: var(--request-color);"><span>ğŸ›ï¸ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù†Ø²Ù„Ø§Ø¡</span><button onclick="toggleArchive('req')" class="tools-btn" title="Ø§Ù„Ø£Ø±Ø´ÙŠÙ">ğŸ“‚</button></div>
                <div id="guest-requests-active-list" style="margin-bottom:5px;"></div>
                <div id="scheduled-requests-container" style="margin-top: 20px; border-top: 2px dashed var(--border-color); padding-top: 15px; display: none;"></div>
                <div id="req-archive-container" class="archive-container" style="display:none;">
                    <div style="font-size:0.7rem; color:var(--text-sec); margin-bottom:5px; font-weight:bold;">Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©:</div>
                    <div id="guest-requests-archive-list"></div>
                    <button id="btn-more-req" class="btn-show-more" onclick="loadMoreArchives('req')">â¬‡ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯</button>
                </div>
            </div>

            <div class="section section-maintenance">
                <div class="sec-title" style="color: var(--maint-color);"><span>ğŸ› ï¸ Ø§Ù„ØµÙŠØ§Ù†Ø©</span><button onclick="toggleArchive('maint')" class="tools-btn" title="Ø§Ù„Ø£Ø±Ø´ÙŠÙ">ğŸ“‚</button></div>
                <div id="maintenance-active-list" style="margin-bottom:5px;"></div>
                <div id="scheduled-maintenance-container" style="margin-top: 20px; border-top: 2px dashed var(--border-color); padding-top: 15px; display: none;"></div>
                <div id="maint-archive-container" class="archive-container" style="display:none;">
                    <div style="font-size:0.7rem; color:var(--text-sec); margin-bottom:5px; font-weight:bold;">Ø£Ø±Ø´ÙŠÙ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©:</div>
                    <div id="maintenance-archive-list"></div>
                    <button id="btn-more-maint" class="btn-show-more" onclick="loadMoreArchives('maint')">â¬‡ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯</button>
                </div>
            </div>

            <div class="section">
                <div class="sec-title"><span>ğŸ§¹ Ø§Ù„Ø³Ø¬Ù„ (Ø§Ù„Ù…ÙƒØªÙ…Ù„)</span><button onclick="showLogClearModal()" class="tools-btn" style="padding: 4px 8px;">ğŸ—‘ï¸</button></div>
                <div id="cleaning-log-list" style="font-size:0.8rem; min-height: 50px;"></div>
            </div>
        </div>
    </div>

    <div id="dev-footer-fixed">ØªØ·ÙˆÙŠØ± .. Ø§ÙŠÙ…Ù† Ø§Ø¨Ùˆ ÙˆØ±Ø¯Ù‡ 77aayy@gmail.com</div>

    <div id="addRoomModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-tabs">
                <button onclick="switchAddMode('cleaning')" class="modal-tab-btn active" id="tab-cleaning">ğŸ§¹ Ù†Ø¸Ø§ÙØ©</button>
                <button onclick="switchAddMode('request')" class="modal-tab-btn" id="tab-request">ğŸ›ï¸ Ø·Ù„Ø¨Ø§Øª</button>
                <button onclick="switchAddMode('maintenance')" class="modal-tab-btn" id="tab-maintenance">ğŸ› ï¸ ØµÙŠØ§Ù†Ø©</button>
            </div>
            <h3 style="color:var(--primary); margin-top:0;" id="modal-title-add">Ø¥Ø¶Ø§ÙØ© ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <div style="margin-bottom:15px; text-align:right;">
                <label class="modal-label" style="font-weight:bold;">Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©</label>
                <input type="number" id="inpRoomNum" placeholder="Ù…Ø«Ø§Ù„: 101" oninput="checkDuplicate();" style="font-size:1.2rem; font-weight:bold; text-align:center;">
                <div id="room-dup-alert" style="font-size:0.75rem; font-weight:bold; margin-top:8px; padding:5px; border-radius:5px; text-align:right; display:none; color:var(--danger); background:rgba(239, 68, 68, 0.1);"></div>
            </div>
            
            <div id="cleaning-options">
                <div style="margin-bottom:15px; display:flex; gap:10px;">
                    <div onclick="setRoomType('out')" class="glass-btn" style="flex:1; background:var(--bg-body); color:var(--text-main); border:1px solid var(--border-color);" id="opt_out">Ø®Ø±ÙˆØ¬</div>
                    <div onclick="setRoomType('stay')" class="glass-btn" style="flex:1; background:var(--bg-body); color:var(--text-main); border:1px solid var(--border-color);" id="opt_stay">Ø³Ø§ÙƒÙ†</div>
                </div>
                <input type="hidden" id="inpRoomType">
                <div id="stayOptionsCleaning" style="display:none; margin-bottom:15px; text-align:right;">
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <div onclick="setGuestStatus('in')" class="glass-btn" style="flex:1; background:var(--bg-body); color:var(--text-main);" id="gst_clean_in">Ø¨Ø§Ù„Ø¯Ø§Ø®Ù„</div>
                        <div onclick="setGuestStatus('out')" class="glass-btn" style="flex:1; background:var(--bg-body); color:var(--text-main);" id="gst_clean_out">Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬</div>
                    </div>
                    <label class="modal-label" id="lblTimeClean" style="font-weight:bold;">ÙˆÙ‚Øª Ø§Ù„ØªÙ†Ø¸ÙŠÙ</label>
                    <input type="time" id="systemTimeInput" class="system-time-input" value="12:00">
                </div>
                <div class="toggle-container" style="background: rgba(255, 152, 0, 0.1); border-color: rgba(255, 152, 0, 0.3); margin-bottom: 10px;">
                    <div class="toggle-label" style="color: #ef6c00;">ğŸš€ Ø³ÙˆØ¨Ø± ØªÙŠØ±Ø¨Ùˆ (Ø®ØµÙ… 5Ø¯)</div>
                    <label class="switch"><input type="checkbox" id="inpSuperTurbo"><span class="slider"></span></label>
                </div>
            </div>

            <div id="request-options" style="display:none; margin-bottom:15px;">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button onclick="setRequestMode('immediate')" id="btn-req-imm" class="glass-btn" style="flex:1; background:var(--request-color);">ğŸ”¥ ÙÙˆØ±ÙŠ</button>
                    <button onclick="setRequestMode('scheduled')" id="btn-req-sch" class="glass-btn" style="flex:1; background:var(--bg-body); color:var(--text-main);">ğŸ“… Ù…Ø¬Ø¯ÙˆÙ„</button>
                </div>
                <textarea id="inpRequestDetails" rows="3" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨..."></textarea>
                <div id="request-schedule-container" style="display:none; margin-top:15px;">
                    <input type="time" id="systemTimeInputReq" class="system-time-input" value="12:00">
                </div>
            </div>

            <div id="maintenance-options" style="display:none; margin-bottom:15px;">
                 <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button onclick="setMaintMode('immediate')" id="btn-maint-imm" class="glass-btn" style="flex:1; background:var(--maint-color);">ğŸ”¥ Ø¹Ø§Ø¬Ù„Ø©</button>
                    <button onclick="setMaintMode('scheduled')" id="btn-maint-sch" class="glass-btn" style="flex:1; background:var(--bg-body); color:var(--text-main);">ğŸ“… Ù…Ø¬Ø¯ÙˆÙ„Ø©</button>
                </div>
                <textarea id="inpMaintDetails" rows="3" placeholder="ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„..."></textarea>
                 <label class="modal-label" style="font-weight:bold;">ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                 <label for="inpMaintImage" class="camera-icon-btn" style="margin-top:5px; border-color:var(--maint-color); color:var(--maint-color);">ğŸ“·</label>
                 <input type="file" accept="image/*" capture="environment" id="inpMaintImage" style="display:none;">
                <div id="maint-schedule-container" style="display:none; margin-top:15px;">
                    <input type="time" id="systemTimeInputMaint" class="system-time-input" value="12:00">
                </div>
            </div>

            <input type="hidden" id="inpGuestStatus" value="in"> 
            
            <button onclick="addNewBtnAction()" class="full-btn" style="background:var(--success);" id="confirm-add-btn">Ø¥Ø¶Ø§ÙØ© ÙˆØ¥Ø±Ø³Ø§Ù„ ğŸš€</button>
            <button onclick="closeAllModals()" class="full-btn" style="background:#ddd; color:#333;" id="cancel-add-room">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div id="rain-prompt-modal" class="modal-overlay" style="display: none;"><div class="modal-content"><h3 style="color:var(--primary);">ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø¯Ø¡</h3><button onclick="commitStartRoom(true)" class="full-btn" style="background:var(--danger);">ğŸš€ Ø³ÙˆØ¨Ø± ØªÙŠØ±Ø¨Ùˆ</button><button onclick="commitStartRoom(false)" class="full-btn" style="background:var(--success);">ÙˆØ¶Ø¹ Ø¹Ø§Ø¯ÙŠ</button></div></div>
    
    <div id="final-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 style="margin-top:0; color:var(--primary);">ğŸ“ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºØ±ÙØ©</h3>
            <div id="delay-reason-section" style="display:none; margin-bottom:15px;">
                <label class="modal-label" style="color:var(--danger); font-weight:bold;">âš ï¸ Ø³Ø¨Ø¨ Ø§Ù„ØªØ£Ø®ÙŠØ±:</label>
                <input type="hidden" id="modal-delay">
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <div onclick="setDelayReason('Ø¶ØºØ· Ø¹Ù…Ù„', this)" class="glass-btn" style="background:#eee; color:#333; flex:1;" id="dly_work">Ø¶ØºØ·</div>
                    <div onclick="setDelayReason('Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„ØºØ±ÙØ©', this)" class="glass-btn" style="background:#eee; color:#333; flex:1;" id="dly_room">ØºØ±ÙØ©</div>
                    <div onclick="setDelayReason('Ø³Ø¨Ø¨ Ø¢Ø®Ø±', this)" class="glass-btn" style="background:#eee; color:#333; flex:1;" id="dly_other">Ø¢Ø®Ø±</div>
                </div>
            </div>
            <input type="hidden" id="modal-notes" value="Ø¬Ø§Ù‡Ø²Ø©">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <div onclick="setRoomStatus('Ø¬Ø§Ù‡Ø²Ø©')" class="glass-btn" style="flex:1; background:var(--success); color:white; justify-content:center;" id="st_ready">Ø¬Ø§Ù‡Ø²Ø© âœ…</div>
                <div onclick="setRoomStatus('ØªØ­ØªØ§Ø¬ ØµÙŠØ§Ù†Ø©')" class="glass-btn" style="flex:1; background:#eee; color:#333; justify-content:center;" id="st_maint">ØµÙŠØ§Ù†Ø© ğŸ› ï¸</div>
            </div>
            <div id="maintenance-fields" style="display: none;">
                <textarea id="repair-details-input" placeholder="ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„..."></textarea>
                <label for="modal-img-camera-input" class="camera-icon-btn danger" style="width:60px; height:60px;">ğŸ“·</label>
                <input type="file" accept="image/*" capture="environment" id="modal-img-camera-input" style="display:none;">
            </div>
            <div class="toggle-container" style="background: rgba(76, 175, 80, 0.1); border-color: rgba(76, 175, 80, 0.3);">
                <div class="toggle-label" style="color: #2e7d32;">ğŸ“² ÙˆØ§ØªØ³Ø§Ø¨</div>
                <label class="switch"><input type="checkbox" id="inpSendWhatsapp"><span class="slider"></span></label>
            </div>
            <button onclick="confirmFinishRoom()" class="full-btn" id="btn_confirm_finish" style="background:var(--success); margin-top:10px;">ØªØ£ÙƒÙŠØ¯ âœ…</button>
            <button onclick="closeAllModals()" class="full-btn" style="background:#ddd; color:#333;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
    
    <div id="complete-maint-modal" class="modal-overlay" style="display: none;"><div class="modal-content"><h3 style="margin-top:0; color:var(--success);">âœ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØµÙŠØ§Ù†Ø©</h3><div id="maint-room-num-display" style="font-size:1.5rem; font-weight:800; margin-bottom:15px;">ØºØ±ÙØ© XXX</div><label for="maint-img-camera-input" class="camera-icon-btn">ğŸ“·</label><input type="file" accept="image/*" capture="environment" id="maint-img-camera-input" style="display:none;"><button onclick="confirmCompleteMaintenance()" class="full-btn" id="btn_confirm_maint_finish" style="background:var(--success); margin-top:20px;">ØªÙˆØ«ÙŠÙ‚ ÙˆØ¥Ù†Ù‡Ø§Ø¡ ğŸš€</button><button onclick="closeAllModals()" class="full-btn" style="background:#ddd; color:#333;">Ø¥Ù„ØºØ§Ø¡</button></div></div>
    <div id="password-modal" class="modal-overlay" style="display: none;"><div class="modal-content"><h3 style="color:var(--danger);">ØªØ­Ù‚Ù‚</h3><input type="password" id="admin-password" placeholder="***" style="text-align:center; font-size:1.5rem;" /><button onclick="checkPasswordAndAction()" class="full-btn" style="background:var(--success); margin-top:10px;">ØªØ£ÙƒÙŠØ¯</button><button onclick="closeAllModals()" class="full-btn" style="background:#ddd; color:#333;">Ø¥Ù„ØºØ§Ø¡</button></div></div>
    <div id="action-confirm-modal" class="modal-overlay" style="display: none;"><div class="modal-content"><h3 style="color:var(--danger);">ØªØ£ÙƒÙŠØ¯</h3><p id="confirm-message" style="font-size:1.2rem; font-weight:bold;"></p><button id="confirm-yes-btn" class="full-btn" style="background:var(--success);">Ù†Ø¹Ù…</button><button onclick="closeAllModals()" class="full-btn" style="background:#ddd; color:#333;">Ø¥Ù„ØºØ§Ø¡</button></div></div>
    <div id="customAlertModal" class="modal-overlay" style="z-index: 3000; display: none;"><div class="alert-modal-content"><span id="alertIcon" style="font-size:3rem; display:block; margin-bottom:10px;"></span><p id="alertMessage" style="font-weight:bold; font-size:1.1rem; margin-bottom:20px;"></p><button onclick="closeCustomAlert()" class="full-btn" style="background:var(--primary);">Ø­Ø³Ù†Ø§Ù‹</button></div></div>

    <script>
        // Global Constants & State
        const CONFIG = { 
            imgbbKey: "a7ec1c5e56839fcc6e0b6bda38257f05", 
            adminHash: 2031126303, // ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯ Ø§Ù„ØµØ±ÙŠØ­ Ø¨Ù€ Hash Ù„Ù„Ø­Ù…Ø§ÙŠØ© (Ù‡Ø§Ø´ ÙƒÙ„Ù…Ø© fahd5)
            times: { OUT_NORM: 35 * 60000, OUT_TURBO: 30 * 60000, STAY_NORM: 25 * 60000, STAY_TURBO: 20 * 60000, TRAVEL: 15 * 60000, PREP_ALERT: 15 * 60000, CHECKING: 15 * 60000 } 
        };
        let appState = { rooms: [], log: [], activeMaintenance: [], completedMaintenanceLog: [], guestRequests: [], guestRequestsLog: [], turbo: false, searchText: "", archiveViewLimit: { req: 5, maint: 5 } };
        let currentAddMode = 'cleaning';
        let isImmediateRequest = true;
        let isImmediateMaint = true; 
        let tempRoomId = null, activeRoomId = null, activeMaintId = null, pendingAction = null;

        // Firebase Listeners
        function initFirebaseListeners() {
            if (!db) return;
            
            db.collection('rooms').onSnapshot(snapshot => {
                appState.rooms = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
            db.collection('guestRequests').onSnapshot(snapshot => {
                appState.guestRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGuestRequests();
                updateStats();
            });
            db.collection('activeMaintenance').onSnapshot(snapshot => {
                appState.activeMaintenance = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllLogs();
                updateStats();
            });
            db.collection('logs').doc('cleaning').onSnapshot(doc => {
                appState.log = doc.exists ? doc.data().items || [] : [];
                appState.log.sort((a, b) => b.id - a.id);
                renderAllLogs();
            });
            db.collection('logs').doc('requests').onSnapshot(doc => {
                appState.guestRequestsLog = doc.exists ? doc.data().items || [] : [];
                appState.guestRequestsLog.sort((a, b) => b.id - a.id);
                renderGuestRequests();
                updateStats();
            });
            db.collection('logs').doc('maint').onSnapshot(doc => {
                appState.completedMaintenanceLog = doc.exists ? doc.data().items || [] : [];
                appState.completedMaintenanceLog.sort((a, b) => b.id - a.id);
                renderAllLogs();
                updateStats();
            });
            db.collection('settings').doc('globalState').onSnapshot(doc => {
                if (doc.exists) {
                    appState.turbo = doc.data().turbo || false;
                    appState.archiveViewLimit = doc.data().archiveViewLimit || { req: 5, maint: 5 };
                    document.getElementById('turbo-mode-btn').classList.toggle('turbo-active', appState.turbo);
                }
            });
        }
        
        function initApp() {
            initFirebaseListeners();
            setInterval(() => { 
                updateTimersDOM(); 
                renderUndoCountdowns(); 
                renderGuestRequestTimers(); 
                checkScheduledItems(); 
                updateStats(); 
            }, 1000);
        }
        window.onload = initApp;

        function render() { renderRooms(); renderAllLogs(); renderGuestRequests(); updateStats(); }
        
        async function saveData() {
            if (!db) return;
            try {
                await db.collection('settings').doc('globalState').set({
                    turbo: appState.turbo,
                    archiveViewLimit: appState.archiveViewLimit
                }, { merge: true });
            } catch (e) { console.error("Error saving global state:", e); }
        }

        // --- Core Functions ---
        async function addNewBtnAction() {
            let num = document.getElementById('inpRoomNum').value; 
            
            // âœ… ØªØµØ­ÙŠØ­: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©
            if (!num) { showCustomAlert('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©.', 'warning'); return; }
            if (num < 1 || num > 9999) { showCustomAlert('Ø±Ù‚Ù… ØºØ±ÙØ© ØºÙŠØ± ØµØ­ÙŠØ­.', 'warning'); return; }
            
            num = String(num); 
            if (appState.rooms.find(room => room.num === num)) { showCustomAlert(`Ø§Ù„ØºØ±ÙØ© ${num} Ù†Ø´Ø·Ø© Ø¨Ø§Ù„ÙØ¹Ù„.`, 'error'); return; }
            if (!db) { showCustomAlert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.', 'error'); return; }

            let waMsg = '';
            let timeValue = '';
            let schedTimestamp = null;
            let timeInputId = '';
            
            if (currentAddMode === 'cleaning') { timeInputId = 'systemTimeInput'; }
            else if (currentAddMode === 'request' && !isImmediateRequest) { timeInputId = 'systemTimeInputReq'; }
            else if (currentAddMode === 'maintenance' && !isImmediateMaint) { timeInputId = 'systemTimeInputMaint'; }
            if (timeInputId) { timeValue = document.getElementById(timeInputId).value; }

            const timeParts = timeValue.split(':');
            const hours = parseInt(timeParts[0]);
            const minutes = parseInt(timeParts[1]);
            const period = hours >= 12 ? 'Ù…' : 'Øµ';
            const displayHours = hours % 12 || 12;
            const fullTimeString = `Ø§Ù„ÙŠÙˆÙ… - ${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
            
            const isScheduled = (currentAddMode === 'request' && !isImmediateRequest) || (currentAddMode === 'maintenance' && !isImmediateMaint) || (currentAddMode === 'cleaning' && document.getElementById('inpRoomType').value === 'stay');
            
            if (isScheduled) { 
                const now = new Date(); 
                const selected = new Date(); 
                selected.setHours(hours, minutes, 0, 0); 
                if (selected < new Date(now.getTime() - 60000)) { 
                    showCustomAlert("Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„ ÙÙŠ Ø§Ù„Ù…Ø§Ø¶ÙŠ!", "warning"); 
                    return; 
                } 
                schedTimestamp = selected.getTime(); 
            }

            if (currentAddMode === 'request') {
                const details = document.getElementById('inpRequestDetails').value; if (!details) { showCustomAlert('Ø§ÙƒØªØ¨ Ø§Ù„Ø·Ù„Ø¨.', 'warning'); return; }
                waMsg = `Adora | ğŸ›ï¸ *Ø·Ù„Ø¨*\nØº: ${num}\n${details}\n${isImmediateRequest?'ğŸ”¥ Ø¹Ø§Ø¬Ù„':fullTimeString}`;
            } else if (currentAddMode === 'maintenance') {
                 const details = document.getElementById('inpMaintDetails').value; if (!details) { showCustomAlert('Ø§ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„.', 'warning'); return; }
                 waMsg = `Adora | ğŸ› ï¸ *ØµÙŠØ§Ù†Ø©*\nØº: ${num}\n${details}`;
            } else if (currentAddMode === 'cleaning') {
                const type = document.getElementById('inpRoomType').value; if (!type) { showCustomAlert('Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©.', 'warning'); return; }
                waMsg = `Adora | *${type==='out'?'Ø®Ø±ÙˆØ¬':'Ø³Ø§ÙƒÙ†'}*\nØº: ${num}`;
            }
            
            window.open(`https://wa.me/?text=${encodeURIComponent(waMsg)}`, '_blank'); 
            closeAllModals(); 
            
            const roomType = document.getElementById('inpRoomType').value;
            const isSuper = document.getElementById('inpSuperTurbo').checked;
            const maintDetails = document.getElementById('inpMaintDetails').value;
            const reqDetails = document.getElementById('inpRequestDetails').value;
            const maintFile = document.getElementById('inpMaintImage').files[0];

            await submitNewEntryToFirebase(currentAddMode, num, isScheduled, schedTimestamp, fullTimeString, roomType, isSuper, maintDetails, reqDetails, maintFile);
        }

        async function submitNewEntryToFirebase(mode, num, isScheduled, schedTimestamp, fullTimeString, roomType, isSuper, maintDetails, reqDetails, maintFile) {
            if (!db) return;
            try {
                let imgUrl = null;
                if (mode === 'maintenance' && maintFile) {
                    imgUrl = await uploadToImgBB(maintFile);
                    if (!imgUrl) { showCustomAlert('ÙØ´Ù„ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©.', 'error'); return; }
                }

                if (mode === 'request') {
                    const newRequest = { num, details: reqDetails, schedTime: isImmediateRequest ? "ÙÙˆØ±ÙŠ" : fullTimeString, schedTimestamp, isUrgent: isImmediateRequest, startTime: Date.now(), status: isImmediateRequest ? 'active' : 'scheduled' };
                    await db.collection('guestRequests').add(newRequest);
                } else if (mode === 'maintenance') {
                     const newMaint = { num, maintDesc: maintDetails, maintImg: imgUrl, schedTime: isImmediateMaint ? "ÙÙˆØ±ÙŠ" : fullTimeString, schedTimestamp, startTime: Date.now(), status: isImmediateMaint ? 'active' : 'scheduled', history: [{action: 'ØªØ³Ø¬ÙŠÙ„', time: new Date().toLocaleTimeString('en-US')}] };
                     await db.collection('activeMaintenance').add(newMaint);
                } else if (mode === 'cleaning') {
                    const newRoom = { 
                        num, type: roomType, 
                        status: isScheduled ? 'scheduled' : 'acknowledging', 
                        startTime: Date.now(), 
                        deadline: Date.now() + CONFIG.times.TRAVEL, 
                        guestStatus: roomType === 'stay' ? document.getElementById('inpGuestStatus').value : 'out', 
                        undoExpiry: Date.now() + 15000, 
                        historyLogs: [{ action: 'Ø¯Ø®ÙˆÙ„', time: new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }) }], 
                        isSuperTurbo: isSuper, 
                        schedTime: fullTimeString, 
                        schedTimestamp 
                    };
                    await db.collection('rooms').add(newRoom);
                }
            } catch(e) { console.error("Firebase Add Failed:", e); showCustomAlert(`ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©.`, 'error'); }
        }

        // --- Critical Functions (Polished) ---
        async function confirmFinishRoom() { 
            if (!db) { showCustomAlert("Ø®Ø·Ø£: Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØµÙ„Ø©", "error"); return; }
            const room = appState.rooms.find(r => r.id === activeRoomId); 
            if (!room) { showCustomAlert("Ø®Ø·Ø£: Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©", "error"); return; }

            const status = document.getElementById('modal-notes').value; 
            const isLate = document.getElementById('delay-reason-section').style.display !== 'none'; 
            const delayReason = document.getElementById('modal-delay').value; 
            const shouldSendWhatsapp = document.getElementById('inpSendWhatsapp').checked; 

            if (isLate && (!delayReason || delayReason === '')) { showCustomAlert('âš ï¸ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø³Ø¨Ø¨ Ø§Ù„ØªØ£Ø®ÙŠØ± Ù‚Ø¨Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯!', 'warning'); return; } 
            
            if (shouldSendWhatsapp) {
                let waMsg = (status === 'ØªØ­ØªØ§Ø¬ ØµÙŠØ§Ù†Ø©') ? `Adora | ğŸ› ï¸ *Ø¹Ø·Ù„*\nØº: ${room.num}\n(Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©)` : `Adora | âœ… Øº ${room.num} Ø¬Ø§Ù‡Ø²Ø©`;
                setTimeout(() => window.open(`https://wa.me/?text=${encodeURIComponent(waMsg)}`, '_blank'), 100);
            }
            
            closeAllModals(); 
            showCustomAlert("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...", "info");

            const logAction = { action: 'ØªÙˆØ«ÙŠÙ‚', time: new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }) };
            
            try {
                const safeHistory = room.historyLogs || [];

                if (status === 'ØªØ­ØªØ§Ø¬ ØµÙŠØ§Ù†Ø©') { 
                    const desc = document.getElementById('repair-details-input').value; 
                    const file = document.getElementById('modal-img-camera-input').files[0]; 
                    if (!desc || !file) { showCustomAlert('Ù…Ø·Ù„ÙˆØ¨ ØµÙˆØ±Ø© ÙˆÙˆØµÙ Ù„Ù„Ø¹Ø·Ù„.', 'error'); return; } 
                    
                    const imgUrl = await uploadToImgBB(file); 
                    if (!imgUrl) { showCustomAlert('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©', 'error'); return; } 
                    
                    const maintEntry = { 
                        num: room.num, type: room.type, history: safeHistory.concat([logAction]), 
                        isLate, delayReason, maintDesc: desc, maintImg: imgUrl, 
                        startTime: Date.now(), status: 'active' 
                    }; 
                    
                    await db.collection('activeMaintenance').add(maintEntry);
                    await db.collection('rooms').doc(activeRoomId).delete();
                } else { 
                    const logEntry = { 
                        id: Date.now(), num: room.num, type: room.type, status, history: safeHistory.concat([logAction]), 
                        isLate, delayReason, duration: Date.now() - (room.startTime || Date.now())
                    }; 
                    
                    // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… set Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† update
                    await db.collection('logs').doc('cleaning').set({
                        items: firebase.firestore.FieldValue.arrayUnion(logEntry)
                    }, { merge: true });

                    await db.collection('rooms').doc(activeRoomId).delete();
                }
                closeCustomAlert();
            } catch(e) { 
                console.error("Error finishing room:", e); 
                showCustomAlert("ÙØ´Ù„ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©.", 'error'); 
            }
        }
        
        // âœ… Ø¯Ø§Ù„Ø© Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØµÙŠØ§Ù†Ø© (Ù…ØµØ­Ø­Ø©: Ø§Ø³ØªØ®Ø¯Ø§Ù… set)
        async function confirmCompleteMaintenance() { 
            if (!db) return;
            const maint = appState.activeMaintenance.find(m => m.id === activeMaintId); if (!maint) return; 
            const file = document.getElementById('maint-img-camera-input').files[0]; 
            if (!file) { showCustomAlert('ØµÙˆØ±Ø© Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ù…Ø·Ù„ÙˆØ¨Ø©.', 'error'); return; } 
            
            window.open(`https://wa.me/?text=${encodeURIComponent(`Adora | âœ… ØµÙŠØ§Ù†Ø© Ù…Ù†Ø¬Ø²Ø©\nØº: ${maint.num}`)}`, '_blank'); 
            closeAllModals(); 

            const btn = document.getElementById('btn_confirm_maint_finish'); btn.innerText = 'Ø±ÙØ¹...'; btn.disabled = true; 
            const imgUrl = await uploadToImgBB(file); btn.disabled = false; btn.innerText = 'ØªÙˆØ«ÙŠÙ‚ ÙˆØ¥Ù†Ù‡Ø§Ø¡ ğŸš€';
            if (!imgUrl) { showCustomAlert('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©', 'error'); return; }
            
            const logEntry = { id: Date.now(), num: maint.num, type: 'maint', maintDesc: maint.maintDesc, maintImg: maint.maintImg, finishImg: imgUrl, duration: Date.now() - maint.startTime, time: new Date().toLocaleTimeString('en-US') };
            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… set Ù„Ø¶Ù…Ø§Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù
                await db.collection('logs').doc('maint').set({ items: firebase.firestore.FieldValue.arrayUnion(logEntry) }, { merge: true });
                await db.collection('activeMaintenance').doc(activeMaintId).delete();
                showCustomAlert('ØªÙ… ØªÙˆØ«ÙŠÙ‚ Ø§Ù„ØµÙŠØ§Ù†Ø© âœ…', 'success');
            } catch(e) { console.error(e); showCustomAlert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸', 'error'); }
        }

        // âœ… Ø¯Ø§Ù„Ø© Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ (Ù…ØµØ­Ø­Ø©: Ø§Ø³ØªØ®Ø¯Ø§Ù… set)
        async function completeRequest(id) { 
            if (!db) return;
            const req = appState.guestRequests.find(r => r.id === id); if (!req) return; 
            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… set Ù„Ø¶Ù…Ø§Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù
                await db.collection('logs').doc('requests').set({ items: firebase.firestore.FieldValue.arrayUnion({ id: Date.now(), num: req.num, type: 'request', status: 'Ù…Ù†ÙØ°', time: new Date().toLocaleTimeString('en-US'), maintDesc: req.details }) }, { merge: true });
                await db.collection('guestRequests').doc(id).delete();
                showCustomAlert('ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° âœ…', 'success'); 
            } catch(e) { console.error(e); showCustomAlert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸', 'error'); }
        }

        // --- Other Action Functions ---
        async function forceStartScheduled(id, type) {
            if (!db) return;
            const updateData = { startTime: Date.now(), schedTimestamp: firebase.firestore.FieldValue.delete() };
            try {
                if(type === 'room') { updateData.status = 'acknowledging'; updateData.deadline = Date.now() + CONFIG.times.TRAVEL; updateData.undoExpiry = Date.now() + 15000; await db.collection('rooms').doc(id).update(updateData); }
                else if(type === 'req') { updateData.status = 'active'; await db.collection('guestRequests').doc(id).update(updateData); }
                else if(type === 'maint') { updateData.status = 'active'; await db.collection('activeMaintenance').doc(id).update(updateData); }
            } catch(e) { console.error(e); }
        }

        async function undoRoom(id) { 
            if (!db) return;
            try { await db.collection('rooms').doc(id).delete(); } catch(e) { console.error(e); }
        }

        function promptStartRoom(id) { tempRoomId = id; if (appState.turbo) commitStartRoom(true); else document.getElementById('rain-prompt-modal').style.display = 'flex'; }
        
        async function commitStartRoom(isTurbo) { 
            if (!db) return;
            document.getElementById('rain-prompt-modal').style.display = 'none'; 
            try {
                await db.collection('rooms').doc(tempRoomId).update({
                    isSuperTurbo: isTurbo, startTime: Date.now(), deadline: Date.now() + CONFIG.times.TRAVEL, undoExpiry: Date.now() + 15000, status: 'acknowledging',
                    historyLogs: firebase.firestore.FieldValue.arrayUnion({ action: 'ØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©', time: new Date().toLocaleTimeString('en-US', {hour12:false,hour:'2-digit',minute:'2-digit'}) })
                });
            } catch(e) { console.error(e); }
        }

        function promptAction(id, type) { tempRoomId = id; const messages = { 'ack': 'Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ†Ø¸ÙŠÙØŸ', 'clean': 'Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­ØµØŸ' }; document.getElementById('confirm-message').innerText = messages[type]; const btn = document.getElementById('confirm-yes-btn'); btn.onclick = () => executePhase(id, type); document.getElementById('action-confirm-modal').style.display = 'flex'; }
        
        async function executePhase(id, type) { 
            if (!db) return;
            document.getElementById('action-confirm-modal').style.display = 'none'; 
            const room = appState.rooms.find(r => r.id === id); if (!room) return; 
            const now = Date.now(); 
            let newStatus = '', newDeadline = 0, actionLog = '';

            if (type === 'ack') {
                newStatus = 'cleaning'; actionLog = 'Ø¨Ø¯Ø¡ ØªÙ†Ø¸ÙŠÙ';
                let duration = appState.turbo ? (room.type === 'stay' ? CONFIG.times.STAY_TURBO : CONFIG.times.OUT_TURBO) : (room.type === 'stay' ? CONFIG.times.STAY_NORM : CONFIG.times.OUT_NORM);
                if (room.isSuperTurbo) duration -= (5 * 60000);
                newDeadline = now + duration;
            } else if (type === 'clean') {
                newStatus = 'checking'; actionLog = 'ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ'; newDeadline = now + CONFIG.times.CHECKING;
            }
            
            try {
                 await db.collection('rooms').doc(id).update({
                    status: newStatus, startTime: now, deadline: newDeadline, undoExpiry: now + 15000,
                    historyLogs: firebase.firestore.FieldValue.arrayUnion({ action: actionLog, time: new Date().toLocaleTimeString('en-US', {hour12:false,hour:'2-digit',minute:'2-digit'}) })
                 });
            } catch(e) { console.error(e); }
        }

        // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯ (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‡Ø§Ø´)
        async function checkPasswordAndAction() { 
            if (!db) return;
            const inputPass = document.getElementById('admin-password').value;
            
            if (simpleHash(inputPass) === CONFIG.adminHash) { 
                try {
                    if (pendingAction === 'clearLog') { 
                        // Ø§Ø³ØªØ®Ø¯Ø§Ù… set Ù„Ø¶Ù…Ø§Ù† Ù…Ø³Ø­ Ø¢Ù…Ù† Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
                        await db.collection('logs').doc('cleaning').set({ items: [] });
                        await db.collection('logs').doc('requests').set({ items: [] });
                        await db.collection('logs').doc('maint').set({ items: [] });
                        showCustomAlert('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª.', 'success');
                    } else if (pendingAction === 'newShift') { 
                        const batch = db.batch();
                        (await db.collection('rooms').get()).docs.forEach(d => batch.delete(d.ref));
                        (await db.collection('guestRequests').get()).docs.forEach(d => batch.delete(d.ref));
                        (await db.collection('activeMaintenance').get()).docs.forEach(d => batch.delete(d.ref));
                        await batch.commit();
                        showCustomAlert('ØªÙ… Ø¨Ø¯Ø¡ Ø´ÙØª Ø¬Ø¯ÙŠØ¯.', 'success');
                    } 
                    closeAllModals(); 
                } catch(e) { console.error(e); showCustomAlert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.", "error"); }
            } else { 
                showCustomAlert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø·Ø£', 'error'); 
                document.getElementById('admin-password').value = ''; 
            } 
        }

        // --- Helpers ---
        // âœ… Ø¥ØµÙ„Ø§Ø­ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ£Ø®ÙŠØ± Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø±Ø± (el)
        function setDelayReason(reason, el) { 
            document.getElementById('modal-delay').value = reason; 
            ['dly_work', 'dly_room', 'dly_other'].forEach(id => {
                const btn = document.getElementById(id);
                if(btn) { btn.style.background='#eee'; btn.style.color='#333'; }
            }); 
            if(el) { el.style.background='var(--danger)'; el.style.color='white'; }
        }

        function openFinishModal(id) { activeRoomId = id; const room = appState.rooms.find(r => r.id === id); if (!room) return; document.getElementById('delay-reason-section').style.display = room.status==='overdue' ? 'block' : 'none'; document.getElementById('modal-delay').value = ''; document.getElementById('repair-details-input').value = ''; document.getElementById('modal-img-camera-input').value = ''; document.getElementById('inpSendWhatsapp').checked = false; setRoomStatus('Ø¬Ø§Ù‡Ø²Ø©'); document.getElementById('final-modal').style.display = 'flex'; }
        function openCompleteMaintenanceModal(id) { activeMaintId = id; const maint = appState.activeMaintenance.find(m => m.id === id); if (!maint) return; document.getElementById('maint-room-num-display').innerText = `ØºØ±ÙØ© ${maint.num}`; document.getElementById('maint-img-camera-input').value = ''; document.getElementById('complete-maint-modal').style.display = 'flex'; }
        function openAddModal() { document.getElementById('inpRoomNum').value = ''; document.getElementById('room-dup-alert').style.display = 'none'; document.getElementById('inpRoomType').value = ''; document.getElementById('opt_out').classList.remove('selected'); document.getElementById('opt_stay').classList.remove('selected'); document.getElementById('inpSuperTurbo').checked = false; document.getElementById('inpRequestDetails').value = ''; document.getElementById('inpMaintDetails').value = ''; document.getElementById('inpMaintImage').value = ''; switchAddMode('cleaning'); setRequestMode('immediate'); setMaintMode('immediate'); document.getElementById('addRoomModal').style.display = 'flex'; }
        
        async function uploadToImgBB(file) { return new Promise((resolve) => { const reader = new FileReader(); reader.onload = function(e) { const img = new Image(); img.onload = function() { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const scale = 800 / Math.max(img.width, 800); canvas.width = img.width * scale; canvas.height = img.height * scale; ctx.drawImage(img, 0, 0, canvas.width, canvas.height); canvas.toBlob(function(blob) { const formData = new FormData(); formData.append('image', blob); fetch(`https://api.imgbb.com/1/upload?key=${CONFIG.imgbbKey}`, { method: 'POST', body: formData }).then(response => response.json()).then(data => resolve(data.data.url)).catch(() => resolve(null)); }, 'image/jpeg', 0.8); }; img.src = e.target.result; }; reader.readAsDataURL(file); }); }
        
        // --- UI & Utils ---
        function getFormattedDate() { return new Date().toLocaleDateString('ar-EG', { weekday: 'long', day: 'numeric', month: 'short' }); }
        function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
        function toggleTurboMode() { appState.turbo = !appState.turbo; saveData(); }
        function updateSearch() { appState.searchText = document.getElementById('search-bar').value; render(); }
        function showLogClearModal() { pendingAction = 'clearLog'; document.getElementById('admin-password').value = ''; document.getElementById('password-modal').style.display = 'flex'; }
        function showNewShiftModal() { pendingAction = 'newShift'; document.getElementById('admin-password').value = ''; document.getElementById('password-modal').style.display = 'flex'; }
        function closeAllModals() { document.querySelectorAll('.modal-overlay').forEach(modal => modal.style.display = 'none'); }
        function showCustomAlert(msg, type = 'info') { const modal = document.getElementById('customAlertModal'); const iconEl = document.getElementById('alertIcon'); const msgEl = document.getElementById('alertMessage'); if (type === 'success') { iconEl.innerHTML = 'âœ…'; iconEl.style.color = 'var(--success)'; } else if (type === 'error') { iconEl.innerHTML = 'âŒ'; iconEl.style.color = 'var(--danger)'; } else if (type === 'warning') { iconEl.innerHTML = 'âš ï¸'; iconEl.style.color = 'var(--warning)'; } else { iconEl.innerHTML = 'â„¹ï¸'; iconEl.style.color = 'var(--primary)'; } msgEl.innerText = msg; modal.style.display = 'flex'; }
        function closeCustomAlert() { document.getElementById('customAlertModal').style.display = 'none'; }
        function generateDailyReport() { let msg = `Adora | ğŸ“Š *ØªÙ‚Ø±ÙŠØ±*\nÙ…Ù†Ø¬Ø²: ${appState.guestRequestsLog ? appState.guestRequestsLog.length : 0}\nØµÙŠØ§Ù†Ø©: ${appState.activeMaintenance.length}`; window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank'); }
        function checkDuplicate() { const num = document.getElementById('inpRoomNum').value; const exists = appState.rooms.find(r => r.num == String(num)); const alertBox = document.getElementById('room-dup-alert'); if (exists) { alertBox.style.display = 'block'; alertBox.innerText = `âš ï¸ ${num} Ù…ÙˆØ¬ÙˆØ¯Ø©!`; } else { alertBox.style.display = 'none'; } }
        function toggleArchive(type) { const id = `${type}-archive-container`; const el = document.getElementById(id); appState.archiveViewLimit[type] = 5; el.style.display = el.style.display === 'block' ? 'none' : 'block'; render(); saveData(); }
        function loadMoreArchives(type) { appState.archiveViewLimit[type] += 5; render(); saveData(); }
        
        function switchAddMode(mode) { currentAddMode = mode; ['cleaning', 'request', 'maintenance'].forEach(m => { document.getElementById(`tab-${m}`).classList.remove('active', 'active-req', 'active-maint'); document.getElementById(`${m}-options`).style.display = 'none'; }); document.getElementById(`tab-${mode}`).classList.add(mode === 'request' ? 'active-req' : (mode === 'maintenance' ? 'active-maint' : 'active')); document.getElementById(`${mode}-options`).style.display = 'block'; document.getElementById('modal-title-add').innerText = { cleaning: 'Ø¥Ø¶Ø§ÙØ© ØºØ±ÙØ©', request: 'Ø·Ù„Ø¨ Ù†Ø²ÙŠÙ„', maintenance: 'ØªØ³Ø¬ÙŠÙ„ ØµÙŠØ§Ù†Ø©' }[mode]; }
        function setRequestMode(mode) { isImmediateRequest = (mode === 'immediate'); document.getElementById('btn-req-imm').style.background = isImmediateRequest ? 'var(--request-color)' : 'var(--bg-body)'; document.getElementById('btn-req-imm').style.color = isImmediateRequest ? 'white' : 'var(--text-main)'; document.getElementById('btn-req-sch').style.background = !isImmediateRequest ? 'var(--request-color)' : 'var(--bg-body)'; document.getElementById('btn-req-sch').style.color = !isImmediateRequest ? 'white' : 'var(--text-main)'; document.getElementById('request-schedule-container').style.display = isImmediateRequest ? 'none' : 'block'; }
        function setMaintMode(mode) { isImmediateMaint = (mode === 'immediate'); document.getElementById('btn-maint-imm').style.background = isImmediateMaint ? 'var(--maint-color)' : 'var(--bg-body)'; document.getElementById('btn-maint-imm').style.color = isImmediateMaint ? 'white' : 'var(--text-main)'; document.getElementById('btn-maint-sch').style.background = !isImmediateMaint ? 'var(--maint-color)' : 'var(--bg-body)'; document.getElementById('btn-maint-sch').style.color = !isImmediateMaint ? 'white' : 'var(--text-main)'; document.getElementById('maint-schedule-container').style.display = isImmediateMaint ? 'none' : 'block'; }
        function setRoomType(type) { document.getElementById('inpRoomType').value = type; document.getElementById('opt_out').style.background = type==='out'?'var(--primary)':'var(--bg-body)'; document.getElementById('opt_out').style.color = type==='out'?'white':'var(--text-main)'; document.getElementById('opt_stay').style.background = type==='stay'?'var(--primary)':'var(--bg-body)'; document.getElementById('opt_stay').style.color = type==='stay'?'white':'var(--text-main)'; document.getElementById('stayOptionsCleaning').style.display = type==='out'?'none':'block'; }
        function setGuestStatus(status) { document.getElementById('inpGuestStatus').value = status; document.getElementById('gst_clean_in').style.background = status==='in'?'var(--primary)':'var(--bg-body)'; document.getElementById('gst_clean_in').style.color = status==='in'?'white':'var(--text-main)'; document.getElementById('gst_clean_out').style.background = status==='out'?'var(--primary)':'var(--bg-body)'; document.getElementById('gst_clean_out').style.color = status==='out'?'white':'var(--text-main)'; }
        function setRoomStatus(status) { document.getElementById('modal-notes').value = status; document.getElementById('st_ready').style.background = status==='Ø¬Ø§Ù‡Ø²Ø©'?'var(--success)':'#eee'; document.getElementById('st_ready').style.color = status==='Ø¬Ø§Ù‡Ø²Ø©'?'white':'#333'; document.getElementById('st_maint').style.background = status!=='Ø¬Ø§Ù‡Ø²Ø©'?'var(--danger)':'#eee'; document.getElementById('st_maint').style.color = status!=='Ø¬Ø§Ù‡Ø²Ø©'?'white':'#333'; document.getElementById('maintenance-fields').style.display = status==='Ø¬Ø§Ù‡Ø²Ø©'?'none':'block'; }

        // --- Render Helpers ---
        function renderRooms() {
            let activeRooms = appState.rooms.filter(room => room.num.includes(appState.searchText) && room.status !== 'scheduled'); 
            activeRooms.sort((a, b) => { const statusOrder = { 'overdue': 0, 'acknowledging': 1, 'cleaning': 2, 'checking': 3 }; if (statusOrder[a.status] !== statusOrder[b.status]) return statusOrder[a.status] - statusOrder[b.status]; return (a.deadline - Date.now()) - (b.deadline - Date.now()); });
            let scheduledRooms = appState.rooms.filter(room => room.num.includes(appState.searchText) && room.status === 'scheduled'); scheduledRooms.sort((a,b) => a.schedTimestamp - b.schedTimestamp);
            document.getElementById('rooms-container').innerHTML = activeRooms.length ? activeRooms.map(room => createRoomCard(room)).join('') : '<p style="text-align:center;color:var(--text-sec);">Ù„Ø§ ØªÙˆØ¬Ø¯ ØºØ±Ù Ù†Ø´Ø·Ø©</p>';
            const schedContainer = document.getElementById('scheduled-rooms-container');
            if(scheduledRooms.length) { schedContainer.style.display = 'block'; schedContainer.innerHTML = '<div style="font-weight: bold; color: var(--sched-color); margin-bottom: 10px;">ğŸ“… ØºØ±Ù Ù…Ø¬Ø¯ÙˆÙ„Ø©</div>' + scheduledRooms.map(room => createRoomCard(room)).join(''); } else { schedContainer.style.display = 'none'; }
            updateTimersDOM(); renderUndoCountdowns();
        }
        function createRoomCard(room) {
            const isScheduled = room.status === 'scheduled'; const badgeText = room.type === 'out' ? 'Ø®Ø±ÙˆØ¬' : (room.guestStatus === 'in' ? 'Ù†Ø²ÙŠÙ„ Ø¯Ø§Ø®Ù„' : 'Ù†Ø²ÙŠÙ„ Ø®Ø§Ø±Ø¬'); const undoLeft = room.undoExpiry ? Math.ceil((room.undoExpiry - Date.now())/1000) : 0; const undoBtn = !isScheduled && room.undoExpiry && Date.now() < room.undoExpiry ? `<button class="glass-btn" style="padding:4px 8px; font-size:0.7rem; color:var(--text-sec);" onclick="undoRoom('${room.id}')">ØªØ±Ø§Ø¬Ø¹ (${undoLeft})</button>` : ''; 
            let actionBtn = '';
            if (isScheduled) { actionBtn = `<button class="glass-btn start" style="background:var(--sched-color)" onclick="forceStartScheduled('${room.id}', 'room')">Ø¨Ø¯Ø¡ Ø§Ù„Ø¢Ù† âš¡</button>`; } 
            else if (room.status === 'acknowledging') { actionBtn = `<button class="glass-btn start" onclick="promptAction('${room.id}', 'ack')">ÙˆØµÙ„Øª ğŸƒ</button>`; } 
            else if (room.status === 'cleaning') { actionBtn = `<button class="glass-btn" style="background:var(--warning); color:#333;" onclick="promptAction('${room.id}', 'clean')">Ù†Ø¸Ø§ÙØ© ğŸ§¹</button>`; } 
            else if (room.status === 'checking') { actionBtn = `<button class="glass-btn finish" onclick="openFinishModal('${room.id}')">Ø¥Ù†Ù‡Ø§Ø¡ âœ…</button>`; } 
            else if (room.status === 'overdue') { actionBtn = `<button class="glass-btn finish" style="background:var(--danger)" onclick="openFinishModal('${room.id}')">Ø¥Ù†Ù‡Ø§Ø¡ âš ï¸</button>`; }
            
            return `<div class="room-row status-${room.status}">
                <div class="timer-display" id="timer-${room.id}">--</div>
                <div style="display:flex; flex-direction:column; gap:5px;">
                    <div class="room-num">${room.num}</div>
                    <div style="display:flex; gap:5px; flex-wrap:wrap;">
                        <span class="badge">${badgeText}</span>
                        ${room.isSuperTurbo ? '<span class="badge" style="color:#ef6c00;">ğŸš€ Ø³ÙˆØ¨Ø±</span>' : ''}
                    </div>
                </div>
                <div style="flex:1;"></div>
                <div style="display:flex; flex-direction:column; align-items:flex-end; gap:5px;">${actionBtn}${undoBtn}</div>
            </div>`;
        }
        function renderGuestRequests() {
            let activeReqs = appState.guestRequests.filter(r => r.status !== 'scheduled'); activeReqs.sort((a, b) => (b.isUrgent ? 1 : 0) - (a.isUrgent ? 1 : 0));
            let scheduledReqs = appState.guestRequests.filter(r => r.status === 'scheduled'); scheduledReqs.sort((a,b) => a.schedTimestamp - b.schedTimestamp);
            document.getElementById('guest-requests-active-list').innerHTML = activeReqs.length ? activeReqs.map(req => createRequestCard(req)).join('') : '<p style="text-align:center;color:var(--text-sec); font-size:0.8rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>';
            const schedContainer = document.getElementById('scheduled-requests-container');
            if(scheduledReqs.length) { schedContainer.style.display = 'block'; schedContainer.innerHTML = '<div style="font-weight: bold; color: var(--sched-color); margin-bottom: 10px;">ğŸ“… Ø·Ù„Ø¨Ø§Øª Ù…Ø¬Ø¯ÙˆÙ„Ø©</div>' + scheduledReqs.map(req => createRequestCard(req)).join(''); } else { schedContainer.style.display = 'none'; }
            const archiveContainer = document.getElementById('guest-requests-archive-list');
            if (!appState.guestRequestsLog || appState.guestRequestsLog.length === 0) { archiveContainer.innerHTML = '<p style="text-align:center;color:var(--text-sec); font-size:0.7rem;">Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙØ§Ø±Øº</p>'; document.getElementById('btn-more-req').style.display = 'none'; } else { appState.guestRequestsLog.sort((a,b) => b.id - a.id); const visibleLogs = appState.guestRequestsLog.slice(0, appState.archiveViewLimit.req); archiveContainer.innerHTML = visibleLogs.map(item => createLogRow(item)).join(''); document.getElementById('btn-more-req').style.display = appState.guestRequestsLog.length > appState.archiveViewLimit.req ? 'block' : 'none'; }
        }
        function createRequestCard(req) { 
            const isScheduled = req.status === 'scheduled'; 
            let actionBtn = !isScheduled ? `<button class="glass-btn finish" onclick="completeRequest('${req.id}')">ØªÙ… âœ…</button>` : `<button class="glass-btn start" style="background:var(--sched-color)" onclick="forceStartScheduled('${req.id}', 'req')">Ø¨Ø¯Ø¡ âš¡</button>`;
            return `<div class="room-row status-request ${isScheduled ? ' status-scheduled' : ''}"><div class="timer-display ${isScheduled ? 'timer-sched' : 'timer-req'}" id="req-timer-${req.id}">--</div><div style="display:flex; flex-direction:column; gap:5px;"><div class="room-num">${req.num}</div><div style="display:flex; gap:5px;">${req.isUrgent ? '<span class="rotating-border-badge req-active">Ø¹Ø§Ø¬Ù„</span>' : '<span class="badge">Ø·Ù„Ø¨</span>'}</div><div style="font-size:0.75rem; color:var(--text-sec);">${req.details}</div></div><div style="flex:1;"></div><div>${actionBtn}</div></div>`; 
        }
        function renderAllLogs() {
            const cleaningLog = appState.log || []; cleaningLog.sort((a, b) => b.id - a.id || 0); renderLogSection(cleaningLog, 'cleaning-log-list', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª');
            let activeMaint = appState.activeMaintenance.filter(m => m.status !== 'scheduled');
            let scheduledMaint = appState.activeMaintenance.filter(m => m.status === 'scheduled'); scheduledMaint.sort((a,b) => a.schedTimestamp - b.schedTimestamp);
            document.getElementById('maintenance-active-list').innerHTML = activeMaint.length ? activeMaint.map(m => createMaintenanceCard(m)).join('') : '<p style="text-align:center;color:var(--text-sec);font-size:0.8rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙŠØ§Ù†Ø© Ù†Ø´Ø·Ø©</p>';
            const schedMaintContainer = document.getElementById('scheduled-maintenance-container');
            if(scheduledMaint.length) { schedMaintContainer.style.display = 'block'; schedMaintContainer.innerHTML = '<div style="font-weight: bold; color: var(--sched-color); margin-bottom: 10px;">ğŸ“… ØµÙŠØ§Ù†Ø© Ù…Ø¬Ø¯ÙˆÙ„Ø©</div>' + scheduledMaint.map(m => createMaintenanceCard(m)).join(''); } else { schedMaintContainer.style.display = 'none'; }
            const maintLog = appState.completedMaintenanceLog || []; maintLog.sort((a, b) => b.id - a.id); const maintArchiveContainer = document.getElementById('maintenance-archive-list');
            if (maintLog.length === 0) { maintArchiveContainer.innerHTML = '<p style="text-align:center;color:var(--text-sec); font-size:0.7rem;">Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙØ§Ø±Øº</p>'; document.getElementById('btn-more-maint').style.display = 'none'; } else { const visibleMaint = maintLog.slice(0, appState.archiveViewLimit.maint); maintArchiveContainer.innerHTML = visibleMaint.map(item => createLogRow(item)).join(''); document.getElementById('btn-more-maint').style.display = maintLog.length > appState.archiveViewLimit.maint ? 'block' : 'none'; }
        }
        function createMaintenanceCard(maint) {
             const isScheduled = maint.status === 'scheduled';
             let actionBtn = !isScheduled ? `<button class="glass-btn finish" onclick="openCompleteMaintenanceModal('${maint.id}')">Ø¥Ù†Ù‡Ø§Ø¡</button>` : `<button class="glass-btn start" style="background:var(--sched-color)" onclick="forceStartScheduled('${maint.id}', 'maint')">Ø¨Ø¯Ø¡ âš¡</button>`;
             let imgBtn = (maint.maintImg && !isScheduled) ? `<a href="${maint.maintImg}" target="_blank" class="glass-btn img-link">ğŸ“· ØµÙˆØ±Ø©</a>` : '';
             return `<div class="room-row status-maintenance ${isScheduled ? ' status-scheduled' : ''}"><div class="timer-display ${isScheduled ? 'timer-sched' : 'timer-maint'}" id="maint-timer-${maint.id}">0:00</div><div style="display:flex; flex-direction:column; gap:5px;"><div class="room-num">${maint.num}</div><div style="display:flex; gap:5px;"><span class="${isScheduled ? 'badge' : 'rotating-border-badge'}">ØµÙŠØ§Ù†Ø© Ù†Ø´Ø·Ø©</span></div><div style="font-size:0.75rem; color:var(--text-sec); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:120px;">${maint.maintDesc}</div></div><div style="flex:1;"></div><div style="display:flex; flex-direction:column; align-items:flex-end;">${actionBtn}${imgBtn}</div></div>`;
        }
        function renderLogSection(data, elementId, emptyMsg) { const listEl = document.getElementById(elementId); if (!data || data.length === 0) { listEl.innerHTML = `<p style="text-align:center;color:var(--text-sec);">${emptyMsg}</p>`; return; } const recent = data.slice(0, 10); listEl.innerHTML = recent.map(item => createLogRow(item)).join(''); }
        function createLogRow(item) {
            const historyText = item.history ? item.history.map(h => `${h.action}: ${h.time}`).join(' | ') : `ÙˆÙ‚Øª: ${item.time}`; let statusBadge = item.status; if (item.finishImg) statusBadge = 'Ù…Ù†Ø¬Ø²Ø© âœ…'; else if (item.maintDesc && !item.finishImg && item.type !== 'request') statusBadge = 'Ø¹Ø·Ù„ ğŸ› ï¸'; if (item.type === 'request') statusBadge = 'Ù…Ù†ÙØ° âœ…'; const dateStr = getFormattedDate(); let maintDetails = ''; 
            if (item.maintDesc) { maintDetails += `<div style="font-size:0.7rem; color:var(--danger); margin-top:2px;">**${item.type === 'request' ? 'Ø§Ù„Ø·Ù„Ø¨' : 'Ø§Ù„Ø¹Ø·Ù„'}:** ${item.maintDesc}</div>`; if (item.maintImg) maintDetails += `<a href="${item.maintImg}" target="_blank" class="glass-btn img-link" style="width:auto; padding:2px 8px;">ØµÙˆØ±Ø©</a>`; } 
            return `<div style="border-bottom:1px solid var(--border-color); padding:8px; display:flex; flex-direction:column;"><div style="display:flex; justify-content:space-between; align-items:center;"><div><strong>${item.num} <span style="font-size:0.7rem; color:var(--text-sec); font-weight:normal;">- ${dateStr}</span></strong></div><div style="text-align:left"><span class="badge">${statusBadge}</span></div></div>${maintDetails}</div>`;
        }
        
        function renderGuestRequestTimers() { 
            if (!appState.guestRequests) return; const now = Date.now();
            appState.guestRequests.forEach(req => { const el = document.getElementById(`req-timer-${req.id}`); if (!el) return; if (req.status === 'scheduled' && req.schedTimestamp) { const diff = req.schedTimestamp - now; if (diff > 0) { const m = Math.floor(diff / 60000); el.innerText = `${m}Ø¯`; el.className = 'timer-display timer-sched'; } else { el.innerText = 'Ø¨Ø¯Ø¡..'; } } else { const diff = now - req.startTime; const h = Math.floor(diff / 3600000); const m = Math.floor((diff % 3600000) / 60000); const s = Math.floor((diff % 60000) / 1000); el.innerText = `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`; el.className = 'timer-display timer-req'; } }); 
        }
        function renderUndoCountdowns() { appState.rooms.forEach(room => { const btn = document.querySelector(`[onclick="undoRoom('${room.id}')"]`); if (btn && room.undoExpiry) { const left = Math.ceil((room.undoExpiry - Date.now()) / 1000); if (left <= 0) { btn.style.display = 'none'; return; } btn.innerText = `ØªØ±Ø§Ø¬Ø¹ (${left})`; } }); }
        
        function updateStats() { 
            const outDone = appState.log.filter(item => item.type === 'out').length; const stayDone = appState.log.filter(item => item.type === 'stay').length;
            document.getElementById('stat-out-done').innerText = outDone; document.getElementById('stat-stay-done').innerText = stayDone;
            document.getElementById('stat-active').innerText = appState.rooms.filter(room => room.status !== 'scheduled').length; 
            document.getElementById('stat-late').innerText = appState.rooms.filter(room => room.status === 'overdue').length; 
            document.getElementById('stat-maint-done').innerText = appState.activeMaintenance.length;
            document.getElementById('stat-maint-total').innerText = appState.completedMaintenanceLog ? appState.completedMaintenanceLog.length : 0;
            const reqBox = document.getElementById('stat-req-box'); const reqText = document.getElementById('stat-req-text');
            const activeReqs = appState.guestRequests ? appState.guestRequests.filter(r => r.status !== 'scheduled') : [];
            if (activeReqs.length > 0) { const latest = activeReqs[activeReqs.length - 1]; reqText.innerText = `${latest.num}: ${latest.details}`; reqBox.classList.add('pulse-urgent-box'); reqBox.querySelector('span').style.color = 'var(--danger)'; } 
            else if (appState.guestRequestsLog && appState.guestRequestsLog.length > 0) { const lastDone = appState.guestRequestsLog[0]; reqText.innerText = `âœ… ØªÙ…: ${lastDone.num}`; reqBox.classList.remove('pulse-urgent-box'); reqBox.querySelector('span').style.color = 'var(--success)'; } 
            else { reqText.innerText = 'Ù„Ø§ ØªÙˆØ¬Ø¯'; reqBox.classList.remove('pulse-urgent-box'); reqBox.querySelector('span').style.color = 'var(--text-sec)'; }
        }

        function updateTimersDOM() { 
            const now = Date.now(); 
            appState.rooms.forEach(room => { 
                const el = document.getElementById(`timer-${room.id}`); if (!el) return; 
                if (room.status === 'scheduled' && room.schedTimestamp) { 
                    const diff = room.schedTimestamp - now; 
                    if (diff > 0) { const m = Math.floor(diff / 60000); el.innerText = `${m}Ø¯`; el.className = 'timer-display timer-sched'; } else { el.innerText = 'Ø¨Ø¯Ø¡..'; } 
                } else { 
                    const diff = room.deadline - now; 
                    const m = Math.floor(Math.abs(diff) / 60000); const s = Math.floor((Math.abs(diff) % 60000) / 1000); 
                    el.innerText = `${diff < 0 ? '+' : ''}${m}:${s.toString().padStart(2, '0')}`; el.className = `timer-display ${diff < 0 ? 'timer-danger' : 'timer-active'}`; 
                    if (diff < 0 && room.status !== 'overdue') { db.collection('rooms').doc(room.id).update({ status: 'overdue' }).catch(e => console.error(e)); }
                } 
            }); 
            appState.activeMaintenance.forEach(maint => { 
                const el = document.getElementById(`maint-timer-${maint.id}`); if (!el) return; 
                if (maint.status === 'scheduled' && maint.schedTimestamp) { 
                    const diff = maint.schedTimestamp - now; 
                    if (diff > 0) { const m = Math.floor(diff / 60000); el.innerText = `${m}Ø¯`; el.className = 'timer-display timer-sched'; } else { el.innerText = 'Ø¨Ø¯Ø¡..'; } 
                } else { 
                    const diff = now - maint.startTime; const h = Math.floor(diff / 3600000); const m = Math.floor((diff % 3600000) / 60000); const s = Math.floor((diff % 60000) / 1000); 
                    el.innerText = `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`; 
                } 
            }); 
        }
        
        function checkScheduledItems() { 
            if (!db) return;
            const now = Date.now(); 
            appState.rooms.filter(r => r.status === 'scheduled' && r.schedTimestamp && now >= r.schedTimestamp).forEach(r => db.collection('rooms').doc(r.id).update({ status: 'acknowledging', startTime: now, deadline: now + CONFIG.times.TRAVEL, undoExpiry: now + 15000, schedTimestamp: firebase.firestore.FieldValue.delete() }).catch(e => console.error(e)));
            appState.guestRequests.filter(r => r.status === 'scheduled' && r.schedTimestamp && now >= r.schedTimestamp).forEach(r => db.collection('guestRequests').doc(r.id).update({ status: 'active', startTime: now, schedTimestamp: firebase.firestore.FieldValue.delete() }).catch(e => console.error(e)));
            appState.activeMaintenance.filter(m => m.status === 'scheduled' && m.schedTimestamp && now >= m.schedTimestamp).forEach(m => db.collection('activeMaintenance').doc(m.id).update({ status: 'active', startTime: now, schedTimestamp: firebase.firestore.FieldValue.delete() }).catch(e => console.error(e)));
        }
    </script>
</body>
</html>
