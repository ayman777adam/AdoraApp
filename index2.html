
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø¸Ø§Ù… ÙÙ†Ø¯Ù‚ Ø£Ø¨ÙŠÙ„Ø§</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #f4f6f8;
            --bg-card: #ffffff;
            --text-main: #37474f;
            --text-sec: #78909c;
            --border-color: #cfd8dc;
            --primary: #0097a7;       /* Teal Primary (Reverted) */
            --primary-light: #e0f7fa; /* Lighter Teal */
            --success: #00b894;
            --danger: #d63031;
            --warning: #f1c40f;
            --upgrade: #7e57c2;
            --gold-btn: #FFD700;     /* New Gold Button Color */
            --shadow: 0 4px 20px rgba(0, 151, 167, 0.08);
        }

        body.dark-mode {
            --bg-body: #1e1e1e;
            --bg-card: #2d2d2d;
            --text-main: #dfe6e9;
            --text-sec: #b2bec3;
            --border-color: #444;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-body);
            background-image: radial-gradient(#b0bec5 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text-main);
            margin: 0;
            padding: 15px 15px 130px 15px; /* Adjusted padding for fixed footer */
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }
        body.dark-mode { background-image: none; }

        .container { max-width: 500px; margin: 0 auto; }

        /* --- Header --- */
        .header-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid #fff;
            border-radius: 20px; padding: 15px; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow);
        }
        body.dark-mode .header-glass { background: rgba(45,45,45,0.7); border-color:rgba(255,255,255,0.1); }
        
        .header-title { display: flex; align-items: center; gap: 10px; flex: 1; }
        .header-title h1 { font-size: 1rem; margin: 0; color: var(--primary); font-weight: 800; line-height: 1.2; }
        
        /* Toggle Button Styles Removed */

        .tools-area { display: flex; gap: 8px; }
        .tools-btn { background: var(--bg-body); border: 1px solid var(--border-color); padding: 8px; border-radius: 10px; cursor: pointer; }

        /* --- VIEW CONTROLLERS --- */
        .worker-view { display: block; width: 100%; animation: fadeIn 0.3s; }
        .staff-view { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- UI Elements --- */
        .card, .section { background: var(--bg-card); border-radius: 18px; padding: 15px; box-shadow: var(--shadow); border: 1px solid var(--border-color); margin-bottom: 15px; }
        .sec-title { font-weight: 700; color: var(--primary); margin-bottom: 15px; border-bottom: 1px dashed var(--border-color); padding-bottom: 8px; }
        
        /* Log Title (clickable) */
        .log-title-clickable { cursor: pointer; display: flex; justify-content: space-between; align-items: center; }

        /* --- Worker UI Specifics --- */
        .room-row {
            background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px;
            padding: 10px; margin-bottom: 10px; 
            /* Grid: Timer | Room# | Type | Button */
            display: grid; grid-template-columns: 50px 0.8fr 1fr auto; gap: 8px;
            align-items: center; border-right: 4px solid transparent; transition: 0.3s;
        }
        .room-row.status-cleaning { border-right-color: var(--primary); background: #f0fbfc; }
        .room-row.status-checking_live { border-right-color: var(--warning); background: #fffde7; }
        .room-row.status-checking { border-right-color: var(--success); background: #f0fbfc; }
        .room-row.status-over { border-right-color: var(--danger); background: #ffebee; animation: pulseRed 2s infinite; }
        .room-row.status-acknowledging { border-right-color: var(--upgrade); background: #f3e5f5; } 
        
        @keyframes pulseRed { 0% {box-shadow: 0 0 0 0 rgba(214, 48, 49, 0.4);} 70% {box-shadow: 0 0 0 10px rgba(214, 48, 49, 0);} 100% {box-shadow: 0 0 0 0 rgba(214, 48, 49, 0);} }

        .timer-display { font-weight: 800; font-size: 1rem; text-align: center; color: var(--text-sec); }
        .timer-active { color: var(--primary); }
        .timer-danger { color: var(--danger); }
        
        .room-input { 
            width: 100%; border: none; background: transparent; font-size: 1.1rem; font-weight: 800; 
            text-align: center; color: var(--text-main); border-bottom: 2px dashed #ddd; 
        }
        
        .type-select {
            width: 100%; padding: 5px; border-radius: 8px; border: 1px solid var(--border-color);
            background: var(--bg-body); font-size: 0.75rem; font-weight: bold; color: var(--text-main);
            margin-bottom: 4px; /* Space before sub-select */
        }
        .sub-select-container { 
             display: flex; flex-direction: column; 
             gap: 4px;
             padding-top: 4px;
        }

        .btn-action { padding: 8px 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: #fff; font-size: 0.8rem; }
        .btn-start { background: var(--primary); }
        .btn-check { background: var(--warning); color: #333; font-size: 0.7rem; }
        .btn-finish { background: var(--success); }
        .btn-undo { background: #fab1a0; color: var(--danger); margin-top: 5px; font-size: 0.6rem; width: 100%; }

        .badge { font-size: 0.6rem; padding: 2px 4px; border-radius: 4px; background: #eee; color: #666; display: block; margin-top: 2px; }

        /* Indicators */
        .quiet-notif { background: var(--warning); color: #333; padding: 8px; text-align: center; border-radius: 8px; font-size: 0.8rem; font-weight: bold; margin-bottom: 10px; display: none; }
        
        /* Stats Grid */
        .stats-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 10px 5px; 
            text-align: center; 
            margin-bottom: 15px; 
        }
        .stat-box h4 { margin: 0; font-size: 1.2rem; color: var(--upgrade); }
        .stat-box span { font-size: 0.7rem; color: var(--text-sec); }
        
        /* New Stat Boxes for Clean Look */
        .stat-box-item {
            padding: 6px 4px; 
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            background: var(--bg-body);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .stat-box-item h4 {
            font-size: 1.0rem; 
        }
        .stat-box-item span {
            font-size: 0.55rem; 
        }

        /* Stats Circular Visualization */
        .stat-circle-box {
            text-align: center;
        }
        .circle-viz {
            width: 70px; 
            height: 70px; 
            border-radius: 50%;
            margin: 0 auto 5px auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--bg-body);
            /* Soft 3D Shadow Effect */
            box-shadow: 4px 4px 8px rgba(0,0,0,0.1), -4px -4px 8px rgba(255,255,255,0.8); 
            border: 5px solid var(--bg-body); 
            transition: 0.3s;
        }
        .circle-viz h3 {
            margin: 0;
            font-size: 1.4rem; 
            color: var(--text-main);
        }
        .circle-viz span {
            font-size: 0.6rem; 
            color: var(--text-sec);
        }

        /* Modal */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: var(--bg-card); padding: 20px; border-radius: 20px; width: 90%; max-width: 350px; }
        .modal-content select, .modal-content input, .modal-content textarea { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; }
        .modal-label { font-size: 0.85rem; font-weight: 700; margin-bottom: 5px; display: block; color: var(--text-main); }
        .required-field { border: 2px solid var(--danger) !important; }

        /* Footer */
        .sticky-footer {
            position: fixed; bottom: 35px; /* Lift above the dev footer */
            left: 0; width: 100%;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color); padding: 15px; box-sizing: border-box;
            border-radius: 20px 20px 0 0; z-index: 999;
        }
        body.dark-mode .sticky-footer { background: rgba(30,30,30,0.95); }
        .full-btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1rem; color: white; }
        
        /* Confirmation Toast Style */
        .worker-toast {
            position: fixed; 
            top: 65px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: var(--upgrade); 
            color: white; 
            padding: 8px 15px; 
            border-radius: 20px;
            font-size: 0.9rem; 
            font-weight: 700; 
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s, transform 0.3s; 
            z-index: 1500;
        }
        .worker-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        /* Camera Input Styling */
        #camera-label {
            display: block;
            background: var(--primary);
            color: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        #camera-label:active { background: #007983; }
        #file-label {
            display: block;
            background: var(--text-sec);
            color: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        #file-label:active { background: #5a6d75; }
        #modal-img-camera-input, #modal-img-pdf-input {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }
        
        /* Fixed Developer Footer */
        #dev-footer-fixed {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 0.7rem;
            color: #90a4ae; 
            background: var(--bg-card); 
            padding: 5px 0;
            border-top: 1px solid var(--border-color);
            z-index: 1000;
        }
        
        /* New: Consolidated Action Row */
        .worker-action-row {
            display: flex; 
            gap: 10px; 
            width: 100%; 
            margin-bottom: 10px; 
            flex-wrap: wrap; 
        }
        .worker-action-row .full-btn {
            flex: 1 1 48%; 
        }
    </style>
</head>
<body class="worker-mode"> <div class="container">
        <div class="header-glass">
            <div class="header-title" style="align-items:center; gap:12px;">
                <h1 id="header-text" style="margin:0;">ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ø§Ù„<br><span style="font-size:0.7rem; opacity:0.7;">ØªØªØ¨Ø¹ Ø§Ù„ØºØ±Ù</span></h1>

                <!-- Ø²Ø± Ø§Ù„Ù„ØºØ© (ÙŠÙ…ÙŠÙ† Ø¬Ù†Ø¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†) -->
                <div id="lang-container" style="margin-left:6px; display:flex; align-items:center;">
                    <div style="position:relative; display:inline-block;">
                        <button id="langBtn" class="tools-btn" style="padding:6px 10px; font-weight:700;">ğŸŒ Ø§Ù„Ù„ØºØ© â–¾</button>
                        <div id="langMenu" style="position:absolute; top:38px; right:0; display:none; background:#fff; border:1px solid var(--border-color); border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.12); z-index:9999; min-width:140px; overflow:hidden;">
                            <div class="langItem" data-lang="ar" style="padding:10px 12px; cursor:pointer; white-space:nowrap;">Ø¹Ø±Ø¨ÙŠ</div>
                            <div class="langItem" data-lang="en" style="padding:10px 12px; cursor:pointer; white-space:nowrap;">English</div>
                            <div class="langItem" data-lang="ur" style="padding:10px 12px; cursor:pointer; white-space:nowrap;">Ø§Ø±Ø¯Ùˆ</div>
                            <div class="langItem" data-lang="bn" style="padding:10px 12px; cursor:pointer; white-space:nowrap;">à¦¬à¦¾à¦‚à¦²à¦¾</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tools-area">
                <button class="tools-btn" onclick="document.body.classList.toggle('dark-mode')">ğŸŒ™</button>
            </div>
        </div>

        <div class="worker-view">
            <div id="worker-toast" class="worker-toast"></div>
            
            <div id="offline-indicator" class="quiet-notif" style="background:var(--danger); color:white;">âš ï¸ ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„: ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹</div>
            <div id="rain-mode-indicator" class="quiet-notif" style="background:var(--upgrade); color:white;">âš¡ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙŠØ±Ø¨Ùˆ Ù…ÙØ¹Ù‘Ù„</div>
            <div id="timer-alert-bar" class="quiet-notif">âš ï¸ Ø§Ù†ØªØ¨Ù‡: ÙŠÙˆØ¬Ø¯ ØºØ±Ù ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯!</div>

            <div class="section" style="margin-bottom:15px;">
                <div class="worker-action-row" style="margin-bottom: 0;">
                    <button id="turbo-mode-btn" class="full-btn" style="background:var(--success); font-size:0.9rem; flex: 1;" onclick="toggleTurboMode()">
                        ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙŠØ±Ø¨Ùˆ Ù„ÙƒÙ„ Ø§Ù„ØºØ±Ù - Ø§Ù„Ù…ÙˆØ§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
                    </button>
                    <button id="report-btn-action" class="full-btn" style="background:var(--gold-btn); color: var(--text-main); font-size:0.9rem; flex: 1;" onclick="generateDailyReport()">
                         Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ø¸Ø§ÙØ© Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ù„Ø§Ø¯Ø§Ø±Ù‡
                    </button>
                </div>
            </div>


            <div class="section" style="padding:15px;">
                <div class="sec-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>ğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span>
                    <button class="tools-btn" style="padding: 5px 8px;" onclick="showResetModal()">ğŸ—‘ï¸</button>
                </div>
                
                <div class="stats-grid" style="grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    
                    <div class="stat-circle-box">
                        <div class="circle-viz" style="border: 5px solid var(--danger);">
                            <h3 id="fastest-out-num">--</h3>
                            <span id="fastest-out-time">Ø£Ø³Ø±Ø¹ Ø®Ø±ÙˆØ¬</span>
                        </div>
                    </div>

                    <div class="stat-circle-box">
                        <div class="circle-viz" style="border: 5px solid var(--primary);">
                            <h3 id="fastest-stay-num">--</h3>
                            <span id="fastest-stay-time">Ø£Ø³Ø±Ø¹ Ø³Ø§ÙƒÙ†</span>
                        </div>
                    </div>
                    
                </div>
                
                <div style="border-top: 1px dashed var(--border-color); margin-top: 0; padding-top: 15px;">
                    <div class="stats-grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 10px 5px;">
                        
                        <div class="stat-box-item"><h4 id="stat-completed">0</h4><span style="color:var(--upgrade)">ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</span></div>
                        <div class="stat-box-item"><h4 id="stat-avg">0Ø¯</h4><span style="color:var(--text-sec)">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø²Ù…Ù†</span></div>
                        <div class="stat-box-item"><h4 id="stat-over">0</h4><span style="color:var(--danger)">ØªØ£Ø®ÙŠØ±</span></div>
                        
                        <div class="stat-box-item"><h4 id="stat-out-count">0</h4><span style="color:var(--danger)">ØºØ±Ù Ø®Ø±ÙˆØ¬</span></div>
                        <div class="stat-box-item"><h4 id="stat-stay-count">0</h4><span style="color:var(--primary)">ØºØ±Ù Ø³Ø§ÙƒÙ†</span></div>
                        <div class="stat-box-item"><h4 id="stat-max-time">--</h4><span style="color:var(--warning)">Ø£Ù‚ØµÙ‰ ÙˆÙ‚Øª ØªÙ†Ø¸ÙŠÙ</span></div>
                        
                        <div class="stat-box-item"><h4 id="stat-min-time">--</h4><span style="color:var(--success)">Ø£Ø¯Ù†Ù‰ ÙˆÙ‚Øª ØªÙ†Ø¸ÙŠÙ</span></div>
                        <div class="stat-box-item" style="background:#f4f6f8; box-shadow:none;"></div> <div class="stat-box-item" style="background:#f4f6f8; box-shadow:none;"></div> </div>
                </div>
            </div>

            <div class="section">
                <div class="sec-title">ğŸšª ØªØªØ¨Ø¹ Ø§Ù„ØºØ±Ù (Ø¬Ø¯ÙˆÙ„ Ø°ÙƒÙŠ)</div>
                <div id="rooms-container">
                    </div>
            </div>

            <div class="section">
                <div class="sec-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>ğŸ“‹ Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</span>
                    <button class="tools-btn" style="padding: 5px 8px; font-size: 1.1rem;" onclick="showLogClearModal()">ğŸ—‘ï¸</button>
                </div>
                <div id="worker-log-list" style="font-size:0.8rem; max-height:200px; overflow-y:auto;">
                    <p style="text-align:center; color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø¹Ø¯</p>
                </div>
            </div>
        </div>

        </div>

    <div class="sticky-footer">
        <div class="worker-view">
            </div>
        </div>

    <div id="dev-footer-fixed">
        ØªØ·ÙˆÙŠØ± .. Ø§ÙŠÙ…Ù† Ø§Ø¨Ùˆ ÙˆØ±Ø¯Ù‡ 77aayy@gmail.com
    </div>

    <div id="rain-prompt-modal" class="modal-overlay">
        <div class="modal-content" style="text-align:center;">
            <h3 style="color:var(--primary); margin-top:0;">Ø§Ø®ØªØ± ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø¯Ø¡</h3>
            <p>Ù…Ø§ Ù‡Ùˆ ÙˆØ¶Ø¹ Ø§Ù„Ø¶ØºØ· Ù„Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©ØŸ</p>
            <button class="full-btn" style="background:var(--danger); margin-bottom:10px;" onclick="commitStartRoom(window.tempRoomId, true)">âš¡ Ø¶ØºØ· Ø¹Ø§Ù„ÙŠ (Rain Mode)</button>
            <button class="full-btn" style="background:var(--success);" onclick="commitStartRoom(window.tempRoomId, false)">ÙˆØ¶Ø¹ Ø¹Ø§Ø¯ÙŠ (Normal)</button>
        </div>
    </div>

    <div id="final-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0; color:var(--primary);" id="modal-title-text">ğŸ“ ØªÙ‚Ø±ÙŠØ± ÙØ­Øµ Ø§Ù„ØºØ±ÙØ©</h3>
            
            <div id="delay-reason-section"> 
                <label class="modal-label" id="delay-reason-label">Ø³Ø¨Ø¨ Ø§Ù„ØªØ£Ø®ÙŠØ± (Ø¥Ù† ÙˆØ¬Ø¯):</label>
                <select id="modal-delay" onchange="updateImageRequirementUI()">
                    <option value="Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ£Ø®ÙŠØ±">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ£Ø®ÙŠØ±</option>
                    <option value="Ø§Ù„Ø§Ù†Ø´ØºØ§Ù„ Ø¨Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„">Ø§Ù„Ø§Ù†Ø´ØºØ§Ù„ Ø¨Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</option>
                    <option value="Ø§Ù„ØºØ±ÙØ© Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙƒØ«ÙŠØ±Ø©">Ø§Ù„ØºØ±ÙØ© Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙƒØ«ÙŠØ±Ø©</option>
                    <option value="Ø³Ø¨Ø¨ Ø¢Ø®Ø±">Ø³Ø¨Ø¨ Ø¢Ø®Ø±</option>
                </select>
            </div>


            <label class="modal-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙØ­Øµ:</label>
            <select id="modal-notes" onchange="updateMaintenanceUI()">
                <option value="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</option>
                <option value="ØªØ­ØªØ§Ø¬ ØµÙŠØ§Ù†Ø©">ØªØ­ØªØ§Ø¬ ØµÙŠØ§Ù†Ø©</option>
                <option value="Ù†Ù‚Øµ Ù…ÙØ§Ø±Ø´">Ù†Ù‚Øµ Ù…ÙØ§Ø±Ø´</option>
                <option value="Deep Clean Needed">ØªØ­ØªØ§Ø¬ Ù†Ø¸Ø§ÙØ© Ø¹Ù…ÙŠÙ‚Ø©</option>
            </select>
            
            <div id="maintenance-fields" style="border: 1px dashed var(--warning); padding: 10px; border-radius: 8px; margin-bottom: 10px; display: none;">
                <label class="modal-label" style="color:var(--danger);">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØµÙŠØ§Ù†Ø© (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ):</label>
                <textarea id="repair-details-input" placeholder="Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ ØµÙŠØ§Ù†Ø©ØŸ"></textarea>
                
                <label class="modal-label">Ø­Ø§Ù„Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©:</label>
                <select id="repair-status-select" onchange="updateMaintenanceImageStatus()">
                    <option value="Ongoing">Ø¬Ø§Ø±ÙŠØ©</option>
                    <option value="Completed">ØªÙ…Øª Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø© (ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©)</option>
                </select>
            </div>

            <label class="modal-label" id="image-label">Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©:</label>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <label id="camera-label" for="modal-img-camera-input">
                    ğŸ“¸ Ø§ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                </label>
                <input type="file" accept="image/*" capture="environment" id="modal-img-camera-input">
                
                <label id="file-label" for="modal-img-pdf-input">
                     ğŸ“„ Ø±ÙØ¹ Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¯ÙŠÙˆ (ØµÙˆØ±Ø©/PDF)
                </label>
                <input type="file" accept="image/*, application/pdf" multiple id="modal-img-pdf-input">
            </div>
            <div style="font-size:0.7rem; color:#999; margin-top:5px; margin-bottom:10px;">(ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·)</div>

            <button class="full-btn" style="background:var(--success); margin-top:10px;" onclick="confirmFinishRoom()">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„ ğŸš€</button>
            <button class="full-btn" style="background:#ddd; color:#333;" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
    
    <div id="password-modal" class="modal-overlay">
        <div class="modal-content" style="text-align:center;">
            <h3 style="color:var(--danger); margin-top:0;" id="password-modal-title">ØªØµÙÙŠØ© Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
            <p id="reset-status-msg" style="font-size:0.9rem;">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</p>
            
            <input type="password" id="admin-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="width:100%; margin-bottom:15px;" />

            <button id="confirm-reset-btn" class="full-btn" style="background:var(--success); margin-bottom:10px;" onclick="checkPasswordAndReset('full_reset')">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØµÙÙŠØ©</button>
            <button class="full-btn" style="background:#ddd; color:#333;" onclick="document.getElementById('password-modal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
    
    <div id="action-confirm-modal" class="modal-overlay">
        <div class="modal-content" style="text-align:center;">
            <h3 id="confirm-title" style="color:var(--danger); margin-top:0;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</h3>
            <p id="confirm-message" style="font-size:0.9rem;">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ</p>
            
            <button id="confirm-yes-btn" class="full-btn" style="background:var(--success); margin-bottom:10px;">Ù†Ø¹Ù…ØŒ Ø£Ø¤ÙƒØ¯</button>
            <button class="full-btn" style="background:#ddd; color:#333;" onclick="document.getElementById('action-confirm-modal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>


    <script>
        // --- CONFIG & STATE ---
        const ADMIN_PASSWORD = "fahd5"; // Admin password for reset
        const TRAVEL_TIME_MS = 15 * 60 * 1000; // 15 minutes travel time
        let isTurboMode = false; // NEW: Global Turbo Mode
        let workerState = { rooms: [], log: [] };
        let buffer = [];

        // --- INIT ---
        window.onload = () => {
            loadState();
            renderRooms();
            updateStats();
            setInterval(tick, 1000); 
            checkConn();
            window.addEventListener('online', checkConn);
            window.addEventListener('offline', checkConn);
        };

        // --- HAPTIC & CONFIRMATION ---
        function vibrate(ms) {
            if (navigator.vibrate) navigator.vibrate(ms);
        }

        function showConfirmation(msg) {
            const toast = document.getElementById('worker-toast');
            if (!toast) return;
            toast.innerText = msg;
            toast.classList.add('show');
            vibrate(20); 
            setTimeout(() => toast.classList.remove('show'), 1500);
        }
        
        // NEW: Audible alert generator
        function playAlertSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); 
                gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);

                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.1); 
            } catch (e) {
                console.warn("Audio Context not supported or failed to start.");
            }
        }
        
        // NEW: Shared Confirmation Logic
        function showActionConfirm(title, callback) {
            const modal = document.getElementById('action-confirm-modal');
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-yes-btn').onclick = function() {
                modal.style.display = 'none';
                callback();
            };
            modal.style.display = 'flex';
        }


        // --- TOGGLE MODES REMOVED ---
        
        // NEW: Global Turbo Mode Toggle
        function toggleTurboMode() {
            isTurboMode = !isTurboMode;
            const btn = document.getElementById('turbo-mode-btn');
            
            if (isTurboMode) {
                btn.style.background = 'var(--danger)';
                btn.classList.add('btn-turbo-active');
                btn.innerText = 'âš¡ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙŠØ±Ø¨Ùˆ Ù…ÙØ¹Ù‘Ù„ (Ø¥Ù„ØºØ§Ø¡)';
                showConfirmation('ÙˆØ¶Ø¹ Ø§Ù„ØªÙŠØ±Ø¨Ùˆ Ù…ÙØ±ÙˆØ¶ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØºØ±Ù!');
            } else {
                btn.style.background = 'var(--success)';
                btn.classList.remove('btn-turbo-active');
                btn.innerText = 'ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙŠØ±Ø¨Ùˆ Ù„ÙƒÙ„ Ø§Ù„ØºØ±Ù - Ø§Ù„Ù…ÙˆØ§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦';
                showConfirmation('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙŠØ±Ø¨Ùˆ.');
            }
            localStorage.setItem('abella_turbo_mode', isTurboMode);
        }

        // --- CORE LOGIC ---

        function renderRooms() {
            const container = document.getElementById('rooms-container');
            
            // LIFO SORTING LOGIC: Find active rooms
            const activeRooms = workerState.rooms.filter(r => r.num !== '');

            activeRooms.sort((a, b) => b.id - a.id); // Sort by ID descending (newest first)

            // Identify the single empty input row (it must exist for input)
            let inputRoom = workerState.rooms.find(r => r.num === '');
            
            // Bug 2 Fix: Check for any active undo timer
            const isAnyUndoActive = activeRooms.some(r => r.undoTimer > 0); 

            let displayOrder = [];
            // Only show input row if NO undo is active anywhere
            if (!isAnyUndoActive && inputRoom) { 
                displayOrder.push(inputRoom); // Input row is always first
            }
            displayOrder = displayOrder.concat(activeRooms);
            
            
            // Generate HTML for all rows
            container.innerHTML = displayOrder.map((r) => {
                const isStay = r.type === 'stay';
                const guestStatusRequired = isStay && r.num && r.status === 'pending';
                
                // Determine style for sub-select based on validation
                const guestStatusStyle = guestStatusRequired && !r.guestStatus ? 'border: 2px solid var(--danger)' : '';
                
                const subSelectHTML = isStay ? `
                    <div class="sub-select-container">
                        <select class="type-select" onchange="updateRoomData(${r.id}, 'guestStatus', this.value)" ${r.status !== 'pending' ? 'disabled' : ''} style="${guestStatusStyle}">
                            <option value="" disabled ${!r.guestStatus ? 'selected' : ''}>Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø²ÙŠÙ„...</option>
                            <option value="in" ${r.guestStatus === 'in' ? 'selected' : ''}>Ø§Ù„Ù†Ø²ÙŠÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„ØºØ±ÙØ©</option>
                            <option value="out" ${r.guestStatus === 'out' ? 'selected' : ''}>Ø§Ù„Ù†Ø²ÙŠÙ„ Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬</option>
                        </select>
                    </div>
                ` : '';

                return `
                    <div class="room-row status-${getRoomStatusClass(r)}" id="row-${r.id}">
                        <div class="timer-display ${getTimerClass(r)}">
                            ${getTimerText(r)}
                            <span class="badge">${getBadgeText(r)}</span>
                        </div>
                        <div>
                            <input type="number" class="room-input" placeholder="Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©" 
                                value="${r.num}" onchange="updateRoomData(${r.id}, 'num', this.value)" 
                                ${r.status !== 'pending' ? 'disabled' : ''}>
                        </div>
                        <div>
                            <select class="type-select" onchange="updateRoomData(${r.id}, 'type', this.value)" ${r.status !== 'pending' ? 'disabled' : ''} style="border-color:${!r.type && r.num ? 'red' : '#cfd8dc'}">
                                <option value="" disabled ${!r.type ? 'selected' : ''}>Ø­Ø§Ù„Ø© Ø§Ù„ØºØ±ÙØ©...</option>
                                <option value="stay" ${r.type==='stay'?'selected':''}>ğŸ‘¤ Ø³Ø§ÙƒÙ†</option>
                                <option value="out" ${r.type==='out'?'selected':''}>ğŸšª Ø®Ø±ÙˆØ¬</option>
                            </select>
                            ${subSelectHTML}
                        </div>
                        <div id="action-cell-${r.id}">
                            ${getActionBtn(r)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateRoomData(id, field, val) {
            const r = workerState.rooms.find(x => x.id === id);
            if(r) { 
                r[field] = val; 
                
                if (field === 'type' && val !== 'stay') {
                    r.guestStatus = '';
                }
                
                saveState(); 
                renderRooms(); 
            }
        }

        function startRoom(id) {
            const r = workerState.rooms.find(x => x.id === id);
            
            if (!r.num || !r.type) {
                alert("ğŸ”´ ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ© ÙˆØ§Ø®ØªÙŠØ§Ø± Ø­Ø§Ù„ØªÙ‡Ø§");
                return;
            }
            if (r.type === 'stay' && !r.guestStatus) {
                alert("ğŸ”´ ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø²ÙŠÙ„ (Ø¯Ø§Ø®Ù„/Ø®Ø§Ø±Ø¬) Ù„ØºØ±ÙØ© Ø§Ù„Ø³Ø§ÙƒÙ†.");
                return;
            }

            // Determine if Rain Mode is ON
            if (isTurboMode) {
                commitStartRoom(id, true);
            } else {
                window.tempRoomId = id; // Store ID globally for modal callback
                document.getElementById('rain-prompt-modal').style.display = 'flex';
            }
        }

        // Commits the room start after Rain Mode selection
        function commitStartRoom(id, isRainActive) {
            document.getElementById('rain-prompt-modal').style.display = 'none';
            const r = workerState.rooms.find(x => x.id === id);
            
            // Set limits based on selection (New: +10 minutes)
            let limitMin = 35; 
            if (r.type === 'stay') limitMin = isRainActive ? 20 : 25; // 20/25 min
            if (r.type === 'out') limitMin = isRainActive ? 30 : 35; // 30/35 min
            
            r.timerLimit = limitMin * 60000;
            r.isRainActive = isRainActive; 
            r.status = 'acknowledging'; // NEW: Start Acknowledging/Travel status
            r.start = Date.now();
            r.undoTimer = 10; // 10s rollback check
            saveState(); 
            
            // FIX (Bug 2): Add the new empty row slot now that the current room is committed
            workerState.rooms = workerState.rooms.filter(room => room.num !== ''); // Remove any lingering empty slots
            workerState.rooms.push({ 
                id: Date.now(), num: '', type: '', guestStatus: '', status: 'pending', start: 0, checkStart: 0, undoTimer: 0, timerLimit: 0 
            });

            renderRooms();
            showConfirmation(`Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØºØ±ÙØ© ${r.num} (${isRainActive ? 'ØªÙŠØ±Ø¨Ùˆ' : 'Ø¹Ø§Ø¯ÙŠ'})`);
        }

        // Commits the move from Acknowledging to Cleaning
        function acknowledgeTravel(id) {
            const r = workerState.rooms.find(x => x.id === id);
            
            r.status = 'cleaning';
            r.start = Date.now(); // Reset start time to NOW for accurate cleaning countdown
            r.undoTimer = 10; // 10s rollback check for cleaning start
            
            saveState(); renderRooms();
            showConfirmation(`Ø¨Ø¯Ø¡ ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØºØ±ÙØ© ${r.num}`);
        }
        
        function checkRoom(id) {
            const r = workerState.rooms.find(x => x.id === id);
            r.status = 'checking_live'; 
            r.checkStart = Date.now();
            r.undoTimer = 10; // 10s rollback check
            saveState(); renderRooms();
            showConfirmation('Ø¨Ø¯Ø¡ Ù…Ø±Ø­Ù„Ø© Ø§Ù„ÙØ­Øµ');
        }

        function finishInspection(id) {
            const r = workerState.rooms.find(x => x.id === id);
            r.status = 'checking'; // FINAL READY STATE FOR MODAL
            r.undoTimer = 10; // 10s rollback check
            saveState(); renderRooms();
            showConfirmation('Ø§Ù„ØºØ±ÙØ© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªÙˆØ«ÙŠÙ‚');
        }

        function undo(id) {
            const r = workerState.rooms.find(x => x.id === id);
            if(r.undoTimer > 0) {
                // Rollback Logic
                if (r.status === 'checking') { 
                    r.status = 'checking_live';
                } else if (r.status === 'checking_live') { 
                    r.status = 'cleaning';
                    r.checkStart = 0;
                } else if (r.status === 'cleaning') {
                    r.status = 'acknowledging'; // Rollback to acknowledging state
                    r.start = 0; // Clear start time for cleaning
                } else if (r.status === 'acknowledging') {
                    r.status = 'pending'; // Rollback to initial pending state
                    r.start = 0;
                }
                r.undoTimer = 0;
                saveState(); renderRooms();
            }
        }

        function getActionBtn(r) {
            if (!r.num) return '';
            
            if (r.status === 'pending' && r.undoTimer <= 0) {
                 return `<button class="btn-action btn-start" onclick="showActionConfirm('Ø¨Ø¯Ø¡ ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØºØ±ÙØ© ${r.num}ØŸ', () => startRoom(${r.id}))">Ø¨Ø¯Ø¡</button>`;
            }

            if (r.status === 'acknowledging') {
                 return `<button class="btn-action btn-start" onclick="showActionConfirm('ØªÙ… Ø§Ù„Ø¹Ù„Ù… ÙˆØ¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØºØ±ÙØ© ${r.num}ØŸ', () => acknowledgeTravel(${r.id}))">ØªÙ… Ø§Ù„Ø¹Ù„Ù… ÙˆØ¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„</button>`;
            }

            if (r.status === 'cleaning') {
                return `
                    <button class="btn-action btn-check" onclick="showActionConfirm('Ø¨Ø¯Ø¡ ÙØ­Øµ Ø§Ù„ØºØ±ÙØ© ${r.num}ØŸ', () => checkRoom(${r.id}))">âœ… ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ (Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ)</button>
                    <button id="undo-btn-${r.id}" class="btn-action btn-undo" style="display:${r.undoTimer > 0 ? 'block' : 'none'}" onclick="undo(${r.id})">ØªØ±Ø§Ø¬Ø¹ (${r.undoTimer})</button>
                `;
            }
            
            if (r.status === 'checking_live') {
                return `
                    <div style="font-weight:bold; color:var(--warning); font-size:0.8rem; margin-bottom:5px;">Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ÙØ­Øµ ØªØ¬Ø±ÙŠ Ø§Ù„Ø¢Ù†</div>
                    <button class="btn-action btn-finish" onclick="showActionConfirm('Ø¥Ù†Ù‡Ø§Ø¡ ÙØ­Øµ Ø§Ù„ØºØ±ÙØ© ${r.num}ØŸ', () => finishInspection(${r.id}))">Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ÙØ­Øµ</button>
                    <button id="undo-btn-${r.id}" class="btn-action btn-undo" style="display:${r.undoTimer > 0 ? 'block' : 'none'}" onclick="undo(${r.id})">ØªØ±Ø§Ø¬Ø¹ (${r.undoTimer})</button>
                `;
            }

            if (r.status === 'checking') return `
                 <button class="btn-action btn-finish" onclick="openFinishModal(${r.id})">ØªÙˆØ«ÙŠÙ‚ ÙˆØ¥Ù†Ù‡Ø§Ø¡</button>
                 <button id="undo-btn-${r.id}" class="btn-action btn-undo" style="display:${r.undoTimer > 0 ? 'block' : 'none'}" onclick="undo(${r.id})">ØªØ±Ø§Ø¬Ø¹ (${r.undoTimer})</button>
            `;
            return 'âœ…';
        }

        // --- TICKER ---
        function tick() {
            const now = Date.now();
            let hasOverTimer = false;

            workerState.rooms.forEach(r => {
                if (r.undoTimer > 0) { 
                    r.undoTimer--; 
                    const undoBtn = document.getElementById(`undo-btn-${r.id}`);
                    if(undoBtn) {
                        undoBtn.innerText = `ØªØ±Ø§Ø¬Ø¹ (${r.undoTimer})`;
                        if (r.undoTimer === 0) renderRooms();
                    }
                }
                
                if (r.status === 'cleaning' || r.status === 'checking_live' || r.status === 'acknowledging') {
                    
                    const limit = r.timerLimit || (25*60000);
                    let timePassed;
                    let timeRemainingMs;
                    
                    if (r.status === 'acknowledging') {
                        timePassed = now - r.start;
                        timeRemainingMs = TRAVEL_TIME_MS - timePassed;
                        
                        // Fix for Bug 2: The timer logic for acknowledging
                        if (timeRemainingMs <= 0) {
                            acknowledgeTravel(r.id); // Auto-commit to cleaning
                            timeRemainingMs = 0;
                        }
                    } else {
                        const startT = r.status === 'cleaning' ? r.start : r.checkStart;
                        timePassed = now - startT;
                        timeRemainingMs = limit - timePassed;

                        if (timePassed > limit) hasOverTimer = true;
                    }
                    
                    // Audio Alert Logic (Active for both acknowledging and cleaning/checking)
                    const remainingSeconds = Math.floor(timeRemainingMs / 1000);
                    if (timeRemainingMs <= 120000 && timeRemainingMs > 0) { // Last 2 minutes
                        if (remainingSeconds % 15 === 0) {
                            playAlertSound();
                        }
                    }

                    const rowTimer = document.querySelector(`#row-${r.id} .timer-display`);
                    if(rowTimer) {
                        rowTimer.className = `timer-display ${getTimerClass(r)}`;
                        rowTimer.innerHTML = `${getTimerText(r)} <span class="badge">${getBadgeText(r)}</span>`;
                    }
                    const rowDiv = document.querySelector(`#row-${r.id}`);
                    if(rowDiv) rowDiv.className = `room-row status-${getRoomStatusClass(r)}`;
                }
            });

            const alertBar = document.getElementById('timer-alert-bar');
            if(alertBar) alertBar.style.display = hasOverTimer ? 'block' : 'none';
        }

        function getTimerText(r) {
            if (r.status === 'pending') return '--:--';
            
            const startT = r.status === 'acknowledging' ? r.start : (r.status === 'cleaning' ? r.start : r.checkStart);
            
            // Handle Acknowledging Timer (15 minutes constant travel time)
            if (r.status === 'acknowledging') {
                const diff = (r.start + TRAVEL_TIME_MS) - Date.now();
                const mins = Math.floor(Math.abs(diff) / 60000);
                const secs = Math.floor((Math.abs(diff) % 60000) / 1000);
                
                return `${mins}:${secs.toString().padStart(2,'0')}`;
            }
            
            // Handle Cleaning/Checking Timer (Performance Metric)
            const limit = r.timerLimit || (25*60000);
            const diff = limit - (Date.now() - startT);
            const mins = Math.floor(Math.abs(diff) / 60000);
            const secs = Math.floor((Math.abs(diff) % 60000) / 1000);
            return `${diff < 0 ? '+' : ''}${mins}:${secs.toString().padStart(2,'0')}`;
        }

        function getTimerClass(r) {
            if (r.status === 'pending') return '';
            if (r.status === 'acknowledging') return 'timer-active'; // Use primary color for acknowledging
            
            const startT = r.status === 'cleaning' ? r.start : r.checkStart;
            const limit = r.timerLimit || (25*60000); 
            return (Date.now() - startT > limit) ? 'timer-danger' : 'timer-active';
        }

        function getBadgeText(r) {
            if(r.status==='acknowledging') return 'Ø§Ù†ØªÙ‚Ø§Ù„';
            if(r.status==='cleaning') return 'ØªÙ†Ø¸ÙŠÙ';
            if(r.status==='checking_live') return 'ÙØ­Øµ Ù…Ø¨Ø§Ø´Ø±';
            if(r.status==='checking') return 'Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙˆØ«ÙŠÙ‚';
            return '';
        }

        function getRoomStatusClass(r) {
            if (r.status === 'acknowledging') return 'acknowledging';
            if (r.status === 'cleaning' || r.status === 'checking_live') {
                 const startT = r.status === 'cleaning' ? r.start : r.checkStart;
                 const limit = r.timerLimit || (25*60000);
                 if (Date.now() - startT > limit) return 'over';
            }
            return r.status;
        }

        // --- FINALIZATION ---
        let activeRoomId = null;
        function openFinishModal(id) {
            activeRoomId = id;
            const r = workerState.rooms.find(x => x.id === id);
            
            document.getElementById('modal-title-text').innerText = `ğŸ“ ØªÙ‚Ø±ÙŠØ± ÙØ­Øµ Ø§Ù„ØºØ±ÙØ© Ø±Ù‚Ù… ${r.num}`;
            
            document.getElementById('modal-delay').selectedIndex = 0;
            document.getElementById('modal-notes').selectedIndex = 0;
            document.getElementById('repair-details-input').value = '';
            document.getElementById('repair-status-select').selectedIndex = 0;
            document.getElementById('modal-img-camera-input').value = ""; 
            document.getElementById('modal-img-pdf-input').value = "";    
            
            // Calculate if delay reason should show
            const startT = r.status === 'cleaning' ? r.start : r.checkStart;
            const limit = r.timerLimit || (25*60000);
            const totalElapsedTime = (Date.now() - startT); 
            const isOverTime = totalElapsedTime > limit;

            const delaySection = document.getElementById('delay-reason-section');
            const delaySelect = document.getElementById('modal-delay');

            if (isOverTime) {
                delaySection.style.display = 'block';
            } else {
                delaySection.style.display = 'none';
            }
            
            updateImageRequirementUI(); 
            updateMaintenanceUI(); 

            document.getElementById('final-modal').style.display = 'flex';
        }
        function closeModal() { document.getElementById('final-modal').style.display = 'none'; }
        
        function updateMaintenanceUI() {
            const notesSelect = document.getElementById('modal-notes');
            const maintenanceFields = document.getElementById('maintenance-fields');
            const imageLabel = document.getElementById('image-label');
            const repairStatusSelect = document.getElementById('repair-status-select');
            
            const needsMaintenance = notesSelect.value === 'ØªØ­ØªØ§Ø¬ ØµÙŠØ§Ù†Ø©';
            maintenanceFields.style.display = needsMaintenance ? 'block' : 'none';
            
            if (needsMaintenance) {
                 imageLabel.innerText = 'Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© (ØµÙˆØ±Ø© Ù‚Ø¨Ù„):';
            } else {
                imageLabel.innerText = 'Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©:'; // Revert label
            }
            updateMaintenanceImageStatus();
        }

        function updateMaintenanceImageStatus() {
            const repairStatusSelect = document.getElementById('repair-status-select');
            const imageLabel = document.getElementById('image-label');
            
            if (repairStatusSelect.value === 'Completed') {
                 imageLabel.innerText = 'Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© (ØµÙˆØ±Ø© Ø¨Ø¹Ø¯):';
            } else {
                 imageLabel.innerText = 'Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© (ØµÙˆØ±Ø© Ù‚Ø¨Ù„):';
            }
        }
        
        function updateImageRequirementUI() {
            const delaySelect = document.getElementById('modal-delay');
            const imgCamera = document.getElementById('modal-img-camera-input');
            const imgPdf = document.getElementById('modal-img-pdf-input');
            
            const isMandatory = delaySelect.value === 'Ø§Ù„ØºØ±ÙØ© Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙƒØ«ÙŠØ±Ø©';
            
            if (isMandatory) {
                imgCamera.classList.add('required-field');
                imgPdf.classList.add('required-field');
            } else {
                imgCamera.classList.remove('required-field');
                imgPdf.classList.remove('required-field');
            }
        }

        function confirmFinishRoom() {
            const r = workerState.rooms.find(x => x.id === activeRoomId);
            const delay = document.getElementById('modal-delay').value;
            const notes = document.getElementById('modal-notes').value;
            const startTimeStr = new Date(r.start).toLocaleTimeString('ar-EG', {hour:'numeric', minute:'numeric'});
            
            const imgCamera = document.getElementById('modal-img-camera-input');
            const imgPdf = document.getElementById('modal-img-pdf-input');
            const hasImage = imgCamera.files.length > 0 || imgPdf.files.length > 0;
            
            // Maintenance details capture
            const needsMaintenance = notes === 'ØªØ­ØªØ§Ø¬ ØµÙŠØ§Ù†Ø©';
            let repairDetails = 'N/A';
            let repairStatus = 'N/A';

            if (needsMaintenance) {
                repairDetails = document.getElementById('repair-details-input').value.trim();
                repairStatus = document.getElementById('repair-status-select').value;
                
                if (!repairDetails) {
                    alert("ğŸ”´ Ù…Ø·Ù„ÙˆØ¨: ÙŠØ¬Ø¨ ÙˆØµÙ Ø§Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ ØµÙŠØ§Ù†Ø©.");
                    return;
                }
            }
            
            // Mandatory image check 
            if (delay === 'Ø§Ù„ØºØ±ÙØ© Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙƒØ«ÙŠØ±Ø©' && !hasImage) {
                alert("ğŸ”´ Ù…Ø·Ù„ÙˆØ¨: ÙŠØ¬Ø¨ Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± 'Ø§Ù„ØºØ±ÙØ© Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙƒØ«ÙŠØ±Ø©'.");
                return; 
            }
            
            // Final Log Entry
            const entry = {
                num: r.num,
                type: r.type === 'stay' ? 'Ø³Ø§ÙƒÙ†' : 'Ø®Ø±ÙˆØ¬',
                guestStatus: r.type === 'stay' ? r.guestStatus : 'N/A',
                cleanTime: Math.ceil((r.checkStart - r.start)/60000),
                checkTime: Math.ceil((Date.now() - r.checkStart)/60000),
                delay: delay,
                notes: notes,
                hasImage: hasImage, 
                repairDetails: repairDetails,
                repairStatus: repairStatus,
                startTimeStr: startTimeStr,
                time: new Date().toLocaleTimeString('ar-EG', {hour:'numeric', minute:'numeric'})
            };
            
            workerState.log.unshift(entry);
            if(!navigator.onLine) buffer.push(entry);
            
            workerState.rooms = workerState.rooms.filter(x => x.id !== activeRoomId);
            
            saveState(); renderRooms(); closeModal(); updateLogUI(); updateStats();
            showConfirmation('ØªÙ… Ø¥Ù†Ø¬Ø§Ø² ÙˆØªÙˆØ«ÙŠÙ‚ Ø§Ù„ØºØ±ÙØ© ' + entry.num);
            
            // WhatsApp Report Logic Modified
            let msg = `âœ… *ØªÙ‚Ø±ÙŠØ± Ù†Ø¸Ø§ÙØ© ØºØ±ÙØ© Ø±Ù‚Ù… ${entry.num}*\n`;
            msg += `ğŸ•’ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡: ${entry.startTimeStr}\n`;
            
            // Detailed Reporting
            let detailReport = '';
            if (entry.delay !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ£Ø®ÙŠØ±') {
                detailReport += `\nğŸ›‘ Ø³Ø¨Ø¨ Ø§Ù„ØªØ£Ø®ÙŠØ±: ${entry.delay}`;
            } else {
                 detailReport += `\nâœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ£Ø®ÙŠØ±`;
            }
            
            if (entry.notes === 'ØªØ­ØªØ§Ø¬ ØµÙŠØ§Ù†Ø©') {
                 detailReport += `\nğŸ› ï¸ Ø§Ù„ØµÙŠØ§Ù†Ø©: ${repairStatus}. Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${repairDetails}`;
            } else if (entry.notes !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª') {
                 detailReport += `\nğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙØ­Øµ: ${entry.notes}`;
            } else {
                 detailReport += `\nğŸ“ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙØ­Øµ`;
            }

            msg += `----------------\n`;
            msg += `ğŸ§¹ ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªÙ†Ø¸ÙŠÙ ÙÙŠ: ${entry.cleanTime}Ø¯\n`;
            msg += `ğŸ” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ÙØ­Øµ ÙÙŠ: ${entry.checkTime}Ø¯\n`;
            msg += `----------------\n`;
            msg += `${detailReport}\n`;
            
            if (hasImage) {
                msg += `\nğŸ”— *Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©:* [ØªÙ… Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø©]`;
            }
            
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // --- UTILS ---
        function updateLogUI() {
            const list = document.getElementById('worker-log-list');
            if(workerState.log.length === 0) return;
            list.innerHTML = workerState.log.map((l, index) => `
                <div style="border-bottom:1px solid #eee; padding:8px 0; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold; color:var(--primary);">${l.num} <span style="font-size:0.7rem; color:#999;">(${l.type})</span></div>
                        <div style="font-size:0.7rem; color:#666;">Ø¨Ø¯Ø£: ${l.startTimeStr}</div>
                        ${l.guestStatus === 'in' ? '<span style="font-size:0.7rem; color:var(--danger)">âš ï¸ Ù†Ø²ÙŠÙ„ Ø¯Ø§Ø®Ù„</span>' : ''}
                    </div>
                    <div style="text-align:left; font-size:0.75rem; display:flex; gap:10px;">
                        ${l.hasImage ? `<button onclick="showLogImage(${index})" style="border:none; background:none; cursor:pointer; color:var(--upgrade); padding:0;">ğŸ“¸</button>` : ''}
                        <div>
                            <div>${l.cleanTime}Ø¯ ØªÙ†Ø¸ÙŠÙ</div>
                            <div style="color:${l.delay !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ£Ø®ÙŠØ±' ? 'red' : '#999'};">${l.delay !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ£Ø®ÙŠØ±' ? 'ØªØ£Ø®ÙŠØ±!' : 'ØªÙ…'}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function showLogImage(index) {
            const logEntry = workerState.log[index];
            alert(`ğŸ“¸ ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØºØ±ÙØ© Ø±Ù‚Ù… ${logEntry.num}.`);
        }

        function updateStats() {
            const log = workerState.log;
            const totalCompleted = log.length;
            
            // Segmentation
            const countStay = log.filter(l => l.type === 'Ø³Ø§ÙƒÙ†').length;
            const countOut = totalCompleted - countStay;
            
            // Time Metrics (Clean Time + Check Time = Total Time)
            const allTotalTimes = log.map(l => l.cleanTime + l.checkTime).filter(t => t > 0);
            const cleanTimesOut = log.filter(l => l.type === 'Ø®Ø±ÙˆØ¬' && l.cleanTime > 0).map(l => l.cleanTime + l.checkTime);
            const cleanTimesStay = log.filter(l => l.type === 'Ø³Ø§ÙƒÙ†' && l.cleanTime > 0).map(l => l.cleanTime + l.checkTime);
            
            // Finding Fastest
            const fastestOut = cleanTimesOut.length > 0 ? cleanTimesOut.reduce((min, current) => Math.min(min, current)) : null;
            const fastestStay = cleanTimesStay.length > 0 ? cleanTimesStay.reduce((min, current) => Math.min(min, current)) : null;
            
            // Find rooms corresponding to fastest time
            const fastestOutRoom = log.find(l => (l.cleanTime + l.checkTime) === fastestOut && l.type === 'Ø®Ø±ÙˆØ¬');
            const fastestStayRoom = log.find(l => (l.cleanTime + l.checkTime) === fastestStay && l.type === 'Ø³Ø§ÙƒÙ†');

            const maxTimeMs = allTotalTimes.length > 0 ? Math.max(...allTotalTimes) : 0;
            const minTimeMs = allTotalTimes.length > 0 ? Math.min(...allTotalTimes) : 0;
            const totalTimeMs = allTotalTimes.reduce((sum, time) => sum + time, 0);
            const avgTimeMs = totalCompleted > 0 ? totalTimeMs / totalCompleted : 0;
            const overTimerCount = log.filter(l => l.delay !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ£Ø®ÙŠØ±').length;

            // UI Updates (Standard Stats)
            document.getElementById('stat-completed').innerText = totalCompleted;
            document.getElementById('stat-avg').innerText = formatTimeDuration(avgTimeMs);
            document.getElementById('stat-over').innerText = overTimerCount;

            // UI Updates (Detailed Segmentation)
            document.getElementById('stat-out-count').innerText = countOut;
            document.getElementById('stat-stay-count').innerText = countStay;
            
            document.getElementById('stat-max-time').innerText = maxTimeMs ? formatTimeDuration(maxTimeMs) : '--';
            document.getElementById('stat-min-time').innerText = minTimeMs ? formatTimeDuration(minTimeMs) : '--';
            
            // Fastest Room Circular Display
            if (fastestOutRoom) {
                document.getElementById('fastest-out-num').innerText = fastestOutRoom.num;
                document.getElementById('fastest-out-time').innerText = formatTimeDuration(fastestOut);
            } else {
                document.getElementById('fastest-out-num').innerText = '--';
                document.getElementById('fastest-out-time').innerText = '0Ø¯ 0Ø«';
            }
             if (fastestStayRoom) {
                document.getElementById('fastest-stay-num').innerText = fastestStayRoom.num;
                document.getElementById('fastest-stay-time').innerText = formatTimeDuration(fastestStay);
            } else {
                document.getElementById('fastest-stay-num').innerText = '--';
                document.getElementById('fastest-stay-time').innerText = '0Ø¯ 0Ø«';
            }
        }

        function formatTimeDuration(ms) {
            const totalSeconds = Math.max(0, Math.floor(ms / 1000));
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            if (minutes === 0 && seconds === 0 && ms > 0) return '<1Ø«';
            return `${minutes}Ø¯ ${seconds}Ø«`;
        }

        function toggleRainMode() {
            // This function is obsolete now that the prompt modal is used.
        }

        function saveState() { localStorage.setItem('abella_v6_fixed', JSON.stringify(workerState)); }
        function loadState() {
            const d = JSON.parse(localStorage.getItem('abella_v6_fixed'));
            if(d) { 
                workerState.log = d.log || [];
                
                if (d.rooms && d.rooms.length > 0) {
                    workerState.rooms = d.rooms.filter(r => r.status !== 'pending'); 
                }
                
                const dTurbo = localStorage.getItem('abella_turbo_mode');
                if (dTurbo) isTurboMode = (dTurbo === 'true');
                
                // Update Turbo Button State on load
                const btn = document.getElementById('turbo-mode-btn');
                if (btn) {
                    if (isTurboMode) {
                        btn.style.background = 'var(--danger)';
                        btn.classList.add('btn-turbo-active');
                        btn.innerText = 'âš¡ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙŠØ±Ø¨Ùˆ Ù…ÙØ¹Ù‘Ù„ (Ø¥Ù„ØºØ§Ø¡)';
                    } else {
                        btn.style.background = 'var(--success)';
                        btn.classList.remove('btn-turbo-active');
                        btn.innerText = 'ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙŠØ±Ø¨Ùˆ Ù„ÙƒÙ„ Ø§Ù„ØºØ±Ù - Ø§Ù„Ù…ÙˆØ§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦';
                    }
                }
                
                if (workerState.rooms.length === 0 || workerState.rooms[workerState.rooms.length-1].num !== '') {
                     workerState.rooms.push({ 
                        id: Date.now(), num: '', type: '', guestStatus: '', status: 'pending', start: 0, checkStart: 0, undoTimer: 0, limit: 0 
                    });
                }

                updateLogUI(); 
            }
        }

        function checkConn() {
            const el = document.getElementById('offline-indicator');
            el.style.display = navigator.onLine ? 'none' : 'block';
        }
        
        function generateDailyReport() {
            const total = workerState.log.length;
            const delayCount = workerState.log.filter(l => l.delay !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ£Ø®ÙŠØ±').length;
            const msg = `ğŸ“Š *ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ (ÙÙ†Ø¯Ù‚ Ø£Ø¨ÙŠÙ„Ø§)*\nğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}\n\nâœ… ØªÙ… Ø¥Ù†Ø¬Ø§Ø²: ${total} ØºØ±ÙØ©\nâš ï¸ ØºØ±Ù Ù…ØªØ£Ø®Ø±Ø©: ${delayCount}\n\n*ØªÙØ§ØµÙŠÙ„ Ø³Ø±ÙŠØ¹Ø©:*\n` + workerState.log.map(l => `${l.num}: ${l.cleanTime}Ø¯/${l.checkTime}Ø¯ (Ø¨Ø¯Ø£ ${l.startTimeStr})`).join('\n');
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }
        
        function isTimeAllowed() {
            const now = new Date();
            const hours = now.getHours();
            return hours >= 1 && hours < 24; 
        }

        function clearAllData() {
            workerState.rooms = [{ 
                id: Date.now(), num: '', type: '', guestStatus: '', status: 'pending', start: 0, checkStart: 0, undoTimer: 0, limit: 0 
            }];
            
            workerState.log = [];
            buffer = [];
            localStorage.removeItem('abella_buffer_v6'); 
            
            isTurboMode = false;
            localStorage.removeItem('abella_turbo_mode');

            saveState(); 
            renderRooms();
            updateStats();
            document.getElementById('password-modal').style.display = 'none';
            showConfirmation("âœ… ØªÙ… ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ¨Ø¯Ø¡ ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯.");
        }

        function showResetModal() {
            const isAllowed = isTimeAllowed();
            const statusMsg = document.getElementById('reset-status-msg');
            
            document.getElementById('password-modal').style.display = 'flex';
            document.getElementById('confirm-reset-btn').onclick = function() { checkPasswordAndReset('full_reset'); };
            document.getElementById('password-modal-title').innerText = 'ØªØµÙÙŠØ© Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª';

            if (isAllowed) {
                statusMsg.innerHTML = 'âš ï¸ ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ø³Ø§Ø¹Ø© 1:00 Øµ. Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„ØªØµÙÙŠØ© Ø§Ù„ÙŠÙˆÙ….';
            } else {
                statusMsg.innerHTML = 'ğŸ”’ Ù„Ù… ÙŠØ­Ù† ÙˆÙ‚Øª Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© (1:00 Øµ). Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ø²Ù…Ù†ÙŠ.';
            }
        }
        
        function showLogClearModal() {
            document.getElementById('password-modal').style.display = 'flex';
            document.getElementById('confirm-reset-btn').onclick = function() { checkPasswordAndReset('log_only'); };
            document.getElementById('password-modal-title').innerText = 'ØªØµÙÙŠØ© Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø© (ÙÙ‚Ø·)';
            document.getElementById('reset-status-msg').innerHTML = 'Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù„ØªØµÙÙŠØ© Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ.';
        }
        
        function clearLogOnly() {
            workerState.log = [];
            saveState();
            renderRooms();
            updateStats();
            updateLogUI(); // CRITICAL FIX: Ensure log UI updates immediately
            document.getElementById('password-modal').style.display = 'none';
            showConfirmation("âœ… ØªÙ… ØªØµÙÙŠØ© Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­.");
        }


        function checkPasswordAndReset(actionType = 'full_reset') {
            const passwordInput = document.getElementById('admin-password').value.trim();
            
            if (passwordInput === ADMIN_PASSWORD) {
                if (actionType === 'log_only') {
                    clearLogOnly();
                } else {
                    clearAllData();
                }
            } else {
                if (isTimeAllowed()) {
                    alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØµÙÙŠØ© Ø¥Ù„Ø§ Ø¨ÙƒÙ„Ù…Ø© Ø³Ø± ØµØ­ÙŠØ­Ø© Ø¨Ø¹Ø¯ 1:00 Øµ.");
                } else {
                    alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ø§Ù„ØªØµÙÙŠØ© Ù…Ø³Ù…ÙˆØ­Ø© ÙÙ‚Ø· Ø¨ÙƒÙ„Ù…Ø© Ø³Ø± ØµØ­ÙŠØ­Ø© Ø£Ùˆ Ø¨Ø¹Ø¯ 1:00 Øµ.");
                }
            }
            document.getElementById('admin-password').value = ''; 
        }


/* =========================
   Translation system (safe)
   ========================= */

// Utility: walk text nodes
function walkTextNodes(node, fn) {
    const walker = document.createTreeWalker(node, NodeFilter.SHOW_TEXT, null, false);
    let n;
    while (n = walker.nextNode()) {
        fn(n);
    }
}

// Load base Arabic mapping first (used to detect text nodes to replace)
let baseArabic = null;

// Fetch JSON helper
function fetchJson(path) {
    return fetch(path).then(r => {
        if(!r.ok) throw new Error('Failed to load ' + path);
        return r.json();
    });
}

// Apply translation by replacing occurrences of Arabic baseline texts with target language strings
function applyTranslation(targetData) {
    if (!baseArabic) return;
    walkTextNodes(document.body, (textNode) => {
        let txt = textNode.nodeValue;
        // For each key in baseArabic, replace exact substring occurrences
        for (const key in baseArabic) {
            const ar = baseArabic[key];
            const tgt = targetData[key];
            if (!ar || !tgt) continue;
            // Only replace when the node exactly equals the Arabic baseline or contains it as a segment
            if (txt.includes(ar)) {
                txt = txt.split(ar).join(tgt);
            }
        }
        if (textNode.nodeValue !== txt) textNode.nodeValue = txt;
    });
}

// Load a language by code (ar|en|ur|bn)
function loadLang(lang) {
    Promise.all([
        baseArabic ? Promise.resolve(baseArabic) : fetchJson('lang-ar.json').then(d => { baseArabic = d; return d; }),
        fetchJson('lang-' + lang + '.json')
    ]).then(([base, target]) => {
        // apply translation
        applyTranslation(target);
        localStorage.setItem('workerLang', lang);
        // Update dropdown label to reflect current language
        const btn = document.getElementById('langBtn');
        if (btn) {
            const labelMap = { ar: 'Ø¹Ø±Ø¨ÙŠ', en: 'English', ur: 'Ø§Ø±Ø¯Ùˆ', bn: 'à¦¬à¦¾à¦‚à¦²à¦¾' };
            btn.innerText = 'ğŸŒ ' + (labelMap[lang] || lang) + ' â–¾';
        }
    }).catch(err => {
        console.warn('Translation load failed:', err);
    });
}

// Initialize language UI
(function initLangUI() {
    // Load saved lang or default ar
    const saved = localStorage.getItem('workerLang') || 'ar';
    // Attach dropdown handlers
    const langBtn = document.getElementById('langBtn');
    const langMenu = document.getElementById('langMenu');
    if (!langBtn || !langMenu) return;

    langBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        langMenu.style.display = (langMenu.style.display === 'block') ? 'none' : 'block';
    });

    document.querySelectorAll('.langItem').forEach(item => {
        item.addEventListener('click', (ev) => {
            const newLang = item.getAttribute('data-lang');
            loadLang(newLang);
            langMenu.style.display = 'none';
        });
    });

    // Close menu on outside click
    document.addEventListener('click', (e) => {
        if (!langMenu.contains(e.target) && !langBtn.contains(e.target)) {
            langMenu.style.display = 'none';
        }
    });

    // Load initial language (after fetching base)
    loadLang(saved);
})();
    </script>
</body>
</html>
